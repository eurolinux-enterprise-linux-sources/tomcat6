--- java/org/apache/catalina/mbeans/MemoryUserDatabaseMBean.java.orig	2011-09-28 10:37:39.418973933 -0600
+++ java/org/apache/catalina/mbeans/MemoryUserDatabaseMBean.java	2011-09-28 10:45:06.563943356 -0600
@@ -180,7 +180,7 @@
             MBeanUtils.createMBean(group);
         } catch (Exception e) {
             IllegalArgumentException iae = new IllegalArgumentException
-                ("Exception creating group " + group + " MBean");
+                ("Exception creating group [" + groupname + "] MBean");
             iae.initCause(e);
             throw iae;
         }
@@ -203,7 +203,7 @@
             MBeanUtils.createMBean(role);
         } catch (Exception e) {
             IllegalArgumentException iae = new IllegalArgumentException
-                ("Exception creating role " + role + " MBean");
+                ("Exception creating role [" + rolename + "] MBean");
             iae.initCause(e);
             throw iae;
         }
@@ -228,7 +228,7 @@
             MBeanUtils.createMBean(user);
         } catch (Exception e) {
             IllegalArgumentException iae = new IllegalArgumentException
-                ("Exception creating user " + user + " MBean");
+                ("Exception creating user [" + username + "] MBean");
             iae.initCause(e);
             throw iae;
         }
@@ -256,7 +256,7 @@
             return (oname.toString());
         } catch (MalformedObjectNameException e) {
             IllegalArgumentException iae = new IllegalArgumentException
-                ("Cannot create object name for group " + group);
+                ("Cannot create object name for group [" + groupname + "]");
             iae.initCause(e);
             throw iae;
         }
@@ -283,7 +283,7 @@
             return (oname.toString());
         } catch (MalformedObjectNameException e) {
             IllegalArgumentException iae = new IllegalArgumentException
-                ("Cannot create object name for role " + role);
+                ("Cannot create object name for role [" + rolename +"]");
             iae.initCause(e);
             throw iae;
         }
@@ -310,7 +310,7 @@
             return (oname.toString());
         } catch (MalformedObjectNameException e) {
             IllegalArgumentException iae = new IllegalArgumentException
-                ("Cannot create object name for user " + user);
+                ("Cannot create object name for user [" + username +"]");
             iae.initCause(e);
             throw iae;
         }
@@ -335,7 +335,7 @@
             database.removeGroup(group);
         } catch (Exception e) {
             IllegalArgumentException iae = new IllegalArgumentException
-                ("Exception destroying group " + group + " MBean");
+                ("Exception destroying group [" + groupname + "] MBean");
             iae.initCause(e);
             throw iae;
         }
@@ -360,7 +360,7 @@
             database.removeRole(role);
         } catch (Exception e) {
             IllegalArgumentException iae = new IllegalArgumentException
-                ("Exception destroying role " + role + " MBean");
+                ("Exception destroying role [" + rolename + "] MBean");
             iae.initCause(e);
             throw iae;
         }
@@ -385,7 +385,7 @@
             database.removeUser(user);
         } catch (Exception e) {
             IllegalArgumentException iae = new IllegalArgumentException
-                ("Exception destroying user " + user + " MBean");
+                ("Exception destroying user [" + username + "] MBean");
             iae.initCause(e);
             throw iae;
         }
--- java/org/apache/catalina/users/MemoryUser.java.orig	2011-09-28 10:37:58.245972646 -0600
+++ java/org/apache/catalina/users/MemoryUser.java	2011-09-28 10:51:26.674917366 -0600
@@ -246,7 +246,7 @@
      * <code>username</code> or </code>name</code> for the username
      * property.</p>
      */
-    public String toString() {
+    public String toXml() {
 
         StringBuffer sb = new StringBuffer("<user username=\"");
         sb.append(RequestUtil.filter(username));
@@ -292,6 +292,53 @@
         return (sb.toString());
 
     }
+     /**
+     * <p>Return a String representation of this user.</p>
+	  * 
+     */
+	  @Override
+    public String toString() {
+
+        StringBuffer sb = new StringBuffer("user username=\"");
+        sb.append(RequestUtil.filter(username));
+		  sb.append("\"");
+        if (fullName != null) {
+            sb.append(" fullName=\"");
+            sb.append(RequestUtil.filter(fullName));
+            sb.append("\"");
+        }
+        synchronized (groups) {
+            if (groups.size() > 0) {
+                sb.append(" groups=\"");
+                int n = 0;
+                Iterator values = groups.iterator();
+                while (values.hasNext()) {
+                    if (n > 0) {
+                        sb.append(',');
+                    }
+                    n++;
+                    sb.append(RequestUtil.filter(((Group) values.next()).getGroupname()));
+                }
+                sb.append("\"");
+            }
+        }
+        synchronized (roles) {
+            if (roles.size() > 0) {
+                sb.append(" roles=\"");
+                int n = 0;
+                Iterator values = roles.iterator();
+                while (values.hasNext()) {
+                    if (n > 0) {
+                        sb.append(',');
+                    }
+                    n++;
+                    sb.append(RequestUtil.filter(((Role) values.next()).getRolename()));
+                }
+                sb.append("\"");
+            }
+        }
+        return (sb.toString());
 
+    }
 
 }
--- java/org/apache/catalina/users/MemoryUserDatabase.java.orig	2011-09-28 10:38:13.072971632 -0600
+++ java/org/apache/catalina/users/MemoryUserDatabase.java	2011-09-28 10:53:52.939907373 -0600
@@ -549,7 +549,7 @@
             values = getUsers();
             while (values.hasNext()) {
                 writer.print("  ");
-                writer.println(values.next());
+                writer.println(((MemoryUser)values.next()).toXml());
             }
 
             // Print the file epilog
--- webapps/docs/changelog.xml.orig	2011-09-28 10:38:24.725970835 -0600
+++ webapps/docs/changelog.xml	2011-09-28 10:57:23.671892953 -0600
@@ -34,6 +34,11 @@
 
 <body>
 <section name="Tomcat 6.0.24 (jfclere)">
+  <subsection name="Catalina">
+     Fix CVE-2011-2204. Prevent user passwords appearing in log files if a
+	  runtime exception (e.g. OOME) occurs while creating a new user for a
+	  MemoryUserDataBase via JMX (markt)
+  </subsection>
   <subsection name="Coyote" >
   	<changelog>
 	  <fix>

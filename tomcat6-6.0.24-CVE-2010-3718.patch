--- java/org/apache/catalina/core/StandardContext.java.orig	2011-03-17 09:01:02.895103630 -0600
+++ java/org/apache/catalina/core/StandardContext.java	2011-03-17 09:08:47.851102615 -0600
@@ -5146,10 +5146,12 @@
         dir.mkdirs();
 
         // Set the appropriate servlet context attribute
-        getServletContext().setAttribute(Globals.WORK_DIR_ATTR, dir);
-        if (getServletContext() instanceof ApplicationContext)
-            ((ApplicationContext) getServletContext()).setAttributeReadOnly
-                (Globals.WORK_DIR_ATTR);
+        // Fix for CVE-2010-3718
+        if (context == null) {
+           getServletContext();
+        }
+        context.setAttribute(Globals.WORK_DIR_ATTR, dir);
+        context.setAttributeReadOnly(Globals.WORK_DIR_ATTR);
 
     }
 

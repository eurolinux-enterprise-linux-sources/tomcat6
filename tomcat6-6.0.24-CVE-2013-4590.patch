--- java/org/apache/catalina/Context.java.orig	2014-07-15 15:26:23.916385000 -0400
+++ java/org/apache/catalina/Context.java	2014-07-17 17:50:17.012403000 -0400
@@ -50,7 +50,7 @@
  * <p>
  *
  * @author Craig R. McClanahan
- * @version $Revision: 784615 $ $Date: 2009-06-14 22:39:30 +0200 (Sun, 14 Jun 2009) $
+ * @version $Id: Context.java 1558828 2014-01-16 15:12:59Z markt $
  */
 
 public interface Context extends Container {
@@ -65,6 +65,11 @@
     public static final String RELOAD_EVENT = "reload";
 
 
+    /**
+     * Container event for changing the ID of a session.
+     */
+    public static final String CHANGE_SESSION_ID_EVENT = "changeSessionId";
+
     // ------------------------------------------------------------- Properties
 
 
@@ -181,6 +186,26 @@
      */
     public void setCookies(boolean cookies);
 
+    
+    /**
+     * Gets the name to use for session cookies. Overrides any setting that
+     * may be specified by the application.
+     * 
+     * @return  The value of the default session cookie name or null if not
+     *          specified
+     */
+    public String getSessionCookieName();
+    
+    
+    /**
+     * Sets the name to use for session cookies. Overrides any setting that
+     * may be specified by the application.
+     * 
+     * @param sessionCookieName   The name to use
+     */
+    public void setSessionCookieName(String sessionCookieName);
+
+    
     /**
      * Gets the value of the use HttpOnly cookies for session cookies flag.
      * 
@@ -198,12 +223,50 @@
      */
     public void setUseHttpOnly(boolean useHttpOnly);
     
+    
+    /**
+     * Gets the domain to use for session cookies. Overrides any setting that
+     * may be specified by the application.
+     * 
+     * @return  The value of the default session cookie domain or null if not
+     *          specified
+     */
+    public String getSessionCookieDomain();
+    
+    
+    /**
+     * Sets the domain to use for session cookies. Overrides any setting that
+     * may be specified by the application.
+     * 
+     * @param sessionCookieDomain   The domain to use
+     */
+    public void setSessionCookieDomain(String sessionCookieDomain);
+
+    
+    /**
+     * Gets the path to use for session cookies. Overrides any setting that
+     * may be specified by the application.
+     * 
+     * @return  The value of the default session cookie path or null if not
+     *          specified
+     */
+    public String getSessionCookiePath();
+    
+    
+    /**
+     * Sets the path to use for session cookies. Overrides any setting that
+     * may be specified by the application.
+     * 
+     * @param sessionCookiePath   The path to use
+     */
+    public void setSessionCookiePath(String sessionCookiePath);
+
+    
     /**
      * Return the "allow crossing servlet contexts" flag.
      */
     public boolean getCrossContext();
 
-
     
     /**
      * Return the alternate Deployment Descriptor name.
@@ -267,6 +330,35 @@
      * @param docBase The new document root
      */
     public void setDocBase(String docBase);
+    
+    
+    /**
+     * Is URL rewriting disabled?
+     * URL rewriting is an optional component of the servlet 2.5 specification.
+     * However if set to true this will be non-compliant with the specification
+     * as the specification requires that there <b>must</b> be a way to retain
+     * sessions if the client doesn't allow session cookies.
+     * 
+     * @return true If URL rewriting is disabled.
+     * 
+     * @see <a href="http://jcp.org/aboutJava/communityprocess/mrel/jsr154/index2.html">Servlet
+     *      2.5 Specification. Sections SRV.7.1.3 and SRV.7.1.4</a>
+     * @see javax.servlet.http.HttpServletResponse#encodeURL(String) encodeURL
+     * @see javax.servlet.http.HttpServletResponse#encodeRedirectURL(String)
+     *      encodeRedirectURL
+     */
+    public boolean isDisableURLRewriting();
+    
+    /**
+     * Is URL rewriting disabled?
+     * URL rewriting is an optional component of the servlet 2.5 specification.
+     * However if set to true this will be non-compliant with the specification
+     * as the specification requires that there <b>must</b> be a way to retain
+     * sessions if the client doesn't allow session cookies.
+     *
+     * @param disable True to disable URL Rewriting. Default <b>false</b>.
+     */
+    public void setDisableURLRewriting(boolean disable);
 
 
     /**
@@ -450,6 +542,101 @@
     public void setWrapperClass(String wrapperClass);
 
 
+    /**
+     * Will the parsing of the web.xml file for this Context be performed by a
+     * namespace aware parser?
+     *
+     * @return true if namespace awareness is enabled.
+     */
+    public boolean getXmlNamespaceAware();
+
+
+    /**
+     * Controls whether the parsing of the web.xml file for this Context will be
+     * performed by a namespace aware parser.
+     *
+     * @param xmlNamespaceAware true to enable namespace awareness
+     */
+    public void setXmlNamespaceAware(boolean xmlNamespaceAware);
+     
+
+    /**
+     * Will the parsing of the web.xml file for this Context be performed by a
+     * validating parser?
+     *
+     * @return true if validation is enabled.
+     */
+    public boolean getXmlValidation();
+
+
+    /**
+     * Controls whether the parsing of the web.xml file for this Context will be
+     * performed by a validating parser.
+     *
+     * @param xmlValidation true to enable xml validation
+     */
+    public void setXmlValidation(boolean xmlValidation);
+
+
+    /**
+     * *.tld files are always parsed using a namespace aware parser.
+     *
+     * @return Always <code>true</code>
+     * 
+     * @deprecated This option will be removed in 8.0.x.
+     */
+    @Deprecated
+    public boolean getTldNamespaceAware();
+
+
+    /**
+     * *.tld files are always parsed using a namespace aware parser.
+     *
+     * @param tldNamespaceAware ignored
+     * 
+     * @deprecated This option will be removed in 8.0.x.
+     */
+    @Deprecated
+    public void setTldNamespaceAware(boolean tldNamespaceAware);
+
+
+    /**
+     * Will the parsing of web.xml, web-fragment.xml, *.tld, *.jspx, *.tagx and
+     * tagplugin.xml files for this Context block the use of external entities?
+     *
+     * @return true if access to external entities is blocked
+     */
+    public boolean getXmlBlockExternal();
+
+
+    /**
+     * Controls whether the parsing of web.xml, web-fragment.xml, *.tld, *.jspx,
+     * *.tagx and tagplugin.xml files for this Context will block the use of
+     * external entities.
+     *
+     * @param xmlBlockExternal true to block external entities
+     */
+    public void setXmlBlockExternal(boolean xmlBlockExternal);
+
+
+    /**
+     * Will the parsing of *.tld files for this Context be performed by a
+     * validating parser?
+     *
+     * @return true if validation is enabled.
+     */
+    public boolean getTldValidation();
+
+
+    /**
+     * Controls whether the parsing of *.tld files for this Context will be
+     * performed by a validating parser.
+     *
+     * @param tldValidation true to enable xml validation
+     */
+    public void setTldValidation(boolean tldValidation);
+
+
     // --------------------------------------------------------- Public Methods
 
 
@@ -1005,74 +1192,5 @@
      * @param listener Class name of a ContainerListener class to be removed
      */
     public void removeWrapperListener(String listener);
-
-
-    /**
-     * Get the server.xml <context> attribute's xmlNamespaceAware.
-     * @return true if namespace awarenes is enabled.
-     *
-     */
-    public boolean getXmlNamespaceAware();
-
-
-    /**
-     * Get the server.xml <context> attribute's xmlValidation.
-     * @return true if validation is enabled.
-     *
-     */
-    public boolean getXmlValidation();
-
-
-    /**
-     * Set the validation feature of the XML parser used when
-     * parsing xml instances.
-     * @param xmlValidation true to enable xml instance validation
-     */
-    public void setXmlValidation(boolean xmlValidation);
-
-
-   /**
-     * Set the namespace aware feature of the XML parser used when
-     * parsing xml instances.
-     * @param xmlNamespaceAware true to enable namespace awareness
-     */
-    public void setXmlNamespaceAware(boolean xmlNamespaceAware);
-    /**
-     * Get the server.xml <context> attribute's xmlValidation.
-     * @return true if validation is enabled.
-     */
-     
-
-    /**
-     * Set the validation feature of the XML parser used when
-     * parsing tlds files. 
-     * @param tldValidation true to enable xml instance validation
-     */
-    public void setTldValidation(boolean tldValidation);
-
-
-    /**
-     * Get the server.xml <context> attribute's webXmlValidation.
-     * @return true if validation is enabled.
-     *
-     */
-    public boolean getTldValidation();
-
-
-    /**
-     * Get the server.xml &lt;host&gt; attribute's xmlNamespaceAware.
-     * @return true if namespace awarenes is enabled.
-     */
-    public boolean getTldNamespaceAware();
-
-
-    /**
-     * Set the namespace aware feature of the XML parser used when
-     * parsing xml instances.
-     * @param tldNamespaceAware true to enable namespace awareness
-     */
-    public void setTldNamespaceAware(boolean tldNamespaceAware);
-
-
 }
 
--- java/org/apache/catalina/Globals.java.orig	2014-07-15 15:26:23.922394000 -0400
+++ java/org/apache/catalina/Globals.java	2014-07-17 17:50:17.018406000 -0400
@@ -23,7 +23,7 @@
  * Global constants that are applicable to multiple packages within Catalina.
  *
  * @author Craig R. McClanahan
- * @version $Revision: 708201 $ $Date: 2008-10-27 15:38:32 +0100 (Mon, 27 Oct 2008) $
+ * @version $Id: Globals.java 1558828 2014-01-16 15:12:59Z markt $
  */
 
 public final class Globals {
@@ -327,6 +327,17 @@
 
 
     /**
+     * The request attribute that is set to <code>Boolean.TRUE</code> if some request
+     * parameters have been ignored during request parameters parsing. It can
+     * happen, for example, if there is a limit on the total count of parseable
+     * parameters, or if parameter cannot be decoded, or any other error
+     * happened during parameter parsing.
+     */
+    public static final String PARAMETER_PARSE_FAILED_ATTR =
+        "org.apache.catalina.parameter_parse_failed";
+
+
+    /**
      * The master flag which controls strict servlet specification 
      * compliance.
      */
@@ -341,4 +352,23 @@
         (System.getSecurityManager() != null);
 
 
+    /**
+     * Name of the ServletContext init-param that determines if the JSP engine
+     * should validate *.tld files when parsing them.
+     * <p>
+     * This must be kept in sync with org.apache.jasper.Constants
+     */
+    public static final String JASPER_XML_VALIDATION_TLD_INIT_PARAM =
+            "org.apache.jasper.XML_VALIDATE_TLD";
+
+
+    /**
+     * Name of the ServletContext init-param that determines if the JSP engine
+     * will block external entities from being used in *.tld, *.jspx, *.tagx and
+     * tagplugin.xml files.
+     * <p>
+     * This must be kept in sync with org.apache.jasper.Constants
+     */
+    public static final String JASPER_XML_BLOCK_EXTERNAL_INIT_PARAM =
+            "org.apache.jasper.XML_BLOCK_EXTERNAL";
 }
--- java/org/apache/catalina/ant/ValidatorTask.java.orig	2014-07-15 15:26:23.930383000 -0400
+++ java/org/apache/catalina/ant/ValidatorTask.java	2014-07-17 17:50:17.026403000 -0400
@@ -5,9 +5,9 @@
  * The ASF licenses this file to You under the Apache License, Version 2.0
  * (the "License"); you may not use this file except in compliance with
  * the License.  You may obtain a copy of the License at
- * 
+ *
  *      http://www.apache.org/licenses/LICENSE-2.0
- * 
+ *
  * Unless required by applicable law or agreed to in writing, software
  * distributed under the License is distributed on an "AS IS" BASIS,
  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
@@ -24,19 +24,20 @@
 import java.io.FileInputStream;
 import java.io.InputStream;
 
+import org.apache.catalina.Globals;
 import org.apache.catalina.startup.Constants;
-import org.apache.catalina.startup.DigesterFactory;
+import org.apache.tomcat.util.descriptor.DigesterFactory;
 import org.apache.tomcat.util.digester.Digester;
 import org.apache.tools.ant.BuildException;
 import org.xml.sax.InputSource;
 
 
 /**
- * Task for validating a web application deployment descriptor, using XML 
+ * Task for validating a web application deployment descriptor, using XML
  * schema validation.
  *
  * @author Remy Maucherat
- * @version $Revision: 467222 $ $Date: 2006-10-24 05:17:11 +0200 (Tue, 24 Oct 2006) $
+ * @version $Id: ValidatorTask.java 1558828 2014-01-16 15:12:59Z markt $
  * @since 5.0
  */
 
@@ -89,10 +90,13 @@
         Thread.currentThread().setContextClassLoader
             (ValidatorTask.class.getClassLoader());
 
-        Digester digester = DigesterFactory.newDigester(true, true, null);
+        // Called through trusted manager interface. If running under a
+        // SecurityManager assume that untrusted applications may be deployed.
+        Digester digester = DigesterFactory.newDigester(
+                true, true, null, Globals.IS_SECURITY_ENABLED);
         try {
             file = file.getCanonicalFile();
-            InputStream stream = 
+            InputStream stream =
                 new BufferedInputStream(new FileInputStream(file));
             InputSource is = new InputSource(file.toURL().toExternalForm());
             is.setByteStream(stream);
--- java/org/apache/catalina/core/ApplicationContext.java.orig	2014-07-15 15:26:23.941384000 -0400
+++ java/org/apache/catalina/core/ApplicationContext.java	2014-07-17 17:50:17.034404000 -0400
@@ -5,9 +5,9 @@
  * The ASF licenses this file to You under the Apache License, Version 2.0
  * (the "License"); you may not use this file except in compliance with
  * the License.  You may obtain a copy of the License at
- * 
+ *
  *      http://www.apache.org/licenses/LICENSE-2.0
- * 
+ *
  * Unless required by applicable law or agreed to in writing, software
  * distributed under the License is distributed on an "AS IS" BASIS,
  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
@@ -24,7 +24,9 @@
 import java.net.MalformedURLException;
 import java.net.URL;
 import java.util.ArrayList;
+import java.util.Collections;
 import java.util.Enumeration;
+import java.util.HashSet;
 import java.util.Iterator;
 import java.util.Map;
 import java.util.Set;
@@ -42,7 +44,6 @@
 import org.apache.catalina.Context;
 import org.apache.catalina.Host;
 import org.apache.catalina.Wrapper;
-import org.apache.catalina.deploy.ApplicationParameter;
 import org.apache.catalina.util.Enumerator;
 import org.apache.catalina.util.RequestUtil;
 import org.apache.catalina.util.ResourceSet;
@@ -63,7 +64,7 @@
  *
  * @author Craig R. McClanahan
  * @author Remy Maucherat
- * @version $Revision: 739532 $ $Date: 2009-01-31 10:52:13 +0100 (Sat, 31 Jan 2009) $
+ * @version $Id: ApplicationContext.java 1558828 2014-01-16 15:12:59Z markt $
  */
 
 public class ApplicationContext
@@ -122,7 +123,8 @@
     /**
      * The merged context initialization parameters for this Context.
      */
-    private Map parameters = null;
+    private Map<String,String> parameters =
+        new ConcurrentHashMap<String,String>();
 
 
     /**
@@ -235,14 +237,14 @@
         }
     }
 
-    
+
     /**
      * Return the main path associated with this context.
      */
     public String getContextPath() {
         return context.getPath();
     }
-    
+
 
     /**
      * Return the value of the specified initialization parameter, or
@@ -251,10 +253,31 @@
      * @param name Name of the initialization parameter to retrieve
      */
     public String getInitParameter(final String name) {
+        // Special handling for XML settings as the context setting must
+        // always override anything that might have been set by an application.
+        if (Globals.JASPER_XML_VALIDATION_TLD_INIT_PARAM.equals(name) &&
+                context.getTldValidation()) {
+            return "true";
+        }
+        if (Globals.JASPER_XML_BLOCK_EXTERNAL_INIT_PARAM.equals(name)) {
+            if (context.getXmlBlockExternal()) {
+                return "true";
+            } else if (Globals.IS_SECURITY_ENABLED) {
+                // System admin has explicitly changed the default
+                return "false";
+            }
+        }
+        return parameters.get(name);
+    }
 
-        mergeParameters();
-        return ((String) parameters.get(name));
 
+    public boolean setInitParameter(String name, String value) {
+        if (parameters.containsKey(name)) {
+            return false;
+        }
+
+        parameters.put(name, value);
+        return true;
     }
 
 
@@ -262,11 +285,18 @@
      * Return the names of the context's initialization parameters, or an
      * empty enumeration if the context has no initialization parameters.
      */
-    public Enumeration getInitParameterNames() {
-
-        mergeParameters();
-        return (new Enumerator(parameters.keySet()));
-
+    public Enumeration<String> getInitParameterNames() {
+        Set<String> names = new HashSet<String>();
+        names.addAll(parameters.keySet());
+        // Special handling for XML settings as these attributes will always be
+        // available if they have been set on the context
+        if (context.getTldValidation()) {
+            names.add(Globals.JASPER_XML_VALIDATION_TLD_INIT_PARAM);
+        }
+        if (context.getXmlBlockExternal() || Globals.IS_SECURITY_ENABLED) {
+            names.add(Globals.JASPER_XML_BLOCK_EXTERNAL_INIT_PARAM);
+        }
+        return Collections.enumeration(names);
     }
 
 
@@ -327,7 +357,7 @@
         Wrapper wrapper = (Wrapper) context.findChild(name);
         if (wrapper == null)
             return (null);
-        
+
         return new ApplicationDispatcher(wrapper, null, null, null, null, name);
 
     }
@@ -383,7 +413,7 @@
         if (path == null)
             return (null);
 
-        pos = path.length(); 
+        pos = path.length();
 
         // Use the thread local URI and mapping data
         DispatchData dd = dispatchData.get();
@@ -434,10 +464,10 @@
         String pathInfo = mappingData.pathInfo.toString();
 
         mappingData.recycle();
-        
+
         // Construct a RequestDispatcher to process this request
         return new ApplicationDispatcher
-            (wrapper, uriCC.toString(), wrapperPath, pathInfo, 
+            (wrapper, uriCC.toString(), wrapperPath, pathInfo,
              queryString, null);
 
     }
@@ -463,7 +493,7 @@
         if (!path.startsWith("/") && Globals.STRICT_SERVLET_COMPLIANCE)
             throw new MalformedURLException(sm.getString("applicationContext.requestDispatcher.iae", path));
 
-        
+
         path = RequestUtil.normalize(path);
         if (path == null)
             return (null);
@@ -492,8 +522,12 @@
                     return new URL
                         ("jndi", "", 0, getJNDIUri(hostName, fullPath),
                          new DirContextURLStreamHandler(resources));
-                } catch (Exception e) {
+                } catch (NamingException e) {
                     // Ignore
+                } catch (Exception e) {
+                    // Unexpected
+                    log(sm.getString("applicationContext.lookup.error", path,
+                            getContextPath()), e);
                 }
             }
         }
@@ -529,7 +563,12 @@
                 Object resource = resources.lookup(path);
                 if (resource instanceof Resource)
                     return (((Resource) resource).streamContent());
+            } catch (NamingException e) {
+                // Ignore
             } catch (Exception e) {
+                // Unexpected
+                log(sm.getString("applicationContext.lookup.error", path,
+                        getContextPath()), e);
             }
         }
         return (null);
@@ -656,7 +695,7 @@
      *  <code>log(String, Throwable)</code> instead
      */
     public void log(Exception exception, String message) {
-        
+
         context.getLogger().error(message, exception);
 
     }
@@ -669,7 +708,7 @@
      * @param throwable Exception to be reported
      */
     public void log(String message, Throwable throwable) {
-        
+
         context.getLogger().error(message, throwable);
 
     }
@@ -810,7 +849,7 @@
     protected StandardContext getContext() {
         return this.context;
     }
-    
+
     protected Map getReadonlyAttributes() {
         return this.readOnlyAttributes;
     }
@@ -833,10 +872,10 @@
             String key = (String) keys.next();
             removeAttribute(key);
         }
-        
+
     }
-    
-    
+
+
     /**
      * Return the facade associated with this ApplicationContext.
      */
@@ -858,38 +897,6 @@
     }
 
 
-    // -------------------------------------------------------- Private Methods
-
-
-    /**
-     * Merge the context initialization parameters specified in the application
-     * deployment descriptor with the application parameters described in the
-     * server configuration, respecting the <code>override</code> property of
-     * the application parameters appropriately.
-     */
-    private void mergeParameters() {
-
-        if (parameters != null)
-            return;
-        Map results = new ConcurrentHashMap();
-        String names[] = context.findParameters();
-        for (int i = 0; i < names.length; i++)
-            results.put(names[i], context.findParameter(names[i]));
-        ApplicationParameter params[] =
-            context.findApplicationParameters();
-        for (int i = 0; i < params.length; i++) {
-            if (params[i].getOverride()) {
-                if (results.get(params[i].getName()) == null)
-                    results.put(params[i].getName(), params[i].getValue());
-            } else {
-                results.put(params[i].getName(), params[i].getValue());
-            }
-        }
-        parameters = results;
-
-    }
-
-
     /**
      * List resource paths (recursively), and store all of them in the given
      * Set.
--- java/org/apache/catalina/core/StandardContext.java.orig	2014-07-15 15:26:23.951383000 -0400
+++ java/org/apache/catalina/core/StandardContext.java	2014-07-17 17:50:17.042408000 -0400
@@ -5,9 +5,9 @@
  * The ASF licenses this file to You under the Apache License, Version 2.0
  * (the "License"); you may not use this file except in compliance with
  * the License.  You may obtain a copy of the License at
- * 
+ *
  *      http://www.apache.org/licenses/LICENSE-2.0
- * 
+ *
  * Unless required by applicable law or agreed to in writing, software
  * distributed under the License is distributed on an "AS IS" BASIS,
  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
@@ -31,6 +31,7 @@
 import java.util.HashMap;
 import java.util.Hashtable;
 import java.util.Iterator;
+import java.util.Map;
 import java.util.Stack;
 import java.util.TreeMap;
 
@@ -100,6 +101,7 @@
 import org.apache.naming.resources.FileDirContext;
 import org.apache.naming.resources.ProxyDirContext;
 import org.apache.naming.resources.WARDirContext;
+import org.apache.tomcat.util.descriptor.XmlIdentifiers;
 import org.apache.tomcat.util.modeler.Registry;
 
 /**
@@ -109,7 +111,7 @@
  *
  * @author Craig R. McClanahan
  * @author Remy Maucherat
- * @version $Revision: 893564 $ $Date: 2009-12-23 17:31:31 +0100 (Wed, 23 Dec 2009) $
+ * @version $Id: StandardContext.java 1561795 2014-01-27 19:03:54Z markt $
  */
 
 public class StandardContext
@@ -190,33 +192,33 @@
      */
     private boolean antiJARLocking = false;
 
-    
+
     /**
      * The antiResourceLocking flag for this Context.
      */
     private boolean antiResourceLocking = false;
 
-    
+
     /**
      * The set of application listener class names configured for this
      * application, in the order they were encountered in the web.xml file.
      */
     private String applicationListeners[] = new String[0];
-    
+
     private final Object applicationListenersLock = new Object();
 
 
     /**
      * The set of instantiated application event listener objects</code>.
      */
-    private transient Object applicationEventListenersObjects[] = 
+    private transient Object applicationEventListenersObjects[] =
         new Object[0];
 
 
     /**
      * The set of instantiated application lifecycle listener objects</code>.
      */
-    private transient Object applicationLifecycleListenersObjects[] = 
+    private transient Object applicationLifecycleListenersObjects[] =
         new Object[0];
 
 
@@ -227,18 +229,18 @@
         new ApplicationParameter[0];
 
     private final Object applicationParametersLock = new Object();
-    
+
 
     /**
      * The application available flag for this Context.
      */
     private boolean available = false;
-    
+
     /**
-     * The broadcaster that sends j2ee notifications. 
+     * The broadcaster that sends j2ee notifications.
      */
     private NotificationBroadcasterSupport broadcaster = null;
-    
+
     /**
      * The Locale to character set mapper for this application.
      */
@@ -268,7 +270,7 @@
      * The security constraints for this web application.
      */
     private SecurityConstraint constraints[] = new SecurityConstraint[0];
-    
+
     private final Object constraintsLock = new Object();
 
 
@@ -296,12 +298,12 @@
      */
     private boolean crossContext = false;
 
-    
+
     /**
      * Encoded path.
      */
     private String encodedPath = null;
-    
+
 
     /**
      * The "follow standard delegation model" flag that will be used to
@@ -316,13 +318,13 @@
     private String displayName = null;
 
 
-    /** 
+    /**
      * Override the default context xml location.
      */
     private String defaultContextXml;
 
 
-    /** 
+    /**
      * Override the default web xml location.
      */
     private String defaultWebXml;
@@ -341,6 +343,12 @@
 
 
     /**
+     * Has URL rewriting been disabled.
+     */
+    private boolean disableURLRewriting = false;
+
+
+    /**
      * The exception pages for this web application, keyed by fully qualified
      * class name of the Java exception.
      */
@@ -366,7 +374,7 @@
      * they were defined in the deployment descriptor.
      */
     private FilterMap filterMaps[] = new FilterMap[0];
-    
+
     private final Object filterMapsLock = new Object();
 
 
@@ -394,7 +402,7 @@
     /**
      * The mapper associated with this context.
      */
-    private org.apache.tomcat.util.http.mapper.Mapper mapper = 
+    private org.apache.tomcat.util.http.mapper.Mapper mapper =
         new org.apache.tomcat.util.http.mapper.Mapper();
 
 
@@ -471,8 +479,8 @@
      * The original document root for this web application.
      */
     private String originalDocBase = null;
-    
-    
+
+
     /**
      * The privileged flag for this web application.
      */
@@ -509,7 +517,7 @@
      * matching pattern.
      */
     private HashMap servletMappings = new HashMap();
-    
+
     private final Object servletMappingsLock = new Object();
 
 
@@ -522,7 +530,7 @@
      * The notification sequence number.
      */
     private long sequenceNumber = 0;
-    
+
     /**
      * The status code error pages for this web application, keyed by
      * HTTP status code (as an Integer).
@@ -639,6 +647,13 @@
     protected int cacheMaxSize = 10240; // 10 MB
 
 
+
+    /**
+     * Attribute used to turn on/off the use of external entities.
+     */
+    private boolean xmlBlockExternal = Globals.IS_SECURITY_ENABLED;
+
+
     /**
      * Cache object max size in KB.
      */
@@ -662,9 +677,9 @@
     private long startTime;
     private long tldScanTime;
 
-    /** 
+    /**
      * Name of the engine. If null, the domain is used.
-     */ 
+     */
     private String engineName = null;
     private String j2EEApplication="none";
     private String j2EEServer="none";
@@ -673,13 +688,13 @@
     /**
      * Attribute value used to turn on/off XML validation
      */
-     private boolean webXmlValidation = false;
+     private boolean webXmlValidation = Globals.STRICT_SERVLET_COMPLIANCE;
 
 
     /**
      * Attribute value used to turn on/off XML namespace validation
      */
-     private boolean webXmlNamespaceAware = false;
+     private boolean webXmlNamespaceAware = Globals.STRICT_SERVLET_COMPLIANCE;
 
     /**
      * Attribute value used to turn on/off TLD processing
@@ -689,13 +704,7 @@
     /**
      * Attribute value used to turn on/off XML validation
      */
-     private boolean tldValidation = false;
-
-
-    /**
-     * Attribute value used to turn on/off TLD XML namespace validation
-     */
-     private boolean tldNamespaceAware = false;
+     private boolean tldValidation = Globals.STRICT_SERVLET_COMPLIANCE;
 
 
     /**
@@ -703,11 +712,34 @@
      */
     private boolean saveConfig = true;
 
+
     /**
      * The flag that indicates that session cookies should use HttpOnly
      */
     private boolean useHttpOnly = false;
 
+
+    /**
+     * The domain to use for session cookies. <code>null</code> indicates that
+     * the domain is controlled by the application.
+     */
+    private String sessionCookieDomain;
+
+
+    /**
+     * The path to use for session cookies. <code>null</code> indicates that
+     * the path is controlled by the application.
+     */
+    private String sessionCookiePath;
+
+
+    /**
+     * The name to use for session cookies. <code>null</code> indicates that
+     * the name is controlled by the application.
+     */
+    private String sessionCookieName;
+
+
     /**
      * Should Tomcat attempt to terminate threads that have been started by the
      * web application? Stopping threads is performed via the deprecated (for
@@ -715,10 +747,38 @@
      * instability. As such, enabling this should be viewed as an option of last
      * resort in a development environment and is not recommended in a
      * production environment. If not specified, the default value of
-     * <code>false</code> will be used. 
+     * <code>false</code> will be used.
      */
     private boolean clearReferencesStopThreads = false;
 
+    /**
+     * Should Tomcat attempt to terminate any {@link java.util.TimerThread}s
+     * that have been started by the web application? If not specified, the
+     * default value of <code>false</code> will be used.
+     */
+    private boolean clearReferencesStopTimerThreads = false;
+
+    /**
+     * If an HttpClient keep-alive timer thread has been started by this web
+     * application and is still running, should Tomcat change the context class
+     * loader from the current
+     * {@link org.apache.catalina.loader.WebappClassLoader} to
+     * {@link org.apache.catalina.loader.WebappClassLoader#parent} to prevent a
+     * memory leak? Note that the keep-alive timer thread will stop on its own
+     * once the keep-alives all expire however, on a busy system that might not
+     * happen for some time.
+     */
+    private boolean clearReferencesHttpClientKeepAliveThread = true;
+
+    /**
+     * Should Tomcat attempt to clear any ThreadLocal objects that are instances
+     * of classes loaded by this class loader. Failure to remove any such
+     * objects will result in a memory leak on web application stop, undeploy or
+     * reload. It is disabled by default since the clearing of the ThreadLocal
+     * objects is not performed in a thread-safe manner.
+     */
+    private boolean clearReferencesThreadLocals = false;
+
     // ----------------------------------------------------- Context Properties
 
 
@@ -731,7 +791,7 @@
        this.annotationProcessor = annotationProcessor;
     }
 
-    
+
     public String getEncodedPath() {
         return encodedPath;
     }
@@ -1133,10 +1193,10 @@
                                    this.cookies);
 
     }
-    
+
     /**
      * Gets the value of the use HttpOnly cookies for session cookies flag.
-     * 
+     *
      * @return <code>true</code> if the HttpOnly flag should be set on session
      *         cookies
      */
@@ -1147,7 +1207,7 @@
 
     /**
      * Sets the use HttpOnly cookies for session cookies flag.
-     * 
+     *
      * @param useHttpOnly   Set to <code>true</code> to use HttpOnly cookies
      *                          for session cookies
      */
@@ -1158,8 +1218,79 @@
                 oldUseHttpOnly,
                 this.useHttpOnly);
     }
-    
-    
+
+
+    /**
+     * Gets the domain to use for session cookies.
+     *
+     * @return  The value of the default session cookie domain or null if not
+     *          specified
+     */
+    public String getSessionCookieDomain() {
+        return sessionCookieDomain;
+    }
+
+
+    /**
+     * Sets the domain to use for session cookies.
+     *
+     * @param sessionCookieDomain   The domain to use
+     */
+    public void setSessionCookieDomain(String sessionCookieDomain) {
+        String oldSessionCookieDomain = this.sessionCookieDomain;
+        this.sessionCookieDomain = sessionCookieDomain;
+        support.firePropertyChange("sessionCookieDomain",
+                oldSessionCookieDomain, sessionCookieDomain);
+    }
+
+
+    /**
+     * Gets the path to use for session cookies.
+     *
+     * @return  The value of the default session cookie path or null if not
+     *          specified
+     */
+    public String getSessionCookiePath() {
+        return sessionCookiePath;
+    }
+
+
+    /**
+     * Sets the path to use for session cookies.
+     *
+     * @param sessionCookiePath   The path to use
+     */
+    public void setSessionCookiePath(String sessionCookiePath) {
+        String oldSessionCookiePath = this.sessionCookiePath;
+        this.sessionCookiePath = sessionCookiePath;
+        support.firePropertyChange("sessionCookiePath",
+                oldSessionCookiePath, sessionCookiePath);
+    }
+
+
+    /**
+     * Gets the name to use for session cookies.
+     *
+     * @return  The value of the default session cookie name or null if not
+     *          specified
+     */
+    public String getSessionCookieName() {
+        return sessionCookieName;
+    }
+
+
+    /**
+     * Sets the name to use for session cookies. Overrides any setting that
+     * may be specified by the application.
+     *
+     * @param sessionCookieName   The name to use
+     */
+    public void setSessionCookieName(String sessionCookieName) {
+        String oldSessionCookieName = this.sessionCookieName;
+        this.sessionCookieName = sessionCookieName;
+        support.firePropertyChange("sessionCookieName",
+                oldSessionCookieName, sessionCookieName);
+    }
 
 
     /**
@@ -1191,12 +1322,12 @@
         return defaultContextXml;
     }
 
-    /** 
+    /**
      * Set the location of the default context xml that will be used.
      * If not absolute, it'll be made relative to the engine's base dir
      * ( which defaults to catalina.base system property ).
      *
-     * @param defaultContextXml The default web xml 
+     * @param defaultContextXml The default web xml
      */
     public void setDefaultContextXml(String defaultContextXml) {
         this.defaultContextXml = defaultContextXml;
@@ -1206,12 +1337,12 @@
         return defaultWebXml;
     }
 
-    /** 
+    /**
      * Set the location of the default web xml that will be used.
      * If not absolute, it'll be made relative to the engine's base dir
      * ( which defaults to catalina.base system property ).
      *
-     * @param defaultWebXml The default web xml 
+     * @param defaultWebXml The default web xml
      */
     public void setDefaultWebXml(String defaultWebXml) {
         this.defaultWebXml = defaultWebXml;
@@ -1352,6 +1483,37 @@
 
     }
 
+    /**
+     * Is URL rewriting disabled?
+     * URL rewriting is an optional component of the servlet 2.5 specification.
+     * However if set to true this will be non-compliant with the specification
+     * as the specification requires that there <b>must</b> be a way to retain
+     * sessions if the client doesn't allow session cookies.
+     *
+     * @return true If URL rewriting is disabled.
+     *
+     * @see <a href="http://jcp.org/aboutJava/communityprocess/mrel/jsr154/index2.html">Servlet
+     *      2.5 Specification. Sections SRV.7.1.3 and SRV.7.1.4</a>
+     * @see javax.servlet.http.HttpServletResponse#encodeURL(String) encodeURL
+     * @see javax.servlet.http.HttpServletResponse#encodeRedirectURL(String)
+     *      encodeRedirectURL
+     */
+    public boolean isDisableURLRewriting() {
+        return (this.disableURLRewriting);
+    }
+
+    /**
+     * Sets the disabling of URL Rewriting.
+     * @param disable True to disable URL Rewriting. Default <b>false</b>.
+     */
+    public void setDisableURLRewriting(boolean disable){
+        boolean oldDisableURLRewriting = this.isDisableURLRewriting();
+        this.disableURLRewriting = disable;
+        support.firePropertyChange("disableURLRewriting",
+                oldDisableURLRewriting, disableURLRewriting);
+
+    }
+
     // experimental
     public boolean isLazy() {
         return lazy;
@@ -1417,12 +1579,12 @@
     public boolean getIgnoreAnnotations() {
         return this.ignoreAnnotations;
     }
-    
-    
+
+
     /**
-     * Set the boolean on the annotations parsing for this web 
+     * Set the boolean on the annotations parsing for this web
      * application.
-     * 
+     *
      * @param ignoreAnnotations The boolean on the annotations parsing
      */
     public void setIgnoreAnnotations(boolean ignoreAnnotations) {
@@ -1431,8 +1593,8 @@
         support.firePropertyChange("ignoreAnnotations", oldIgnoreAnnotations,
                 this.ignoreAnnotations);
     }
-    
-    
+
+
     /**
      * Return the login configuration descriptor for this web application.
      */
@@ -1537,7 +1699,7 @@
 
     }
 
-    
+
     /**
      * Set the context path for this Context.
      * <p>
@@ -1624,7 +1786,7 @@
 
         this.originalDocBase = docBase;
     }
-    
+
 
     /**
      * Return the parent class loader (if any) for this web application.
@@ -1642,7 +1804,7 @@
         return (ClassLoader.getSystemClassLoader());
     }
 
-    
+
     /**
      * Return the privileged flag for this web application.
      */
@@ -1816,7 +1978,7 @@
     /**
      * Set the value of the unloadDelay flag, which represents the amount
      * of ms that the container will wait when unloading servlets.
-     * Setting this to a small value may cause more requests to fail 
+     * Setting this to a small value may cause more requests to fail
      * to complete when stopping a web application.
      *
      * @param unloadDelay The new value
@@ -1876,7 +2038,7 @@
         this.wrapperClassName = wrapperClassName;
 
         try {
-            wrapperClass = Class.forName(wrapperClassName);         
+            wrapperClass = Class.forName(wrapperClassName);
             if (!StandardWrapper.class.isAssignableFrom(wrapperClass)) {
                 throw new IllegalArgumentException(
                     sm.getString("standardContext.invalidWrapperClass",
@@ -1959,9 +2121,9 @@
 
     /** Get the absolute path to the work dir.
      *  To avoid duplication.
-     * 
+     *
      * @return The work path
-     */ 
+     */
     public String getWorkPath() {
         if (getWorkDir() == null) {
             return null;
@@ -1980,7 +2142,7 @@
         }
         return workDir.getAbsolutePath();
     }
-    
+
     /**
      * Return the work directory for this Context.
      */
@@ -2049,6 +2211,79 @@
     }
 
 
+    /**
+     * Return the clearReferencesStopTimerThreads flag for this Context.
+     */
+    public boolean getClearReferencesStopTimerThreads() {
+        return (this.clearReferencesStopTimerThreads);
+    }
+
+
+    /**
+     * Set the clearReferencesStopTimerThreads feature for this Context.
+     *
+     * @param clearReferencesStopTimerThreads The new flag value
+     */
+    public void setClearReferencesStopTimerThreads(
+            boolean clearReferencesStopTimerThreads) {
+
+        boolean oldClearReferencesStopTimerThreads =
+            this.clearReferencesStopTimerThreads;
+        this.clearReferencesStopTimerThreads = clearReferencesStopTimerThreads;
+        support.firePropertyChange("clearReferencesStopTimerThreads",
+                                   oldClearReferencesStopTimerThreads,
+                                   this.clearReferencesStopTimerThreads);
+    }
+
+
+    /**
+     * Return the clearReferencesThreadLocals flag for this Context.
+     */
+    public boolean getClearReferencesThreadLocals() {
+
+        return (this.clearReferencesThreadLocals);
+    }
+
+    /**
+     * Return the clearReferencesHttpClientKeepAliveThread flag for this
+     * Context.
+     */
+    public boolean getClearReferencesHttpClientKeepAliveThread() {
+        return (this.clearReferencesHttpClientKeepAliveThread);
+    }
+
+
+    /**
+     * Set the clearReferencesHttpClientKeepAliveThread feature for this
+     * Context.
+     *
+     * @param clearReferencesHttpClientKeepAliveThread The new flag value
+     */
+    public void setClearReferencesHttpClientKeepAliveThread(
+            boolean clearReferencesHttpClientKeepAliveThread) {
+        this.clearReferencesHttpClientKeepAliveThread =
+            clearReferencesHttpClientKeepAliveThread;
+    }
+
+
+    /**
+     * Set the clearReferencesThreadLocals feature for this Context.
+     *
+     * @param clearReferencesThreadLocals The new flag value
+     */
+    public void setClearReferencesThreadLocals(
+            boolean clearReferencesThreadLocals) {
+
+        boolean oldClearReferencesThreadLocals =
+            this.clearReferencesThreadLocals;
+        this.clearReferencesThreadLocals = clearReferencesThreadLocals;
+        support.firePropertyChange("clearReferencesStopThreads",
+                                   oldClearReferencesThreadLocals,
+                                   this.clearReferencesThreadLocals);
+
+    }
+
+
     // -------------------------------------------------------- Context Methods
 
 
@@ -2140,7 +2375,7 @@
         if ((jspFile != null) && !jspFile.startsWith("/")) {
             if (isServlet22()) {
                 if(log.isDebugEnabled())
-                    log.debug(sm.getString("standardContext.wrapper.warning", 
+                    log.debug(sm.getString("standardContext.wrapper.warning",
                                        jspFile));
                 wrapper.setJspFile("/" + jspFile);
             } else {
@@ -2278,8 +2513,8 @@
 //      if ((servletNames.length == 0) && (urlPatterns.length == 0))
 //      Servlet API 2.5 (FIX 43338)
 //      SRV 6.2.5 says supporting for '*' as the servlet-name in filter-mapping.
-        if (!filterMap.getMatchAllServletNames() && 
-            !filterMap.getMatchAllUrlPatterns() && 
+        if (!filterMap.getMatchAllServletNames() &&
+            !filterMap.getMatchAllUrlPatterns() &&
             (servletNames.length == 0) && (urlPatterns.length == 0))
             throw new IllegalArgumentException
                 (sm.getString("standardContext.filterMap.either"));
@@ -2852,8 +3087,8 @@
     public Context findMappingObject() {
         return (Context) getMappingObject();
     }
-    
-    
+
+
     /**
      * Return the message destination with the specified name, if any;
      * otherwise, return <code>null</code>.
@@ -3140,7 +3375,7 @@
 
 
     /**
-     * Return the set of watched resources for this Context. If none are 
+     * Return the set of watched resources for this Context. If none are
      * defined, a zero length array will be returned.
      */
     public String[] findWatchedResources() {
@@ -3148,8 +3383,8 @@
             return watchedResources;
         }
     }
-    
-    
+
+
     /**
      * Return the set of welcome files defined for this Context.  If none are
      * defined, a zero-length array is returned.
@@ -3213,7 +3448,8 @@
         //          throw new IllegalStateException
         //              (sm.getString("standardContext.notReloadable"));
         if(log.isInfoEnabled())
-            log.info(sm.getString("standardContext.reloadingStarted"));
+            log.info(sm.getString("standardContext.reloadingStarted",
+                    getName()));
 
         // Stop accepting requests temporarily
         setPaused(true);
@@ -3221,13 +3457,15 @@
         try {
             stop();
         } catch (LifecycleException e) {
-            log.error(sm.getString("standardContext.stoppingContext"), e);
+            log.error(sm.getString("standardContext.stoppingContext",
+                    getName()), e);
         }
 
         try {
             start();
         } catch (LifecycleException e) {
-            log.error(sm.getString("standardContext.startingContext"), e);
+            log.error(sm.getString("standardContext.startingContext",
+                    getName()), e);
         }
 
         setPaused(false);
@@ -3639,11 +3877,11 @@
     /**
      * Remove the specified watched resource name from the list associated
      * with this Context.
-     * 
+     *
      * @param name Name of the watched resource to be removed
      */
     public void removeWatchedResource(String name) {
-        
+
         synchronized (watchedResourcesLock) {
 
             // Make sure this watched resource is currently present
@@ -3671,8 +3909,8 @@
         fireContainerEvent("removeWatchedResource", name);
 
     }
-    
-    
+
+
     /**
      * Remove the specified welcome file name from the list recognized
      * by this Context.
@@ -3798,7 +4036,7 @@
      * StandardContext
      */
     public long getProcessingTime() {
-        
+
         long result = 0;
 
         Container[] children = findChildren();
@@ -4049,7 +4287,7 @@
                 }
             }
         }
-        
+
         setApplicationEventListeners(null);
         setApplicationLifecycleListeners(null);
 
@@ -4093,9 +4331,9 @@
             }
             // Register the cache in JMX
             if (isCachingAllowed()) {
-                ObjectName resourcesName = 
-                    new ObjectName(this.getDomain() + ":type=Cache,host=" 
-                                   + getHostname() + ",path=" 
+                ObjectName resourcesName =
+                    new ObjectName(this.getDomain() + ":type=Cache,host="
+                                   + getHostname() + ",path="
                                    + (("".equals(getPath()))?"/":getPath()));
                 Registry.getRegistry(null, null).registerComponent
                     (proxyDirContext.getCache(), resourcesName, null);
@@ -4128,10 +4366,10 @@
                 }
                 // Unregister the cache in JMX
                 if (isCachingAllowed()) {
-                    ObjectName resourcesName = 
+                    ObjectName resourcesName =
                         new ObjectName(this.getDomain()
-                                       + ":type=Cache,host=" 
-                                       + getHostname() + ",path=" 
+                                       + ":type=Cache,host="
+                                       + getHostname() + ",path="
                                        + (("".equals(getPath()))?"/"
                                           :getPath()));
                     Registry.getRegistry(null, null)
@@ -4210,7 +4448,7 @@
                 log.info(sm.getString("containerBase.alreadyStarted", logName()));
             return;
         }
-        if( !initialized ) { 
+        if( !initialized ) {
             try {
                 init();
             } catch( Exception ex ) {
@@ -4223,7 +4461,7 @@
         // Set JMX object name for proper pipeline registration
         preRegisterJMX();
 
-        if ((oname != null) && 
+        if ((oname != null) &&
             (Registry.getRegistry(null, null).getMBeanServer().isRegistered(oname))) {
             // As things depend on the JMX registration, the context
             // must be reregistered again once properly initialized
@@ -4258,26 +4496,26 @@
             }
         }
 
-        // Look for a realm - that may have been configured earlier. 
+        // Look for a realm - that may have been configured earlier.
         // If the realm is added after context - it'll set itself.
-        // TODO: what is the use case for this ? 
+        // TODO: what is the use case for this ?
         if( realm == null && mserver != null ) {
             ObjectName realmName=null;
             try {
-                realmName=new ObjectName( getEngineName() + ":type=Realm,host=" + 
+                realmName=new ObjectName( getEngineName() + ":type=Realm,host=" +
                         getHostname() + ",path=" + getPath());
                 if( mserver.isRegistered(realmName ) ) {
-                    mserver.invoke(realmName, "init", 
+                    mserver.invoke(realmName, "init",
                             new Object[] {},
                             new String[] {}
-                    );            
+                    );
                 }
             } catch( Throwable t ) {
                 if(log.isDebugEnabled())
                     log.debug("No realm for this host " + realmName);
             }
         }
-        
+
         if (getLoader() == null) {
             WebappLoader webappLoader = new WebappLoader(getParentClassLoader());
             webappLoader.setDelegate(getDelegate());
@@ -4319,12 +4557,12 @@
                 addLifecycleListener(namingContextListener);
             }
         }
-        
+
         // Standard container startup
         if (log.isDebugEnabled())
             log.debug("Processing standard container startup");
 
-        
+
         // Binding thread
         ClassLoader oldCCL = bindThread();
 
@@ -4333,26 +4571,27 @@
         try {
 
             if (ok) {
-                
+
                 started = true;
 
                 // Start our subordinate components, if any
                 if ((loader != null) && (loader instanceof Lifecycle))
                     ((Lifecycle) loader).start();
 
-                // Unbinding thread
+                // since the loader just started, the webapp classloader is now
+                // created.
+                // By calling unbindThread and bindThread in a row, we setup the
+                // current Thread CCL to be the webapp classloader
                 unbindThread(oldCCL);
-
-                // Binding thread
                 oldCCL = bindThread();
 
-                // Initialize logger again. Other components might have used it too early, 
+                // Initialize logger again. Other components might have used it too early,
                 // so it should be reset.
                 logger = null;
                 getLogger();
                 if ((logger != null) && (logger instanceof Lifecycle))
                     ((Lifecycle) logger).start();
-                
+
                 if ((cluster != null) && (cluster instanceof Lifecycle))
                     ((Lifecycle) cluster).start();
                 if ((realm != null) && (realm instanceof Lifecycle))
@@ -4372,10 +4611,10 @@
                 if (pipeline instanceof Lifecycle) {
                     ((Lifecycle) pipeline).start();
                 }
-                
+
                 // Notify our interested LifecycleListeners
                 lifecycle.fireLifecycleEvent(START_EVENT, null);
-                
+
                 // Acquire clustered manager
                 Manager contextManager = null;
                 if (manager == null) {
@@ -4389,8 +4628,8 @@
                     } else {
                         contextManager = new StandardManager();
                     }
-                } 
-                
+                }
+
                 // Configure default manager if none was specified
                 if (contextManager != null) {
                     setManager(contextManager);
@@ -4402,7 +4641,7 @@
                     getCluster().registerManager(manager);
                 }
 
-                
+
                 mainOk = true;
 
             }
@@ -4440,7 +4679,7 @@
         if (ok && !getIgnoreAnnotations()) {
             if (annotationProcessor == null) {
                 if (isUseNaming() && namingContextListener != null) {
-                    annotationProcessor = 
+                    annotationProcessor =
                         new DefaultAnnotationProcessor(namingContextListener.getEnvContext());
                 } else {
                     annotationProcessor = new DefaultAnnotationProcessor(null);
@@ -4451,17 +4690,20 @@
         }
 
         try {
-            
+
             // Create context attributes that will be required
             if (ok) {
                 postWelcomeFiles();
             }
-            
+
+            // Set up the context init params
+            mergeParameters();
+
             if (ok) {
                 // Notify our interested LifecycleListeners
                 lifecycle.fireLifecycleEvent(AFTER_START_EVENT, null);
             }
-            
+
             // Configure and call application event listeners
             if (ok) {
                 if (!listenerStart()) {
@@ -4469,13 +4711,13 @@
                     ok = false;
                 }
             }
-            
+
             try {
                 // Start manager
                 if ((manager != null) && (manager instanceof Lifecycle)) {
                     ((Lifecycle) getManager()).start();
                 }
-    
+
                 // Start ContainerBackgroundProcessor thread
                 super.threadStart();
             } catch(Exception e) {
@@ -4490,12 +4732,12 @@
                     ok = false;
                 }
             }
-            
+
             // Load and initialize all "load on startup" servlets
             if (ok) {
                 loadOnStartup(findChildren());
             }
-            
+
         } finally {
             // Unbinding thread
             unbindThread(oldCCL);
@@ -4520,16 +4762,16 @@
         registerJMX();
 
         startTime=System.currentTimeMillis();
-        
-        // Send j2ee.state.running notification 
+
+        // Send j2ee.state.running notification
         if (ok && (this.getObjectName() != null)) {
-            Notification notification = 
-                new Notification("j2ee.state.running", this.getObjectName(), 
+            Notification notification =
+                new Notification("j2ee.state.running", this.getObjectName(),
                                 sequenceNumber++);
             broadcaster.sendNotification(notification);
         }
 
-        // Close all JARs right away to avoid always opening a peak number 
+        // Close all JARs right away to avoid always opening a peak number
         // of files on startup
         if (getLoader() instanceof WebappLoader) {
             ((WebappLoader) getLoader()).closeJARs(true);
@@ -4543,11 +4785,11 @@
         //cacheContext();
     }
 
-    
+
     private void cacheContext() {
         try {
             File workDir=new File( getWorkPath() );
-            
+
             File ctxSer=new File( workDir, "_tomcat_context.ser");
             FileOutputStream fos=new FileOutputStream( ctxSer );
             ObjectOutputStream oos=new ObjectOutputStream( fos );
@@ -4560,7 +4802,40 @@
         }
     }
 
-    
+
+    /**
+     * Merge the context initialization parameters specified in the application
+     * deployment descriptor with the application parameters described in the
+     * server configuration, respecting the <code>override</code> property of
+     * the application parameters appropriately.
+     */
+    private void mergeParameters() {
+        Map<String,String> mergedParams = new HashMap<String,String>();
+
+        String names[] = findParameters();
+        for (int i = 0; i < names.length; i++) {
+            mergedParams.put(names[i], findParameter(names[i]));
+        }
+
+        ApplicationParameter params[] = findApplicationParameters();
+        for (int i = 0; i < params.length; i++) {
+            if (params[i].getOverride()) {
+                if (mergedParams.get(params[i].getName()) == null) {
+                    mergedParams.put(params[i].getName(),
+                            params[i].getValue());
+                }
+            } else {
+                mergedParams.put(params[i].getName(), params[i].getValue());
+            }
+        }
+
+        for (Map.Entry<String,String> entry : mergedParams.entrySet()) {
+            context.setInitParameter(entry.getKey(), entry.getValue());
+        }
+
+    }
+
+
     /**
      * Stop this Context component.
      *
@@ -4577,15 +4852,15 @@
 
         // Notify our interested LifecycleListeners
         lifecycle.fireLifecycleEvent(BEFORE_STOP_EVENT, null);
-        
-        // Send j2ee.state.stopping notification 
+
+        // Send j2ee.state.stopping notification
         if (this.getObjectName() != null) {
-            Notification notification = 
-                new Notification("j2ee.state.stopping", this.getObjectName(), 
+            Notification notification =
+                new Notification("j2ee.state.stopping", this.getObjectName(),
                                 sequenceNumber++);
             broadcaster.sendNotification(notification);
         }
-        
+
         // Mark this application as unavailable while we shut down
         setAvailable(false);
 
@@ -4656,24 +4931,24 @@
 
         }
 
-        // Send j2ee.state.stopped notification 
+        // Send j2ee.state.stopped notification
         if (this.getObjectName() != null) {
-            Notification notification = 
-                new Notification("j2ee.state.stopped", this.getObjectName(), 
+            Notification notification =
+                new Notification("j2ee.state.stopped", this.getObjectName(),
                                 sequenceNumber++);
             broadcaster.sendNotification(notification);
         }
-        
+
         // Reset application context
         context = null;
 
-        // This object will no longer be visible or used. 
+        // This object will no longer be visible or used.
         try {
             resetContext();
         } catch( Exception ex ) {
             log.error( "Error reseting context " + this + " " + ex, ex );
         }
-        
+
         // Notify our interested LifecycleListeners
         lifecycle.fireLifecycleEvent(AFTER_STOP_EVENT, null);
 
@@ -4683,25 +4958,25 @@
     }
 
     /** Destroy needs to clean up the context completely.
-     * 
-     * The problem is that undoing all the config in start() and restoring 
+     *
+     * The problem is that undoing all the config in start() and restoring
      * a 'fresh' state is impossible. After stop()/destroy()/init()/start()
      * we should have the same state as if a fresh start was done - i.e
-     * read modified web.xml, etc. This can only be done by completely 
+     * read modified web.xml, etc. This can only be done by completely
      * removing the context object and remapping a new one, or by cleaning
      * up everything.
-     * 
+     *
      * XXX Should this be done in stop() ?
-     * 
-     */ 
+     *
+     */
     public void destroy() throws Exception {
-        if( oname != null ) { 
-            // Send j2ee.object.deleted notification 
-            Notification notification = 
-                new Notification("j2ee.object.deleted", this.getObjectName(), 
+        if( oname != null ) {
+            // Send j2ee.object.deleted notification
+            Notification notification =
+                new Notification("j2ee.object.deleted", this.getObjectName(),
                                 sequenceNumber++);
             broadcaster.sendNotification(notification);
-        } 
+        }
         super.destroy();
 
         // Notify our interested LifecycleListeners
@@ -4712,7 +4987,7 @@
         }
 
     }
-    
+
     private void resetContext() throws Exception, MBeanRegistrationException {
         // Restore the original state ( pre reading web.xml in start )
         // If you extend this - override this method and make sure to clean up
@@ -4728,7 +5003,7 @@
         applicationEventListenersObjects = new Object[0];
         applicationLifecycleListenersObjects = new Object[0];
         taglibs = new HashMap<String, String>();
-        
+
         annotationProcessor = null;
 
         if(log.isDebugEnabled())
@@ -4784,15 +5059,7 @@
      * Are we processing a version 2.2 deployment descriptor?
      */
     protected boolean isServlet22() {
-
-        if (this.publicId == null)
-            return (false);
-        if (this.publicId.equals
-            (org.apache.catalina.startup.Constants.WebDtdPublicId_22))
-            return (true);
-        else
-            return (false);
-
+        return XmlIdentifiers.WEB_22_PUBLIC.equals(publicId);
     }
 
 
@@ -4832,7 +5099,7 @@
                 (getLoader().getClassLoader());
         }
 
-        DirContextURLStreamHandler.bind(getResources());
+        DirContextURLStreamHandler.bindThread(getResources());
 
         if (isUseNaming()) {
             try {
@@ -4853,16 +5120,13 @@
      */
     private void unbindThread(ClassLoader oldContextClassLoader) {
 
-        Thread.currentThread().setContextClassLoader(oldContextClassLoader);
-
-        oldContextClassLoader = null;
-
         if (isUseNaming()) {
             ContextBindings.unbindThread(this, this);
         }
 
-        DirContextURLStreamHandler.unbind();
+        DirContextURLStreamHandler.unbindThread();
 
+        Thread.currentThread().setContextClassLoader(oldContextClassLoader);
     }
 
 
@@ -4919,7 +5183,7 @@
      * Get config base.
      */
     public File getConfigBase() {
-        File configBase = 
+        File configBase =
             new File(System.getProperty("catalina.base"), "conf");
         if (!configBase.exists()) {
             return null;
@@ -5027,14 +5291,14 @@
     return namingContextName;
     }
 
-    
+
     /**
      * Naming context listener accessor.
      */
     public NamingContextListener getNamingContextListener() {
         return namingContextListener;
     }
-    
+
 
     /**
      * Naming context listener setter.
@@ -5042,7 +5306,7 @@
     public void setNamingContextListener(NamingContextListener namingContextListener) {
         this.namingContextListener = namingContextListener;
     }
-    
+
 
     /**
      * Return the request processing paused flag for this Context.
@@ -5146,13 +5410,11 @@
         dir.mkdirs();
 
         // Set the appropriate servlet context attribute
-        // Fix for CVE-2010-3718
         if (context == null) {
-           getServletContext();
+            getServletContext();
         }
         context.setAttribute(Globals.WORK_DIR_ATTR, dir);
         context.setAttributeReadOnly(Globals.WORK_DIR_ATTR);
-
     }
 
 
@@ -5220,10 +5482,10 @@
     /**
      * JSR77 deploymentDescriptor attribute
      *
-     * @return string deployment descriptor 
+     * @return string deployment descriptor
      */
     public String getDeploymentDescriptor() {
-    
+
         InputStream stream = null;
         ServletContext servletContext = getServletContext();
         if (servletContext != null) {
@@ -5246,18 +5508,18 @@
             return "";
         }
 
-        return sb.toString(); 
-    
+        return sb.toString();
+
     }
-    
-    
+
+
     /**
      * JSR77 servlets attribute
      *
      * @return list of all servlets ( we know about )
      */
     public String[] getServlets() {
-        
+
         String[] result = null;
 
         Container[] children = findChildren();
@@ -5270,14 +5532,14 @@
 
         return result;
     }
-    
+
 
     public ObjectName createObjectName(String hostDomain, ObjectName parentName)
             throws MalformedObjectNameException
     {
         String onameStr;
         StandardHost hst=(StandardHost)getParent();
-        
+
         String pathName=getName();
         String hostName=getParent().getName();
         String name= "//" + ((hostName==null)? "DEFAULT" : hostName) +
@@ -5290,18 +5552,18 @@
         onameStr="j2eeType=WebModule,name=" + name + suffix;
         if( log.isDebugEnabled())
             log.debug("Registering " + onameStr + " for " + oname);
-        
+
         // default case - no domain explictely set.
         if( getDomain() == null ) domain=hst.getDomain();
 
         ObjectName oname=new ObjectName(getDomain() + ":" + onameStr);
-        return oname;        
-    }    
-    
+        return oname;
+    }
+
     private void preRegisterJMX() {
         try {
             StandardHost host = (StandardHost) getParent();
-            if ((oname == null) 
+            if ((oname == null)
                 || (oname.getKeyProperty("j2eeType") == null)) {
                 oname = createObjectName(host.getDomain(), host.getJmxName());
                 controller = oname;
@@ -5323,12 +5585,12 @@
                 controller = oname;
                 Registry.getRegistry(null, null)
                     .registerComponent(this, oname, null);
-                
-                // Send j2ee.object.created notification 
+
+                // Send j2ee.object.created notification
                 if (this.getObjectName() != null) {
                     Notification notification = new Notification(
-                                                        "j2ee.object.created", 
-                                                        this.getObjectName(), 
+                                                        "j2ee.object.created",
+                                                        this.getObjectName(),
                                                         sequenceNumber++);
                     broadcaster.sendNotification(notification);
                 }
@@ -5380,7 +5642,7 @@
 
         if( this.getParent() == null ) {
             ObjectName parentName=getParentName();
-            
+
             if( ! mserver.isRegistered(parentName)) {
                 if(log.isDebugEnabled())
                     log.debug("No host, creating one " + parentName);
@@ -5394,7 +5656,7 @@
                 // or same thing easier:
                 host.init();
             }
-            
+
             // Add the main configuration listener
             LifecycleListener config = null;
             try {
@@ -5436,18 +5698,18 @@
         }
 
         super.init();
-        
+
         // Notify our interested LifecycleListeners
         lifecycle.fireLifecycleEvent(INIT_EVENT, null);
 
-        // Send j2ee.state.starting notification 
+        // Send j2ee.state.starting notification
         if (this.getObjectName() != null) {
-            Notification notification = new Notification("j2ee.state.starting", 
-                                                        this.getObjectName(), 
+            Notification notification = new Notification("j2ee.state.starting",
+                                                        this.getObjectName(),
                                                         sequenceNumber++);
             broadcaster.sendNotification(notification);
         }
-        
+
     }
 
     public ObjectName getParentName() throws MalformedObjectNameException {
@@ -5483,22 +5745,22 @@
                 "type=Host,host=" + hostName);
         return parentName;
     }
-    
+
     public void create() throws Exception{
         init();
     }
 
-    /* Remove a JMX notficationListener 
+    /* Remove a JMX notficationListener
      * @see javax.management.NotificationEmitter#removeNotificationListener(javax.management.NotificationListener, javax.management.NotificationFilter, java.lang.Object)
      */
-    public void removeNotificationListener(NotificationListener listener, 
+    public void removeNotificationListener(NotificationListener listener,
             NotificationFilter filter, Object object) throws ListenerNotFoundException {
     	broadcaster.removeNotificationListener(listener,filter,object);
-    	
+
     }
-    
+
     private MBeanNotificationInfo[] notificationInfo;
-    
+
     /* Get JMX Broadcaster Info
      * @TODO use StringManager for international support!
      * @TODO This two events we not send j2ee.state.failed and j2ee.attribute.changed!
@@ -5512,7 +5774,7 @@
     				"j2ee.object.created"},
 					Notification.class.getName(),
 					"web application is created"
-    				), 
+    				),
 					new MBeanNotificationInfo(new String[] {
 					"j2ee.state.starting"},
 					Notification.class.getName(),
@@ -5539,34 +5801,34 @@
 					"web application is deleted"
 					)
     		};
-    		
+
     	}
-    	
+
     	return notificationInfo;
     }
-    
-    
+
+
     /* Add a JMX-NotificationListener
      * @see javax.management.NotificationBroadcaster#addNotificationListener(javax.management.NotificationListener, javax.management.NotificationFilter, java.lang.Object)
      */
-    public void addNotificationListener(NotificationListener listener, 
+    public void addNotificationListener(NotificationListener listener,
             NotificationFilter filter, Object object) throws IllegalArgumentException {
     	broadcaster.addNotificationListener(listener,filter,object);
-    	
+
     }
-    
-    
+
+
     /**
-     * Remove a JMX-NotificationListener 
+     * Remove a JMX-NotificationListener
      * @see javax.management.NotificationBroadcaster#removeNotificationListener(javax.management.NotificationListener)
      */
-    public void removeNotificationListener(NotificationListener listener) 
+    public void removeNotificationListener(NotificationListener listener)
     throws ListenerNotFoundException {
     	broadcaster.removeNotificationListener(listener);
-    	
+
     }
-    
-    
+
+
     // ------------------------------------------------------------- Attributes
 
 
@@ -5582,7 +5844,7 @@
 
     /**
      * Return the naming resources associated with this web application.
-     * FIXME: Fooling introspection ... 
+     * FIXME: Fooling introspection ...
      */
     public javax.naming.directory.DirContext findStaticResources() {
 
@@ -5600,66 +5862,57 @@
 
     }
 
-     /**
-     * Set the validation feature of the XML parser used when
-     * parsing xml instances.
-     * @param webXmlValidation true to enable xml instance validation
-     */
+
+    public boolean getXmlNamespaceAware(){
+        return webXmlNamespaceAware;
+    }
+
+
+    public void setXmlNamespaceAware(boolean webXmlNamespaceAware){
+        this.webXmlNamespaceAware= webXmlNamespaceAware;
+    }
+
+
     public void setXmlValidation(boolean webXmlValidation){
-        
         this.webXmlValidation = webXmlValidation;
-
     }
 
-    /**
-     * Get the server.xml <context> attribute's xmlValidation.
-     * @return true if validation is enabled.
-     *
-     */
+
     public boolean getXmlValidation(){
         return webXmlValidation;
     }
 
 
-    /**
-     * Get the server.xml <context> attribute's xmlNamespaceAware.
-     * @return true if namespace awarenes is enabled.
-     */
-    public boolean getXmlNamespaceAware(){
-        return webXmlNamespaceAware;
+    public boolean getTldNamespaceAware(){
+        return true;
     }
 
 
-    /**
-     * Set the namespace aware feature of the XML parser used when
-     * parsing xml instances.
-     * @param webXmlNamespaceAware true to enable namespace awareness
-     */
-    public void setXmlNamespaceAware(boolean webXmlNamespaceAware){
-        this.webXmlNamespaceAware= webXmlNamespaceAware;
-    }    
+    public void setTldNamespaceAware(boolean tldNamespaceAware){
+        // NO-OP;
+    }
+
+
+    public void setXmlBlockExternal(boolean xmlBlockExternal) {
+        this.xmlBlockExternal = xmlBlockExternal;
+    }
+
+
+    public boolean getXmlBlockExternal() {
+        return xmlBlockExternal;
+    }
 
 
-    /**
-     * Set the validation feature of the XML parser used when
-     * parsing tlds files. 
-     * @param tldValidation true to enable xml instance validation
-     */
     public void setTldValidation(boolean tldValidation){
-        
         this.tldValidation = tldValidation;
-
     }
 
-    /**
-     * Get the server.xml <context> attribute's webXmlValidation.
-     * @return true if validation is enabled.
-     *
-     */
+
     public boolean getTldValidation(){
         return tldValidation;
     }
 
+
     /**
      * Sets the process TLDs attribute.
      *
@@ -5676,93 +5929,79 @@
 	return processTlds;
     }
 
-    /**
-     * Get the server.xml &lt;host&gt; attribute's xmlNamespaceAware.
-     * @return true if namespace awarenes is enabled.
-     */
-    public boolean getTldNamespaceAware(){
-        return tldNamespaceAware;
-    }
-
 
     /**
-     * Set the namespace aware feature of the XML parser used when
-     * parsing xml instances.
-     * @param tldNamespaceAware true to enable namespace awareness
-     */
-    public void setTldNamespaceAware(boolean tldNamespaceAware){
-        this.tldNamespaceAware= tldNamespaceAware;
-    }    
-
-
-    /** 
-     * Support for "stateManageable" JSR77 
+     * Support for "stateManageable" JSR77
      */
     public boolean isStateManageable() {
         return true;
     }
-    
+
     public void startRecursive() throws LifecycleException {
         // nothing to start recursive, the servlets will be started by load-on-startup
         start();
     }
-    
+
     public int getState() {
         if( started ) {
             return 1; // RUNNING
         }
         if( initialized ) {
-            return 0; // starting ? 
+            return 0; // starting ?
         }
-        if( ! available ) { 
+        if( ! available ) {
             return 4; //FAILED
         }
         // 2 - STOPPING
         return 3; // STOPPED
     }
-    
+
+    public String getStateName() {
+        return lifecycle.getState();
+    }
+
     /**
      * The J2EE Server ObjectName this module is deployed on.
-     */     
+     */
     private String server = null;
-    
+
     /**
      * The Java virtual machines on which this module is running.
-     */       
+     */
     private String[] javaVMs = null;
-    
+
     public String getServer() {
         return server;
     }
-        
+
     public String setServer(String server) {
         return this.server=server;
     }
-        
+
     public String[] getJavaVMs() {
         return javaVMs;
     }
-        
+
     public String[] setJavaVMs(String[] javaVMs) {
         return this.javaVMs = javaVMs;
     }
-    
+
     /**
      * Gets the time this context was started.
      *
      * @return Time (in milliseconds since January 1, 1970, 00:00:00) when this
-     * context was started 
+     * context was started
      */
     public long getStartTime() {
         return startTime;
     }
-    
+
     public boolean isEventProvider() {
         return false;
     }
-    
+
     public boolean isStatisticsProvider() {
         return false;
     }
-    
+
 }
--- java/org/apache/catalina/startup/ContextConfig.java.orig	2014-07-15 15:26:23.957389000 -0400
+++ java/org/apache/catalina/startup/ContextConfig.java	2014-07-17 17:50:17.051405000 -0400
@@ -5,20 +5,17 @@
  * The ASF licenses this file to You under the Apache License, Version 2.0
  * (the "License"); you may not use this file except in compliance with
  * the License.  You may obtain a copy of the License at
- * 
+ *
  *      http://www.apache.org/licenses/LICENSE-2.0
- * 
+ *
  * Unless required by applicable law or agreed to in writing, software
  * distributed under the License is distributed on an "AS IS" BASIS,
  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  * See the License for the specific language governing permissions and
  * limitations under the License.
  */
-
-
 package org.apache.catalina.startup;
 
-
 import java.io.File;
 import java.io.FileInputStream;
 import java.io.FileNotFoundException;
@@ -52,6 +49,10 @@
 import org.apache.catalina.deploy.LoginConfig;
 import org.apache.catalina.deploy.SecurityConstraint;
 import org.apache.catalina.util.StringManager;
+import org.apache.juli.logging.Log;
+import org.apache.juli.logging.LogFactory;
+import org.apache.tomcat.util.descriptor.DigesterFactory;
+import org.apache.tomcat.util.descriptor.XmlErrorHandler;
 import org.apache.tomcat.util.digester.Digester;
 import org.apache.tomcat.util.digester.RuleSet;
 import org.xml.sax.ErrorHandler;
@@ -64,14 +65,18 @@
  *
  * @author Craig R. McClanahan
  * @author Jean-Francois Arcand
- * @version $Revision: 892815 $ $Date: 2009-12-21 14:27:57 +0100 (Mon, 21 Dec 2009) $
+ * @version $Id: ContextConfig.java 1558828 2014-01-16 15:12:59Z markt $
  */
+public class ContextConfig implements LifecycleListener {
 
-public class ContextConfig
-    implements LifecycleListener {
+    protected static Log log = LogFactory.getLog( ContextConfig.class );
+
+    /**
+     * The string resources for this package.
+     */
+    protected static final StringManager sm =
+        StringManager.getManager(Constants.Package);
 
-    protected static org.apache.juli.logging.Log log=
-        org.apache.juli.logging.LogFactory.getLog( ContextConfig.class );
 
     // ----------------------------------------------------- Instance Variables
 
@@ -100,14 +105,14 @@
      * The default web application's context file location.
      */
     protected String defaultContextXml = null;
-    
-    
+
+
     /**
      * The default web application's deployment descriptor location.
      */
     protected String defaultWebXml = null;
-    
-    
+
+
     /**
      * Track any fatal errors during startup configuration processing.
      */
@@ -116,21 +121,23 @@
 
     /**
      * Any parse error which occurred while parsing XML descriptors.
+     * @deprecated Unused. Will be removed in Tomcat 7.0.x.
      */
+    @Deprecated
     protected SAXParseException parseException = null;
 
-    
+
     /**
      * Original docBase.
      */
     protected String originalDocBase = null;
-    
+
 
     /**
-     * The string resources for this package.
+     * Anti-locking docBase. It is a path to a copy of the web application
+     * in the java.io.tmpdir directory. This path is always an absolute one.
      */
-    protected static final StringManager sm =
-        StringManager.getManager(Constants.Package);
+    private File antiLockingDocBase = null;
 
 
     /**
@@ -138,45 +145,42 @@
      * context files.
      */
     protected static Digester contextDigester = null;
-    
-    
+
+
     /**
      * The <code>Digester</code> we will use to process web application
      * deployment descriptor files.
      */
-    protected static Digester webDigester = null;
-    
-    
-    /**
-     * The <code>Rule</code> used to parse the web.xml
-     */
-    protected static WebRuleSet webRuleSet = new WebRuleSet();
+    protected Digester webDigester = null;
+    protected WebRuleSet webRuleSet = null;
 
     /**
      * Attribute value used to turn on/off XML validation
+     * @deprecated Unused. Will be removed in Tomcat 7.0.x.
      */
-     protected static boolean xmlValidation = false;
+    @Deprecated
+    protected static boolean xmlValidation = false;
 
 
     /**
      * Attribute value used to turn on/off XML namespace awarenes.
+     * @deprecated Unused. Will be removed in Tomcat 7.0.x.
      */
+    @Deprecated
     protected static boolean xmlNamespaceAware = false;
 
-    
+
     /**
      * Deployment count.
      */
     protected static long deploymentCount = 0L;
-    
-    
+
+
     protected static final LoginConfig DUMMY_LOGIN_CONFIG =
                                 new LoginConfig("NONE", null, null, null);
 
 
     // ------------------------------------------------------------- Properties
-
-
     /**
      * Return the location of the default deployment descriptor
      */
@@ -264,16 +268,9 @@
         } else if (event.getType().equals(StandardContext.AFTER_START_EVENT)) {
             // Restore docBase for management tools
             if (originalDocBase != null) {
-                String docBase = context.getDocBase();
                 context.setDocBase(originalDocBase);
-                originalDocBase = docBase;
             }
         } else if (event.getType().equals(Lifecycle.STOP_EVENT)) {
-            if (originalDocBase != null) {
-                String docBase = context.getDocBase();
-                context.setDocBase(originalDocBase);
-                originalDocBase = docBase;
-            }
             stop();
         } else if (event.getType().equals(Lifecycle.INIT_EVENT)) {
             init();
@@ -291,11 +288,11 @@
      * Process the application classes annotations, if it exists.
      */
     protected void applicationAnnotationsConfig() {
-        
+
         long t1=System.currentTimeMillis();
-        
+
         WebAnnotationSet.loadApplicationAnnotations(context);
-        
+
         long t2=System.currentTimeMillis();
         if (context instanceof StandardContext) {
             ((StandardContext) context).setStartupTime(t2-t1+
@@ -336,7 +333,7 @@
             }
             return;
         }
-        
+
         long t1=System.currentTimeMillis();
 
         URL url=null;
@@ -355,8 +352,11 @@
                     if (context instanceof StandardContext) {
                         ((StandardContext) context).setReplaceWelcomeFiles(true);
                     }
+
+                    XmlErrorHandler handler = new XmlErrorHandler();
+
                     webDigester.push(context);
-                    webDigester.setErrorHandler(new ContextErrorHandler());
+                    webDigester.setErrorHandler(handler);
 
                     if(log.isDebugEnabled()) {
                         log.debug("Parsing application web.xml file at " + url.toExternalForm());
@@ -364,8 +364,10 @@
 
                     webDigester.parse(is);
 
-                    if (parseException != null) {
+                    if (handler.getWarnings().size() > 0 ||
+                            handler.getErrors().size() > 0) {
                         ok = false;
+                        handler.logFindings(log, is.getSystemId());
                     }
                 } else {
                     log.info("No web.xml, using defaults " + context );
@@ -381,7 +383,6 @@
                 ok = false;
             } finally {
                 webDigester.reset();
-                parseException = null;
                 try {
                     if (stream != null) {
                         stream.close();
@@ -514,30 +515,21 @@
 
 
     /**
-     * Create (if necessary) and return a Digester configured to process the
+     * Create and return a Digester configured to process the
      * web application deployment descriptor (web.xml).
      */
-    protected static Digester createWebDigester() {
-        Digester webDigester =
-            createWebXmlDigester(xmlNamespaceAware, xmlValidation);
-        return webDigester;
-    }
+    protected void createWebXmlDigester(boolean namespaceAware,
+            boolean validation) {
 
+        boolean blockExternal = context.getXmlBlockExternal();
 
-    /**
-     * Create (if necessary) and return a Digester configured to process the
-     * web application deployment descriptor (web.xml).
-     */
-    public static Digester createWebXmlDigester(boolean namespaceAware,
-                                                boolean validation) {
-        
-        Digester webDigester =  DigesterFactory.newDigester(xmlValidation,
-                                                            xmlNamespaceAware,
-                                                            webRuleSet);
-        return webDigester;
+        webRuleSet = new WebRuleSet();
+        webDigester = DigesterFactory.newDigester(validation,
+                namespaceAware, webRuleSet, blockExternal);
+        webDigester.getParser();
     }
 
-    
+
     /**
      * Create (if necessary) and return a Digester configured to process the
      * context configuration descriptor for an application.
@@ -594,8 +586,8 @@
                     source = new InputSource
                             (getClass().getClassLoader()
                             .getResource(defaultWebXml).toString());
-                } 
-                if( stream== null ) { 
+                }
+                if( stream== null ) {
                     // maybe embedded
                     stream = getClass().getClassLoader()
                         .getResourceAsStream("web-embed.xml");
@@ -603,9 +595,9 @@
                         source = new InputSource
                         (getClass().getClassLoader()
                                 .getResource("web-embed.xml").toString());
-                    }                                         
+                    }
                 }
-                
+
                 if( stream== null ) {
                     log.info("No default web.xml");
                 }
@@ -616,7 +608,7 @@
                 context.addWatchedResource(file.getAbsolutePath());
             }
         } catch (Exception e) {
-            log.error(sm.getString("contextConfig.defaultMissing") 
+            log.error(sm.getString("contextConfig.defaultMissing")
                       + " " + defaultWebXml + " " + file , e);
         }
 
@@ -634,7 +626,7 @@
 
         String resourceName = getHostConfigPath(Constants.HostWebXml);
         file = new File(getConfigBase(), resourceName);
-        
+
         try {
             if ( ! file.exists() ) {
                 // Use getResource and getResourceAsStream
@@ -651,7 +643,7 @@
                 stream = new FileInputStream(file);
             }
         } catch (Exception e) {
-            log.error(sm.getString("contextConfig.defaultMissing") 
+            log.error(sm.getString("contextConfig.defaultMissing")
                       + " " + resourceName + " " + file , e);
         }
 
@@ -666,27 +658,30 @@
     /**
      * Process a default web.xml.
      */
-    protected void processDefaultWebConfig(Digester digester, InputStream stream, 
+    protected void processDefaultWebConfig(Digester digester, InputStream stream,
             InputSource source) {
 
         if (log.isDebugEnabled())
-            log.debug("Processing context [" + context.getName() 
+            log.debug("Processing context [" + context.getName()
                     + "] web configuration resource " + source.getSystemId());
 
         // Process the default web.xml file
         synchronized (digester) {
             try {
                 source.setByteStream(stream);
-                
+
                 if (context instanceof StandardContext)
                     ((StandardContext) context).setReplaceWelcomeFiles(true);
                 digester.setClassLoader(this.getClass().getClassLoader());
                 digester.setUseContextClassLoader(false);
+                XmlErrorHandler handler = new XmlErrorHandler();
                 digester.push(context);
-                digester.setErrorHandler(new ContextErrorHandler());
+                digester.setErrorHandler(handler);
                 digester.parse(source);
-                if (parseException != null) {
+                if (handler.getWarnings().size() > 0 ||
+                        handler.getErrors().size() > 0) {
                     ok = false;
+                    handler.logFindings(log, source.getSystemId());
                 }
             } catch (SAXParseException e) {
                 log.error(sm.getString("contextConfig.defaultParse"), e);
@@ -699,7 +694,6 @@
                 ok = false;
             } finally {
                 digester.reset();
-                parseException = null;
                 try {
                     if (stream != null) {
                         stream.close();
@@ -716,8 +710,8 @@
      * Process the default configuration file, if it exists.
      */
     protected void contextConfig() {
-        
-        // Open the default web.xml file, if it exists
+
+        // Open the default context.xml file, if it exists
         if( defaultContextXml==null && context instanceof StandardContext ) {
             defaultContextXml = ((StandardContext)context).getDefaultContextXml();
         }
@@ -725,22 +719,26 @@
         if( defaultContextXml==null ) getDefaultContextXml();
 
         if (!context.getOverride()) {
-            processContextConfig(new File(getBaseDir()), defaultContextXml);
+            File defaultContextFile = new File(defaultContextXml);
+            if (!defaultContextFile.isAbsolute()) {
+                defaultContextFile =new File(getBaseDir(), defaultContextXml);
+            }
+            processContextConfig(defaultContextFile.getParentFile(), defaultContextFile.getName());
             processContextConfig(getConfigBase(), getHostConfigPath(Constants.HostContextXml));
         }
         if (context.getConfigFile() != null)
             processContextConfig(new File(context.getConfigFile()), null);
-        
+
     }
 
-    
+
     /**
      * Process a context.xml.
      */
     protected void processContextConfig(File baseDir, String resourceName) {
-        
+
         if (log.isDebugEnabled())
-            log.debug("Processing context [" + context.getName() 
+            log.debug("Processing context [" + context.getName()
                     + "] configuration file " + baseDir + " " + resourceName);
 
         InputSource source = null;
@@ -750,7 +748,7 @@
         if (resourceName != null) {
             file = new File(baseDir, resourceName);
         }
-        
+
         try {
             if ( !file.exists() ) {
                 if (resourceName != null) {
@@ -772,10 +770,10 @@
                 context.addWatchedResource(file.getAbsolutePath());
             }
         } catch (Exception e) {
-            log.error(sm.getString("contextConfig.contextMissing",  
+            log.error(sm.getString("contextConfig.contextMissing",
                       resourceName + " " + file) , e);
         }
-        
+
         if (source == null)
             return;
         synchronized (contextDigester) {
@@ -783,15 +781,18 @@
                 source.setByteStream(stream);
                 contextDigester.setClassLoader(this.getClass().getClassLoader());
                 contextDigester.setUseContextClassLoader(false);
+                XmlErrorHandler handler = new XmlErrorHandler();
                 contextDigester.push(context.getParent());
                 contextDigester.push(context);
-                contextDigester.setErrorHandler(new ContextErrorHandler());
+                contextDigester.setErrorHandler(handler);
                 contextDigester.parse(source);
-                if (parseException != null) {
+                if (handler.getWarnings().size() > 0 ||
+                        handler.getErrors().size() > 0) {
                     ok = false;
+                    handler.logFindings(log, source.getSystemId());
                 }
                 if (log.isDebugEnabled())
-                    log.debug("Successfully processed context [" + context.getName() 
+                    log.debug("Successfully processed context [" + context.getName()
                             + "] configuration file " + baseDir + " " + resourceName);
             } catch (SAXParseException e) {
                 log.error(sm.getString("contextConfig.contextParse",
@@ -806,7 +807,6 @@
                 ok = false;
             } finally {
                 contextDigester.reset();
-                parseException = null;
                 try {
                     if (stream != null) {
                         stream.close();
@@ -818,19 +818,19 @@
         }
     }
 
-    
+
     /**
      * Adjust docBase.
      */
     protected void fixDocBase()
         throws IOException {
-        
+
         Host host = (Host) context.getParent();
         String appBase = host.getAppBase();
 
         boolean unpackWARs = true;
         if (host instanceof StandardHost) {
-            unpackWARs = ((StandardHost) host).isUnpackWARs() 
+            unpackWARs = ((StandardHost) host).isUnpackWARs()
                 && ((StandardContext) context).getUnpackWAR();
         }
 
@@ -838,7 +838,7 @@
         if (canonicalAppBase.isAbsolute()) {
             canonicalAppBase = canonicalAppBase.getCanonicalFile();
         } else {
-            canonicalAppBase = 
+            canonicalAppBase =
                 new File(System.getProperty("catalina.base"), appBase)
                 .getCanonicalFile();
         }
@@ -869,7 +869,7 @@
         }
         file = new File(docBase);
         String origDocBase = docBase;
-        
+
         String pathName = context.getPath();
         if (pathName.equals("")) {
             pathName = "ROOT";
@@ -925,24 +925,20 @@
         context.setDocBase(docBase);
 
     }
-    
-    
-    protected void antiLocking()
-        throws IOException {
 
-        if ((context instanceof StandardContext) 
+
+    protected void antiLocking() throws IOException {
+
+        if ((context instanceof StandardContext)
             && ((StandardContext) context).getAntiResourceLocking()) {
-            
+
             Host host = (Host) context.getParent();
             String appBase = host.getAppBase();
             String docBase = context.getDocBase();
             if (docBase == null)
                 return;
-            if (originalDocBase == null) {
-                originalDocBase = docBase;
-            } else {
-                docBase = originalDocBase;
-            }
+            originalDocBase = docBase;
+
             File docBaseFile = new File(docBase);
             if (!docBaseFile.isAbsolute()) {
                 File file = new File(appBase);
@@ -951,7 +947,7 @@
                 }
                 docBaseFile = new File(file, docBase);
             }
-            
+
             String path = context.getPath();
             if (path == null) {
                 return;
@@ -960,35 +956,36 @@
                 docBase = "ROOT";
             } else {
                 if (path.startsWith("/")) {
-                    docBase = path.substring(1);
+                    docBase = path.substring(1).replace('/','#');
                 } else {
-                    docBase = path;
+                    docBase = path.replace('/','#');
                 }
             }
 
-            File file = null;
-            if (docBase.toLowerCase().endsWith(".war")) {
-                file = new File(System.getProperty("java.io.tmpdir"),
+            if (originalDocBase.toLowerCase().endsWith(".war")) {
+                antiLockingDocBase = new File(
+                        System.getProperty("java.io.tmpdir"),
                         deploymentCount++ + "-" + docBase + ".war");
             } else {
-                file = new File(System.getProperty("java.io.tmpdir"), 
+                antiLockingDocBase = new File(
+                        System.getProperty("java.io.tmpdir"),
                         deploymentCount++ + "-" + docBase);
             }
-            
+            antiLockingDocBase = antiLockingDocBase.getAbsoluteFile();
+
             if (log.isDebugEnabled())
-                log.debug("Anti locking context[" + context.getPath() 
-                        + "] setting docBase to " + file);
-            
+                log.debug("Anti locking context[" + context.getPath()
+                        + "] setting docBase to " +
+                        antiLockingDocBase.getPath());
+
             // Cleanup just in case an old deployment is lying around
-            ExpandWar.delete(file);
-            if (ExpandWar.copy(docBaseFile, file)) {
-                context.setDocBase(file.getAbsolutePath());
+            ExpandWar.delete(antiLockingDocBase);
+            if (ExpandWar.copy(docBaseFile, antiLockingDocBase)) {
+                context.setDocBase(antiLockingDocBase.getPath());
             }
-            
         }
-        
     }
-    
+
 
     /**
      * Process a "init" event for this Context.
@@ -996,11 +993,6 @@
     protected void init() {
         // Called from StandardContext.init()
 
-        if (webDigester == null){
-            webDigester = createWebDigester();
-            webDigester.getParser();
-        }
-        
         if (contextDigester == null){
             contextDigester = createContextDigester();
             contextDigester.getParser();
@@ -1010,33 +1002,34 @@
             log.debug(sm.getString("contextConfig.init"));
         context.setConfigured(false);
         ok = true;
-        
+
         contextConfig();
-        
+
         try {
             fixDocBase();
         } catch (IOException e) {
             log.error(sm.getString(
                     "contextConfig.fixDocBase", context.getPath()), e);
         }
-        
+
+        createWebXmlDigester(context.getXmlNamespaceAware(),
+                context.getXmlValidation());
     }
-    
-    
+
+
     /**
      * Process a "before start" event for this Context.
      */
     protected synchronized void beforeStart() {
-        
+
         try {
             antiLocking();
         } catch (IOException e) {
             log.error(sm.getString("contextConfig.antiLocking"), e);
         }
-        
+
     }
-    
-    
+
     /**
      * Process a "start" event for this Context.
      */
@@ -1046,27 +1039,6 @@
         if (log.isDebugEnabled())
             log.debug(sm.getString("contextConfig.start"));
 
-        // Set properties based on DefaultContext
-        Container container = context.getParent();
-        if( !context.getOverride() ) {
-            if( container instanceof Host ) {
-                // Reset the value only if the attribute wasn't
-                // set on the context.
-                xmlValidation = context.getXmlValidation();
-                if (!xmlValidation) {
-                    xmlValidation = ((Host)container).getXmlValidation();
-                }
-                
-                xmlNamespaceAware = context.getXmlNamespaceAware();
-                if (!xmlNamespaceAware){
-                    xmlNamespaceAware 
-                                = ((Host)container).getXmlNamespaceAware();
-                }
-
-                container = container.getParent();
-            }
-        }
-
         // Process the default and application web.xml files
         defaultWebConfig();
         applicationWebConfig();
@@ -1218,7 +1190,7 @@
         }
         */
 
-        // Removing sercurity role
+        // Removing security role
         String[] securityRoles = context.findSecurityRoles();
         for (i = 0; i < securityRoles.length; i++) {
             context.removeSecurityRole(securityRoles[i]);
@@ -1257,23 +1229,16 @@
         }
 
         // Remove (partially) folders and files created by antiLocking
-        Host host = (Host) context.getParent();
-        String appBase = host.getAppBase();
-        String docBase = context.getDocBase();
-        if ((docBase != null) && (originalDocBase != null)) {
-            File docBaseFile = new File(docBase);
-            if (!docBaseFile.isAbsolute()) {
-                docBaseFile = new File(appBase, docBase);
-            }
+        if (antiLockingDocBase != null) {
             // No need to log failure - it is expected in this case
-            ExpandWar.delete(docBaseFile, false);
+            ExpandWar.delete(antiLockingDocBase, false);
         }
-        
+
         ok = true;
 
     }
-    
-    
+
+
     /**
      * Process a "destroy" event for this Context.
      */
@@ -1287,8 +1252,8 @@
         if (workDir != null)
             ExpandWar.delete(new File(workDir));
     }
-    
-    
+
+
     /**
      * Validate the usage of security role names in the web application
      * deployment descriptor.  If any problems are found, issue warning
@@ -1305,7 +1270,7 @@
             for (int j = 0; j < roles.length; j++) {
                 if (!"*".equals(roles[j]) &&
                     !context.findSecurityRole(roles[j])) {
-                    log.info(sm.getString("contextConfig.role.auth", roles[j]));
+                    log.warn(sm.getString("contextConfig.role.auth", roles[j]));
                     context.addSecurityRole(roles[j]);
                 }
             }
@@ -1317,14 +1282,14 @@
             Wrapper wrapper = (Wrapper) wrappers[i];
             String runAs = wrapper.getRunAs();
             if ((runAs != null) && !context.findSecurityRole(runAs)) {
-                log.info(sm.getString("contextConfig.role.runas", runAs));
+                log.warn(sm.getString("contextConfig.role.runas", runAs));
                 context.addSecurityRole(runAs);
             }
             String names[] = wrapper.findSecurityReferences();
             for (int j = 0; j < names.length; j++) {
                 String link = wrapper.findSecurityReference(names[j]);
                 if ((link != null) && !context.findSecurityRole(link)) {
-                    log.info(sm.getString("contextConfig.role.link", link));
+                    log.warn(sm.getString("contextConfig.role.link", link));
                     context.addSecurityRole(link);
                 }
             }
@@ -1337,16 +1302,16 @@
      * Get config base.
      */
     protected File getConfigBase() {
-        File configBase = 
+        File configBase =
             new File(System.getProperty("catalina.base"), "conf");
         if (!configBase.exists()) {
             return null;
         } else {
             return configBase;
         }
-    }  
+    }
+
 
-    
     protected String getHostConfigPath(String resourceName) {
         StringBuffer result = new StringBuffer();
         Container container = context;
@@ -1370,6 +1335,11 @@
     }
 
 
+    /**
+     * @deprecated Unused. Use {@link XmlErrorHandler}. Will be removed in
+     *             Tomcat 7.0.x
+     */
+    @Deprecated
     protected class ContextErrorHandler
         implements ErrorHandler {
 
@@ -1387,5 +1357,4 @@
 
     }
 
-
 }
--- java/org/apache/catalina/startup/DigesterFactory.java.orig	2014-07-15 15:26:23.973383000 -0400
+++ java/org/apache/catalina/startup/DigesterFactory.java	2014-07-17 17:50:17.058405000 -0400
@@ -28,7 +28,10 @@
  * Wrapper class around the Digester that hide Digester's initialization details
  *
  * @author Jean-Francois Arcand
+ * 
+ * @deprecated Use {@link org.apache.tomcat.util.descriptor.DigesterFactory}
  */
+@Deprecated
 public class DigesterFactory {
     /**
      * The log.
--- java/org/apache/catalina/startup/TldConfig.java.orig	2014-07-15 16:20:44.132388000 -0400
+++ java/org/apache/catalina/startup/TldConfig.java	2014-07-17 17:50:17.066415000 -0400
@@ -5,9 +5,9 @@
  * The ASF licenses this file to You under the Apache License, Version 2.0
  * (the "License"); you may not use this file except in compliance with
  * the License.  You may obtain a copy of the License at
- * 
+ *
  *      http://www.apache.org/licenses/LICENSE-2.0
- * 
+ *
  * Unless required by applicable law or agreed to in writing, software
  * distributed under the License is distributed on an "AS IS" BASIS,
  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
@@ -20,12 +20,8 @@
 
 
 import java.io.File;
-import java.io.FileInputStream;
-import java.io.FileOutputStream;
 import java.io.IOException;
 import java.io.InputStream;
-import java.io.ObjectInputStream;
-import java.io.ObjectOutputStream;
 import java.net.URISyntaxException;
 import java.net.URL;
 import java.net.URLClassLoader;
@@ -47,13 +43,14 @@
 import javax.servlet.ServletException;
 
 import org.apache.catalina.Context;
-import org.apache.catalina.Globals;
 import org.apache.catalina.Lifecycle;
 import org.apache.catalina.LifecycleEvent;
 import org.apache.catalina.LifecycleListener;
 import org.apache.catalina.core.StandardContext;
 import org.apache.catalina.core.StandardHost;
 import org.apache.catalina.util.StringManager;
+import org.apache.tomcat.util.descriptor.DigesterFactory;
+import org.apache.tomcat.util.descriptor.XmlErrorHandler;
 import org.apache.tomcat.util.digester.Digester;
 import org.xml.sax.InputSource;
 
@@ -91,7 +88,12 @@
         noTldJars.add("el-api.jar");
         noTldJars.add("jasper.jar");
         noTldJars.add("jasper-el.jar");
-        noTldJars.add("jasper-jdt.jar");
+        noTldJars.add("ecj-3.7.jar");
+        noTldJars.add("ecj-3.7.1.jar");
+        noTldJars.add("ecj-3.7.2.jar");
+        noTldJars.add("ecj-4.2.1.jar");
+        noTldJars.add("ecj-4.2.2.jar");
+        noTldJars.add("ecj-4.3.1.jar");
         noTldJars.add("jsp-api.jar");
         noTldJars.add("servlet-api.jar");
         noTldJars.add("tomcat-coyote.jar");
@@ -125,14 +127,6 @@
     }
 
 
-    // ----------------------------------------------------- Instance Variables
-
-    /**
-     * The Context we are associated with.
-     */
-    private Context context = null;
-
-
     /**
      * The string resources for this package.
      */
@@ -140,22 +134,51 @@
         StringManager.getManager(Constants.Package);
 
     /**
-     * The <code>Digester</code> we will use to process tag library
-     * descriptor files.
+     * The <code>Digester</code>s available to process tld files.
      */
-    private static Digester tldDigester = null;
+    private static Digester[] tldDigesters = new Digester[2];
+
+    /**
+     * Create (if necessary) and return a Digester configured to process the
+     * tld.
+     */
+    private static Digester createTldDigester(boolean validation,
+            boolean blockExternal) {
+
+        Digester digester = null;
+        if (!validation) {
+            if (tldDigesters[0] == null) {
+                tldDigesters[0] = DigesterFactory.newDigester(validation,
+                        true, new TldRuleSet(), blockExternal);
+                tldDigesters[0].getParser();
+            }
+            digester = tldDigesters[0];
+        } else {
+            if (tldDigesters[1] == null) {
+                tldDigesters[1] = DigesterFactory.newDigester(validation,
+                        true, new TldRuleSet(), blockExternal);
+                tldDigesters[1].getParser();
+            }
+            digester = tldDigesters[1];
+        }
+        return digester;
+    }
+
 
+    // ----------------------------------------------------- Instance Variables
 
     /**
-     * Attribute value used to turn on/off TLD validation
+     * The Context we are associated with.
      */
-     private static boolean tldValidation = false;
+    private Context context = null;
 
 
     /**
-     * Attribute value used to turn on/off TLD  namespace awarenes.
+     * The <code>Digester</code> we will use to process tag library
+     * descriptor files.
      */
-    private static boolean tldNamespaceAware = false;
+    private Digester tldDigester = null;
+
 
     private boolean rescan=true;
 
@@ -166,8 +189,8 @@
     /**
      * Sets the list of JARs that are known not to contain any TLDs.
      *
-     * @param jarNames List of comma-separated names of JAR files that are 
-     * known not to contain any TLDs 
+     * @param jarNames List of comma-separated names of JAR files that are
+     * known not to contain any TLDs
      */
     public static void setNoTldJars(String jarNames) {
         if (jarNames != null) {
@@ -180,41 +203,59 @@
     }
 
     /**
-     * Set the validation feature of the XML parser used when
-     * parsing xml instances.
-     * @param tldValidation true to enable xml instance validation
+     * *.tld are parsed using the TLD validation setting of the associated
+     * context.
+     *
+     * @param tldValidation ignore
+     *
+     * @deprecated This option will be removed in 7.0.x.
      */
+    @Deprecated
     public void setTldValidation(boolean tldValidation){
-        TldConfig.tldValidation = tldValidation;
+        // NO-OP
     }
 
     /**
-     * Get the server.xml &lt;host&gt; attribute's xmlValidation.
+     * *.tld are parsed using the TLD validation setting of the associated
+     * context.
+     *
      * @return true if validation is enabled.
      *
+     * @deprecated This option will be removed in 7.0.x.
      */
+    @Deprecated
     public boolean getTldValidation(){
-        return tldValidation;
+        Context context = getContext();
+        if (context == null) {
+            return false;
+        }
+        return context.getTldValidation();
     }
 
     /**
-     * Get the server.xml &lt;host&gt; attribute's xmlNamespaceAware.
-     * @return true if namespace awarenes is enabled.
+     * *.tld files are always parsed using a namespace aware parser.
+     *
+     * @return Always <code>true</code>
      *
+     * @deprecated This option will be removed in 7.0.x.
      */
+    @Deprecated
     public boolean getTldNamespaceAware(){
-        return tldNamespaceAware;
+        return true;
     }
 
 
     /**
-     * Set the namespace aware feature of the XML parser used when
-     * parsing xml instances.
-     * @param tldNamespaceAware true to enable namespace awareness
+     * *.tld files are always parsed using a namespace aware parser.
+     *
+     * @param tldNamespaceAware ignored
+     *
+     * @deprecated This option will be removed in 7.0.x.
      */
+    @Deprecated
     public void setTldNamespaceAware(boolean tldNamespaceAware){
-        TldConfig.tldNamespaceAware = tldNamespaceAware;
-    }    
+        // NO-OP
+    }
 
 
     public boolean isRescan() {
@@ -255,24 +296,6 @@
     public void execute() throws Exception {
         long t1=System.currentTimeMillis();
 
-        File tldCache=null;
-
-        if (context instanceof StandardContext) {
-            File workDir= (File)
-                ((StandardContext)context).getServletContext().getAttribute(Globals.WORK_DIR_ATTR);
-            //tldCache=new File( workDir, "tldCache.ser");
-        }
-
-        // Option to not rescan
-        if( ! rescan ) {
-            // find the cache
-            if( tldCache!= null && tldCache.exists()) {
-                // just read it...
-                processCache(tldCache);
-                return;
-            }
-        }
-
         /*
          * Acquire the list of TLD resource paths, possibly embedded in JAR
          * files, to be processed
@@ -280,15 +303,6 @@
         Set resourcePaths = tldScanResourcePaths();
         Map jarPaths = getJarPaths();
 
-        // Check to see if we can use cached listeners
-        if (tldCache != null && tldCache.exists()) {
-            long lastModified = getLastModified(resourcePaths, jarPaths);
-            if (lastModified < tldCache.lastModified()) {
-                processCache(tldCache);
-                return;
-            }
-        }
-
         // Scan each accumulated resource path for TLDs to be processed
         Iterator paths = resourcePaths.iterator();
         while (paths.hasNext()) {
@@ -308,18 +322,6 @@
 
         String list[] = getTldListeners();
 
-        if( tldCache!= null ) {
-            log.debug( "Saving tld cache: " + tldCache + " " + list.length);
-            try {
-                FileOutputStream out=new FileOutputStream(tldCache);
-                ObjectOutputStream oos=new ObjectOutputStream( out );
-                oos.writeObject( list );
-                oos.close();
-            } catch( IOException ex ) {
-                ex.printStackTrace();
-            }
-        }
-
         if( log.isDebugEnabled() )
             log.debug( "Adding tld listeners:" + list.length);
         for( int i=0; list!=null && i<list.length; i++ ) {
@@ -335,67 +337,6 @@
 
     // -------------------------------------------------------- Private Methods
 
-    /*
-     * Returns the last modification date of the given sets of resources.
-     *
-     * @param resourcePaths
-     * @param jarPaths
-     *
-     * @return Last modification date
-     */
-    private long getLastModified(Set resourcePaths, Map jarPaths)
-            throws Exception {
-
-        long lastModified = 0;
-
-        Iterator paths = resourcePaths.iterator();
-        while (paths.hasNext()) {
-            String path = (String) paths.next();
-            URL url = context.getServletContext().getResource(path);
-            if (url == null) {
-                log.debug( "Null url "+ path );
-                break;
-            }
-            long lastM = url.openConnection().getLastModified();
-            if (lastM > lastModified) lastModified = lastM;
-            if (log.isDebugEnabled()) {
-                log.debug( "Last modified " + path + " " + lastM);
-            }
-        }
-
-        if (jarPaths != null) {
-            paths = jarPaths.values().iterator();
-            while (paths.hasNext()) {
-                File jarFile = (File) paths.next();
-                long lastM = jarFile.lastModified();
-                if (lastM > lastModified) lastModified = lastM;
-                if (log.isDebugEnabled()) {
-                    log.debug("Last modified " + jarFile.getAbsolutePath()
-                              + " " + lastM);
-                }
-            }
-        }
-
-        return lastModified;
-    }
-
-    private void processCache(File tldCache ) throws IOException {
-        // read the cache and return;
-        try {
-            FileInputStream in=new FileInputStream(tldCache);
-            ObjectInputStream ois=new ObjectInputStream( in );
-            String list[]=(String [])ois.readObject();
-            if( log.isDebugEnabled() )
-                log.debug("Reusing tldCache " + tldCache + " " + list.length);
-            for( int i=0; list!=null && i<list.length; i++ ) {
-                context.addApplicationListener(list[i]);
-            }
-            ois.close();
-        } catch( ClassNotFoundException ex ) {
-            ex.printStackTrace();
-        }
-    }
-
     /**
      * Scan the JAR file at the specified resource path for TLDs in the
      * <code>META-INF</code> subdirectory, and scan each TLD for application
@@ -463,7 +404,10 @@
                     log.trace("  Processing TLD at '" + name + "'");
                 }
                 try {
-                    tldScanStream(new InputSource(jarFile.getInputStream(entry)));
+                    XmlErrorHandler handler = tldScanStream(
+                            new InputSource(jarFile.getInputStream(entry)));
+                    handler.logFindings(log, "[" + name + "] in [" +
+                            file.getAbsolutePath() + "]");
                 } catch (Exception e) {
                     log.error(sm.getString("contextConfig.tldEntryException",
                                            name, jarPath, context.getPath()),
@@ -495,18 +439,21 @@
      *
      * @exception Exception if an exception occurs while scanning this TLD
      */
-    private void tldScanStream(InputSource resourceStream)
+    private XmlErrorHandler tldScanStream(InputSource resourceStream)
         throws Exception {
 
+        XmlErrorHandler result = new XmlErrorHandler();
+
         synchronized (tldDigester) {
             try {
+                tldDigester.setErrorHandler(result);
                 tldDigester.push(this);
                 tldDigester.parse(resourceStream);
             } finally {
                 tldDigester.reset();
             }
         }
-
+        return result;
     }
 
     /**
@@ -538,13 +485,14 @@
                     (sm.getString("contextConfig.tldResourcePath",
                                   resourcePath));
             }
-            tldScanStream(inputSource);
+            XmlErrorHandler handler = tldScanStream(inputSource);
+            handler.logFindings(log, resourcePath);
         } catch (Exception e) {
              throw new ServletException
                  (sm.getString("contextConfig.tldFileException", resourcePath,
                                context.getPath()),
                   e);
-        } 
+        }
 
     }
 
@@ -609,7 +557,7 @@
      */
     private void tldScanResourcePathsWebInf(DirContext resources,
                                             String rootPath,
-                                            Set tldPaths) 
+                                            Set tldPaths)
             throws IOException {
 
         if (log.isTraceEnabled()) {
@@ -651,7 +599,7 @@
      *
      * The latter constitutes a Tomcat-specific extension to the TLD search
      * order defined in the JSP spec. It allows tag libraries packaged as JAR
-     * files to be shared by web applications by simply dropping them in a 
+     * files to be shared by web applications by simply dropping them in a
      * location that all web applications have access to (e.g.,
      * <CATALINA_HOME>/common/lib).
      *
@@ -676,12 +624,12 @@
                     // This is definitely not as clean as using JAR URLs either
                     // over file or the custom jndi handler, but a lot less
                     // buggy overall
-                    
+
                     // Check that the URL is using file protocol, else ignore it
                     if (!"file".equals(urls[i].getProtocol())) {
                         continue;
                     }
-                    
+
                     File file = null;
                     try {
                         file = new File(urls[i].toURI());
@@ -731,7 +679,7 @@
             log.error(sm.getString("tldConfig.cce", event.getLifecycle()), e);
             return;
         }
-        
+
         if (event.getType().equals(Lifecycle.INIT_EVENT)) {
             init();
         } else if (event.getType().equals(Lifecycle.START_EVENT)) {
@@ -745,30 +693,22 @@
             listeners.clear();
         }
     }
-    
+
     private void init() {
         if (tldDigester == null){
             // (1)  check if the attribute has been defined
             //      on the context element.
-            setTldValidation(context.getTldValidation());
-            setTldNamespaceAware(context.getTldNamespaceAware());
-    
+            boolean tldValidation = context.getTldValidation();
+
             // (2) if the attribute wasn't defined on the context
             //     try the host.
             if (!tldValidation) {
-              setTldValidation(
-                      ((StandardHost) context.getParent()).getXmlValidation());
-            }
-    
-            if (!tldNamespaceAware) {
-              setTldNamespaceAware(
-                      ((StandardHost) context.getParent()).getXmlNamespaceAware());
+                tldValidation =
+                        ((StandardHost) context.getParent()).getXmlValidation();
             }
 
-            tldDigester = DigesterFactory.newDigester(tldValidation, 
-                    tldNamespaceAware, 
-                    new TldRuleSet());
-            tldDigester.getParser();
+            tldDigester = createTldDigester(context.getTldValidation(),
+                    context.getXmlBlockExternal());
         }
     }
 }
--- java/org/apache/jasper/Constants.java.orig	2014-07-15 16:28:27.456960000 -0400
+++ java/org/apache/jasper/Constants.java	2014-07-17 17:50:17.074406000 -0400
@@ -205,4 +205,21 @@
         System.getProperty("org.apache.catalina.SESSION_PARAMETER_NAME",
                 "jsessionid");
 
+    /**
+     * Name of the ServletContext init-param that determines if the XML parsers
+     * used for *.tld files will be validating or not.
+     * <p>
+     * This must be kept in sync with org.apache.catalina.Globals
+     */
+    public static final String XML_VALIDATION_TLD_INIT_PARAM =
+            "org.apache.jasper.XML_VALIDATE_TLD";
+
+    /**
+     * Name of the ServletContext init-param that determines if the XML parsers
+     * will block the resolution of external entities.
+     * <p>
+     * This must be kept in sync with org.apache.catalina.Globals
+     */
+    public static final String XML_BLOCK_EXTERNAL_INIT_PARAM =
+            "org.apache.jasper.XML_BLOCK_EXTERNAL";
 }
--- java/org/apache/jasper/JspC.java.orig	2014-07-15 15:26:24.008411000 -0400
+++ java/org/apache/jasper/JspC.java	2014-07-17 17:50:17.081408000 -0400
@@ -19,14 +19,16 @@
 
 import java.io.BufferedReader;
 import java.io.CharArrayWriter;
+import java.io.EOFException;
 import java.io.File;
 import java.io.FileInputStream;
 import java.io.FileNotFoundException;
 import java.io.FileOutputStream;
-import java.io.FileReader;
-import java.io.FileWriter;
 import java.io.IOException;
+import java.io.InputStreamReader;
+import java.io.OutputStreamWriter;
 import java.io.PrintWriter;
+import java.io.Reader;
 import java.io.Writer;
 import java.net.MalformedURLException;
 import java.net.URL;
@@ -51,7 +53,8 @@
 import org.apache.juli.logging.LogFactory;
 
 import org.apache.tools.ant.AntClassLoader;
-import org.apache.tools.ant.Project;
+import org.apache.tools.ant.BuildException;
+import org.apache.tools.ant.Task;
 import org.apache.tools.ant.util.FileUtils;
 
 /**
@@ -64,20 +67,17 @@
  *
  * It can be used as an Ant task using:
  * <pre>
- *   &lt;taskdef classname="org.apache.jasper.JspC" name="jasper2" &gt;
+ *   &lt;taskdef classname="org.apache.jasper.JspC" name="jasper" &gt;
  *      &lt;classpath&gt;
  *          &lt;pathelement location="${java.home}/../lib/tools.jar"/&gt;
- *          &lt;fileset dir="${ENV.CATALINA_HOME}/server/lib"&gt;
- *              &lt;include name="*.jar"/&gt;
- *          &lt;/fileset&gt;
- *          &lt;fileset dir="${ENV.CATALINA_HOME}/common/lib"&gt;
+ *          &lt;fileset dir="${ENV.CATALINA_HOME}/lib"&gt;
  *              &lt;include name="*.jar"/&gt;
  *          &lt;/fileset&gt;
  *          &lt;path refid="myjars"/&gt;
  *       &lt;/classpath&gt;
  *  &lt;/taskdef&gt;
  *
- *  &lt;jasper2 verbose="0"
+ *  &lt;jasper verbose="0"
  *           package="my.package"
  *           uriroot="${webapps.dir}/${webapp.name}"
  *           webXmlFragment="${build.dir}/generated_web.xml"
@@ -89,7 +89,7 @@
  * @author Costin Manolache
  * @author Yoav Shapira
  */
-public class JspC implements Options {
+public class JspC extends Task implements Options {
 
     public static final String DEFAULT_IE_CLASS_ID =
             "clsid:8AD9C840-044E-11D1-B3E9-00805F499D93";
@@ -112,6 +112,8 @@
     protected static final String SWITCH_FILE_WEBAPP = "-webapp";
     protected static final String SWITCH_WEBAPP_INC = "-webinc";
     protected static final String SWITCH_WEBAPP_XML = "-webxml";
+    protected static final String SWITCH_WEBAPP_XML_ENCODING = "-webxmlencoding";
+    protected static final String SWITCH_ADD_WEBAPP_XML_MAPPINGS = "-addwebxmlmappings";
     protected static final String SWITCH_MAPPED = "-mapped";
     protected static final String SWITCH_XPOWERED_BY = "-xpoweredBy";
     protected static final String SWITCH_TRIM_SPACES = "-trimSpaces";
@@ -121,7 +123,8 @@
     protected static final String SWITCH_ENCODING = "-javaEncoding";
     protected static final String SWITCH_SMAP = "-smap";
     protected static final String SWITCH_DUMP_SMAP = "-dumpsmap";
-
+    protected static final String SWITCH_VALIDATE_TLD = "-validateTld";
+    protected static final String SWITCH_BLOCK_EXTERNAL = "-blockExternal";
     protected static final String SHOW_SUCCESS ="-s";
     protected static final String LIST_ERRORS = "-l";
     protected static final int INC_WEBXML = 10;
@@ -141,6 +144,8 @@
     protected URLClassLoader loader = null;
     protected boolean trimSpaces = false;
     protected boolean genStringAsCharArray = false;
+    protected boolean validateTld;
+    protected boolean blockExternal;
     protected boolean xpoweredBy;
     protected boolean mappedFile = false;
     protected boolean poolingEnabled = true;
@@ -150,7 +155,6 @@
     protected String targetClassName;
     protected String uriBase;
     protected String uriRoot;
-    protected Project project;
     protected int dieLevel;
     protected boolean helpNeeded = false;
     protected boolean compile = false;
@@ -198,6 +202,7 @@
     // Generation of web.xml fragments
     protected String webxmlFile;
     protected int webxmlLevel;
+    protected String webxmlEncoding;
     protected boolean addWebXmlMappings = false;
 
     protected Writer mapout;
@@ -234,8 +239,8 @@
         if (arg.length == 0) {
             System.out.println(Localizer.getMessage("jspc.usage"));
         } else {
+            JspC jspc = new JspC();
             try {
-                JspC jspc = new JspC();
                 jspc.setArgs(arg);
                 if (jspc.helpNeeded) {
                     System.out.println(Localizer.getMessage("jspc.usage"));
@@ -247,10 +252,21 @@
                 if (die != NO_DIE_LEVEL) {
                     System.exit(die);
                 }
+            } catch (BuildException je) {
+                System.err.println(je);
+                if (jspc.dieLevel != NO_DIE_LEVEL) {
+                    System.exit(jspc.dieLevel);
+                }
             }
         }
     }
 
+    /**
+     * Apply command-line arguments.
+     * 
+     * @param arg
+     *            The arguments
+     */
     public void setArgs(String[] arg) throws JasperException {
         args = arg;
         String tok;
@@ -292,6 +308,10 @@
                 if (webxmlFile != null) {
                     webxmlLevel = ALL_WEBXML;
                 }
+            } else if (tok.equals(SWITCH_WEBAPP_XML_ENCODING)) {
+                setWebXmlEncoding(nextArg());
+            } else if (tok.equals(SWITCH_ADD_WEBAPP_XML_MAPPINGS)) {
+                setAddWebXmlMappings(true);
             } else if (tok.equals(SWITCH_MAPPED)) {
                 mappedFile = true;
             } else if (tok.equals(SWITCH_XPOWERED_BY)) {
@@ -334,6 +354,10 @@
                 smapSuppressed = false;
             } else if (tok.equals(SWITCH_DUMP_SMAP)) {
                 smapDumped = true;
+            } else if (tok.equals(SWITCH_VALIDATE_TLD)) {
+                setValidateTld(true);
+            } else if (tok.equals(SWITCH_BLOCK_EXTERNAL)) {
+                setBlockExternal(true);
             } else {
                 if (tok.startsWith("-")) {
                     throw new JasperException("Unrecognized option: " + tok +
@@ -357,60 +381,101 @@
         }
     }
 
+    /**
+     * In JspC this always returns <code>true</code>.
+     * {@inheritDoc}
+     */
     public boolean getKeepGenerated() {
         // isn't this why we are running jspc?
         return true;
     }
 
+    /**
+     * {@inheritDoc}
+     */
     public boolean getTrimSpaces() {
         return trimSpaces;
     }
 
+    /**
+     * Sets the option to trim white spaces between directives or actions.
+     */
     public void setTrimSpaces(boolean ts) {
         this.trimSpaces = ts;
     }
 
+    /**
+     * {@inheritDoc}
+     */
     public boolean isPoolingEnabled() {
         return poolingEnabled;
     }
 
+    /**
+     * Sets the option to enable the tag handler pooling.
+     */
     public void setPoolingEnabled(boolean poolingEnabled) {
         this.poolingEnabled = poolingEnabled;
     }
 
+    /**
+     * {@inheritDoc}
+     */
     public boolean isXpoweredBy() {
         return xpoweredBy;
     }
 
+    /**
+     * Sets the option to enable generation of X-Powered-By response header.
+     */
     public void setXpoweredBy(boolean xpoweredBy) {
         this.xpoweredBy = xpoweredBy;
     }
 
+    /**
+     * In JspC this always returns <code>true</code>.
+     * {@inheritDoc}
+     */
     public boolean getDisplaySourceFragment() {
         return true;
     }
-    
+
+    /**
+     * {@inheritDoc}
+     */
     public boolean getErrorOnUseBeanInvalidClassAttribute() {
         return errorOnUseBeanInvalidClassAttribute;
     }
 
+    /**
+     * Sets the option to issue a compilation error if the class attribute
+     * specified in useBean action is invalid.
+     */
     public void setErrorOnUseBeanInvalidClassAttribute(boolean b) {
         errorOnUseBeanInvalidClassAttribute = b;
     }
 
+    /**
+     * @deprecated Removed in Tomcat 7
+     */
+    @Deprecated
     public int getTagPoolSize() {
         return Constants.MAX_POOL_SIZE;
     }
 
     /**
-     * Are we supporting HTML mapped servlets?
+     * {@inheritDoc}
      */
     public boolean getMappedFile() {
         return mappedFile;
     }
 
-    // Off-line compiler, no need for security manager
+    /**
+     * @deprecated Removed in Tomcat 7
+     */
+    @Deprecated
     public Object getProtectionDomain() {
+        // Off-line compiler, no need for security manager
         return null;
     }
 
@@ -422,23 +487,31 @@
         return true;
     }
 
+    /**
+     * Sets the option to include debug information in compiled class.
+     */
     public void setClassDebugInfo( boolean b ) {
         classDebugInfo=b;
     }
 
+    /**
+     * {@inheritDoc}
+     */
     public boolean getClassDebugInfo() {
         // compile with debug info
         return classDebugInfo;
     }
 
-     /**
-      * @see Options#isCaching()
+    /**
+     * {@inheritDoc}
      */
     public boolean isCaching() {
         return caching;
     }
 
     /**
+     * Sets the option to enable caching.
+     * 
      * @see Options#isCaching()
      */
     public void setCaching(boolean caching) {
@@ -446,57 +519,71 @@
     }
 
     /**
-     * @see Options#getCache()
+     * {@inheritDoc}
      */
     public Map getCache() {
         return cache;
     }
 
     /**
-     * Background compilation check intervals in seconds
+     * In JspC this always returns <code>0</code>.
+     * {@inheritDoc}
      */
     public int getCheckInterval() {
         return 0;
     }
 
     /**
-     * Modification test interval.
+     * In JspC this always returns <code>0</code>.
+     * {@inheritDoc}
      */
     public int getModificationTestInterval() {
         return 0;
     }
 
+
+    /**
+     * In JspC this always returns <code>false</code>.
+     * {@inheritDoc}
+     */
+    public boolean getRecompileOnFail() {
+        return false;
+    }
+    
+    
     /**
-     * Is Jasper being used in development mode?
+     * In JspC this always returns <code>false</code>.
+     * {@inheritDoc}
      */
     public boolean getDevelopment() {
         return false;
     }
 
     /**
-     * Is the generation of SMAP info for JSR45 debuggin suppressed?
+     * {@inheritDoc}
      */
     public boolean isSmapSuppressed() {
         return smapSuppressed;
     }
 
     /**
-     * Set smapSuppressed flag.
+     * Sets smapSuppressed flag.
      */
     public void setSmapSuppressed(boolean smapSuppressed) {
         this.smapSuppressed = smapSuppressed;
     }
 
-    
     /**
-     * Should SMAP info for JSR45 debugging be dumped to a file?
+     * {@inheritDoc}
      */
     public boolean isSmapDumped() {
         return smapDumped;
     }
 
     /**
-     * Set smapSuppressed flag.
+     * Sets smapDumped flag.
+     * 
+     * @see Options#isSmapDumped()
      */
     public void setSmapDumped(boolean smapDumped) {
         this.smapDumped = smapDumped;
@@ -515,10 +602,7 @@
     }
 
     /**
-     * Indicates whether text strings are to be generated as char arrays.
-     *
-     * @return true if text strings are to be generated as char arrays, false
-     * otherwise
+     * {@inheritDoc}
      */
     public boolean genStringAsCharArray() {
         return genStringAsCharArray;
@@ -526,81 +610,105 @@
 
     /**
      * Sets the class-id value to be sent to Internet Explorer when using
-     * <jsp:plugin> tags.
-     *
-     * @param ieClassId Class-id value
+     * &lt;jsp:plugin&gt; tags.
+     * 
+     * @param ieClassId
+     *            Class-id value
      */
     public void setIeClassId(String ieClassId) {
         this.ieClassId = ieClassId;
     }
 
     /**
-     * Gets the class-id value that is sent to Internet Explorer when using
-     * <jsp:plugin> tags.
-     *
-     * @return Class-id value
+     * {@inheritDoc}
      */
     public String getIeClassId() {
         return ieClassId;
     }
 
+    /**
+     * {@inheritDoc}
+     */
     public File getScratchDir() {
         return scratchDir;
     }
 
+    /**
+     * @deprecated Removed in Tomcat 7
+     */
+    @Deprecated
     public Class getJspCompilerPlugin() {
        // we don't compile, so this is meanlingless
         return null;
     }
 
+    /**
+     * @deprecated Removed in Tomcat 7
+     */
+    @Deprecated
     public String getJspCompilerPath() {
        // we don't compile, so this is meanlingless
         return null;
     }
 
     /**
-     * Compiler to use.
+     * {@inheritDoc}
      */
     public String getCompiler() {
         return compiler;
     }
 
+    /**
+     * Sets the option to determine what compiler to use.
+     * 
+     * @see Options#getCompiler()
+     */
     public void setCompiler(String c) {
         compiler=c;
     }
 
     /**
-     * Compiler class name to use.
+     * {@inheritDoc}
      */
     public String getCompilerClassName() {
         return null;
     }
-    
+
     /**
-     * @see Options#getCompilerTargetVM
+     * {@inheritDoc}
      */
     public String getCompilerTargetVM() {
         return compilerTargetVM;
     }
 
+    /**
+     * Sets the compiler target VM.
+     * 
+     * @see Options#getCompilerTargetVM()
+     */
     public void setCompilerTargetVM(String vm) {
         compilerTargetVM = vm;
     }
 
     /**
-     * @see Options#getCompilerSourceVM()
+     * {@inheritDoc}
      */
      public String getCompilerSourceVM() {
          return compilerSourceVM;
      }
-        
-    /**
-     * @see Options#getCompilerSourceVM()
-     */
+
+     /**
+      * Sets the compiler source VM.
+      * 
+      * @see Options#getCompilerSourceVM()
+      */
     public void setCompilerSourceVM(String vm) {
         compilerSourceVM = vm;
     }
 
+    /**
+     * {@inheritDoc}
+     */
     public TldLocationsCache getTldLocationsCache() {
         return tldLocationsCache;
     }
@@ -625,16 +733,26 @@
         javaEncoding = encodingName;
     }
 
+    /**
+     * {@inheritDoc}
+     */
     public boolean getFork() {
         return false;
     }
 
+    /**
+     * {@inheritDoc}
+     */
     public String getClassPath() {
         if( classPath != null )
             return classPath;
         return System.getProperty("java.class.path");
     }
 
+    /**
+     * Sets the classpath used while compiling the servlets generated from JSP
+     * files
+     */
     public void setClassPath(String s) {
         classPath=s;
     }
@@ -666,27 +784,8 @@
     }
 
     /**
-     * Sets the project.
-     *
-     * @param theProject The project
-     */
-    public void setProject(final Project theProject) {
-        project = theProject;
-    }
-
-    /**
-     * Returns the project: may be null if not running
-     * inside an Ant project.
-     *
-     * @return The project
-     */
-    public Project getProject() {
-        return project;
-    }
-
-    /**
      * Base dir for the webapp. Used to generate class names and resolve
-     * includes
+     * includes.
      */
     public void setUriroot( String s ) {
         if( s==null ) {
@@ -744,8 +843,20 @@
         }
     }
 
-    public void setValidateXml( boolean b ) {
-        org.apache.jasper.xmlparser.ParserUtils.validating=b;
+    public void setValidateTld( boolean b ) {
+        this.validateTld = b;
+    }
+
+    public boolean isValidateTld() {
+        return validateTld;
+    }
+    
+    public void setBlockExternal( boolean b ) {
+        this.blockExternal = b;
+    }
+
+    public boolean isBlockExternal() {
+        return blockExternal;
     }
 
     public void setListErrors( boolean b ) {
@@ -760,6 +871,9 @@
         }
     }
 
+    /**
+     * Sets the package name to be used for the generated servlet classes.
+     */
     public void setPackage( String p ) {
         targetPackage=p;
     }
@@ -789,32 +903,73 @@
         webxmlLevel=ALL_WEBXML;
     }
 
+    /**
+     * Sets the encoding to be used to read and write web.xml files.
+     * 
+     * <p>
+     * If not specified, defaults to the platform default encoding.
+     * </p>
+     * 
+     * @param encoding
+     *            Encoding, e.g. "UTF-8".
+     */
+    public void setWebXmlEncoding(String encoding) {
+        webxmlEncoding = encoding;
+    }
+
+    /**
+     * Sets the option to merge generated web.xml fragment into the
+     * WEB-INF/web.xml file of the web application that we were processing.
+     * 
+     * @param b
+     *            <code>true</code> to merge the fragment into the existing
+     *            web.xml file of the processed web application
+     *            ({uriroot}/WEB-INF/web.xml), <code>false</code> to keep the
+     *            generated web.xml fragment
+     */
     public void setAddWebXmlMappings(boolean b) {
         addWebXmlMappings = b;
     }
 
     /**
-     * Set the option that throws an exception in case of a compilation error.
+     * Sets the option that throws an exception in case of a compilation error.
      */
     public void setFailOnError(final boolean b) {
         failOnError = b;
     }
 
+    /**
+     * Returns true if an exception will be thrown in case of a compilation
+     * error.
+     */
     public boolean getFailOnError() {
         return failOnError;
     }
 
     /**
-     * Obtain JSP configuration informantion specified in web.xml.
+     * {@inheritDoc}
      */
     public JspConfig getJspConfig() {
         return jspConfig;
     }
 
+    /**
+     * {@inheritDoc}
+     */
     public TagPluginManager getTagPluginManager() {
         return tagPluginManager;
     }
 
+    /**
+     * Adds servlet declaration and mapping for the JSP page servlet to the
+     * generated web.xml fragment.
+     * 
+     * @param file
+     *            Context-relative path to the JSP file, e.g.
+     *            <code>/index.jsp</code>
+     * @param clctxt
+     *            Compilation context of the servlet
+     */
     public void generateWebMapping( String file, JspCompilationContext clctxt )
         throws IOException
     {
@@ -863,72 +1018,67 @@
         String insertEndMarker =
             Localizer.getMessage("jspc.webinc.insertEnd");
 
-        BufferedReader reader = new BufferedReader(new FileReader(webXml));
-        BufferedReader fragmentReader =
-            new BufferedReader(new FileReader(webxmlFile));
-        PrintWriter writer = new PrintWriter(new FileWriter(webXml2));
+        BufferedReader reader = new BufferedReader(openWebxmlReader(webXml));
+        BufferedReader fragmentReader = new BufferedReader(
+                openWebxmlReader(new File(webxmlFile)));
+        PrintWriter writer = new PrintWriter(openWebxmlWriter(webXml2));
 
         // Insert the <servlet> and <servlet-mapping> declarations
-        int pos = -1;
-        String line = null;
-        while (true) {
-            line = reader.readLine();
-            if (line == null) {
-                break;
-            }
-            // Skip anything previously generated by JSPC
-            if (line.indexOf(insertStartMarker) >= 0) {
-                while (true) {
-                    line = reader.readLine();
-                    if (line == null) {
-                        return;
+        boolean inserted = false;
+        int current = reader.read();
+        while (current > -1) {
+            if (current == '<') {
+                String element = getElement(reader);
+                boolean found = false;
+                if (!inserted) {
+                    for (String before : insertBefore) {
+                        if (element.equals(before)) {
+                            found = true;
+                            break;
+                        }
                     }
-                    if (line.indexOf(insertEndMarker) >= 0) {
-                        line = reader.readLine();
-                        line = reader.readLine();
+                }
+                if (found) {
+                    // Insert generated content here
+                    writer.println(insertStartMarker);
+                    while (true) {
+                        String line = fragmentReader.readLine();
                         if (line == null) {
-                            return;
+                            writer.println();
+                            break;
                         }
-                        break;
+                        writer.println(line);
+                    }
+                    writer.println(insertEndMarker);
+                    writer.println();
+                    writer.write(element);
+                    inserted = true;
+                } else if (element.equals(insertStartMarker)) {
+                    // Skip the previous auto-generated content
+                    while (true) {
+                        current = reader.read();
+                        if (current < 0) {
+                            throw new EOFException();
+                        }
+                        if (current == '<') {
+                            element = getElement(reader);
+                            if (element.equals(insertEndMarker)) {
+                                break;
+                            }
+                        }
+                    }
+                    current = reader.read();
+                    while (current == '\n' || current == '\r') {
+                        current = reader.read();
                     }
+                    continue;
+                } else {
+                    writer.write(element);
                 }
-            }
-            for (int i = 0; i < insertBefore.length; i++) {
-                pos = line.indexOf(insertBefore[i]);
-                if (pos >= 0)
-                    break;
-            }
-            if (pos >= 0) {
-                writer.print(line.substring(0, pos));
-                break;
             } else {
-                writer.println(line);
-            }
-        }
-
-        writer.println(insertStartMarker);
-        while (true) {
-            String line2 = fragmentReader.readLine();
-            if (line2 == null) {
-                writer.println();
-                break;
-            }
-            writer.println(line2);
-        }
-        writer.println(insertEndMarker);
-        writer.println();
-
-        for (int i = 0; i < pos; i++) {
-            writer.print(" ");
-        }
-        writer.println(line.substring(pos));
-
-        while (true) {
-            line = reader.readLine();
-            if (line == null) {
-                break;
+                writer.write(current);
             }
-            writer.println(line);
+            current = reader.read();
         }
         writer.close();
 
@@ -955,6 +1105,43 @@
 
     }
 
+
+    /*
+     * Assumes valid xml
+     */
+    private String getElement(Reader reader) throws IOException {
+        StringBuilder result = new StringBuilder();
+        result.append('<');
+        
+        boolean done = false;
+        
+        while (!done) {
+            int current = reader.read();
+            while (current != '>') {
+                if (current < 0) {
+                    throw new EOFException();
+                }
+                result.append((char) current);
+                current = reader.read();
+            }
+            result.append((char) current);
+            
+            int len = result.length();
+            if (len > 4 && result.substring(0, 4).equals("<!--")) {
+                // This is a comment - make sure we are at the end
+                if (len >= 7 && result.substring(len - 3, len).equals("-->")) {
+                    done = true;
+                }
+            } else {
+                done = true;
+            }
+        }
+        
+        
+        return result.toString();
+    }
+
+
     protected void processFile(String file)
         throws JasperException
     {
@@ -1091,7 +1278,8 @@
      *
      * @throws JasperException If an error occurs
      */
-    public void execute() throws JasperException {
+    @Override
+    public void execute() {
         if(log.isDebugEnabled()) {
             log.debug("execute() starting for " + pages.size() + " pages.");
         }
@@ -1166,7 +1354,7 @@
             }
 
         } catch (IOException ioe) {
-            throw new JasperException(ioe);
+            throw new BuildException(ioe);
 
         } catch (JasperException je) {
             Throwable rootCause = je;
@@ -1177,7 +1365,7 @@
             if (rootCause != je) {
                 rootCause.printStackTrace();
             }
-            throw je;
+            throw new BuildException(je);
         } finally {
             if (loader != null) {
                 LogFactory.release(loader);
@@ -1208,8 +1396,7 @@
     protected void initWebXml() {
         try {
             if (webxmlLevel >= INC_WEBXML) {
-                File fmapings = new File(webxmlFile);
-                mapout = new FileWriter(fmapings);
+                mapout = openWebxmlWriter(new File(webxmlFile));
                 servletout = new CharArrayWriter();
                 mappingout = new CharArrayWriter();
             } else {
@@ -1257,6 +1444,13 @@
         } catch (MalformedURLException me) {
             System.out.println("**" + me);
         }
+        if (isValidateTld()) {
+            context.setInitParameter(Constants.XML_VALIDATION_TLD_INIT_PARAM, "true");
+        }
+        if (isBlockExternal()) {
+            context.setInitParameter(Constants.XML_BLOCK_EXTERNAL_INIT_PARAM, "true");
+        }
+
         rctxt = new JspRuntimeContext(context, this);
         jspConfig = new JspConfig(context);
         tagPluginManager = new TagPluginManager(context);
@@ -1421,4 +1615,26 @@
              return FileUtils.newFileUtils().resolveFile(getProject().getBaseDir(), s);
          }
      }
+
+    private Reader openWebxmlReader(File file) throws IOException {
+        FileInputStream fis = new FileInputStream(file);
+        try {
+            return webxmlEncoding != null ? new InputStreamReader(fis,
+                    webxmlEncoding) : new InputStreamReader(fis);
+        } catch (IOException ex) {
+            fis.close();
+            throw ex;
+        }
+    }
+
+    private Writer openWebxmlWriter(File file) throws IOException {
+        FileOutputStream fos = new FileOutputStream(file);
+        try {
+            return webxmlEncoding != null ? new OutputStreamWriter(fos,
+                    webxmlEncoding) : new OutputStreamWriter(fos);
+        } catch (IOException ex) {
+            fos.close();
+            throw ex;
+        }
+    }
 }
--- java/org/apache/jasper/compiler/ImplicitTagLibraryInfo.java.orig	2014-07-15 15:26:24.016400000 -0400
+++ java/org/apache/jasper/compiler/ImplicitTagLibraryInfo.java	2014-07-17 17:50:17.089401000 -0400
@@ -5,9 +5,9 @@
  * The ASF licenses this file to You under the Apache License, Version 2.0
  * (the "License"); you may not use this file except in compliance with
  * the License.  You may obtain a copy of the License at
- * 
+ *
  *      http://www.apache.org/licenses/LICENSE-2.0
- * 
+ *
  * Unless required by applicable law or agreed to in writing, software
  * distributed under the License is distributed on an "AS IS" BASIS,
  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
@@ -24,11 +24,13 @@
 import java.util.Set;
 import java.util.Vector;
 
+import javax.servlet.ServletContext;
 import javax.servlet.jsp.tagext.FunctionInfo;
 import javax.servlet.jsp.tagext.TagFileInfo;
 import javax.servlet.jsp.tagext.TagInfo;
 import javax.servlet.jsp.tagext.TagLibraryInfo;
 
+import org.apache.jasper.Constants;
 import org.apache.jasper.JasperException;
 import org.apache.jasper.JspCompilationContext;
 import org.apache.jasper.xmlparser.ParserUtils;
@@ -36,7 +38,7 @@
 
 /**
  * Class responsible for generating an implicit tag library containing tag
- * handlers corresponding to the tag files in "/WEB-INF/tags/" or a 
+ * handlers corresponding to the tag files in "/WEB-INF/tags/" or a
  * subdirectory of it.
  *
  * @author Jan Luehe
@@ -107,7 +109,7 @@
                      * of the "imaginary" <tag-file> element
                      */
                     String suffix = path.endsWith(TAG_FILE_SUFFIX) ?
-                            TAG_FILE_SUFFIX : TAGX_FILE_SUFFIX; 
+                            TAG_FILE_SUFFIX : TAGX_FILE_SUFFIX;
                     String tagName = path.substring(path.lastIndexOf("/") + 1);
                     tagName = tagName.substring(0,
                             tagName.lastIndexOf(suffix));
@@ -117,13 +119,27 @@
                     try {
                         in = ctxt.getResourceAsStream(path);
                         if (in != null) {
-                            
+
                             // Add implicit TLD to dependency list
                             if (pi != null) {
                                 pi.addDependant(path);
                             }
-                            
-                            ParserUtils pu = new ParserUtils();
+
+                            ServletContext servletContext = ctxt.getServletContext();
+                            boolean validate = Boolean.parseBoolean(
+                                    servletContext.getInitParameter(
+                                            Constants.XML_VALIDATION_TLD_INIT_PARAM));
+                            String blockExternalString =
+                                    servletContext.getInitParameter(
+                                            Constants.XML_BLOCK_EXTERNAL_INIT_PARAM);
+                            boolean blockExternal;
+                            if (blockExternalString == null) {
+                                blockExternal = Constants.IS_SECURITY_ENABLED;
+                            } else {
+                                blockExternal = Boolean.parseBoolean(blockExternalString);
+                            }
+
+                            ParserUtils pu = new ParserUtils(validate, blockExternal);
                             TreeNode tld = pu.parseXMLDocument(uri, in);
 
                             if (tld.findAttribute("version") != null) {
@@ -169,8 +185,8 @@
                     }
                 }
             }
-        }        
-        
+        }
+
     }
 
     /**
--- java/org/apache/jasper/compiler/JspConfig.java.orig	2014-07-15 15:26:24.024401000 -0400
+++ java/org/apache/jasper/compiler/JspConfig.java	2014-07-17 17:50:17.095405000 -0400
@@ -5,9 +5,9 @@
  * The ASF licenses this file to You under the Apache License, Version 2.0
  * (the "License"); you may not use this file except in compliance with
  * the License.  You may obtain a copy of the License at
- * 
+ *
  *      http://www.apache.org/licenses/LICENSE-2.0
- * 
+ *
  * Unless required by applicable law or agreed to in writing, software
  * distributed under the License is distributed on an "AS IS" BASIS,
  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
@@ -24,6 +24,7 @@
 
 import javax.servlet.ServletContext;
 
+import org.apache.jasper.Constants;
 import org.apache.jasper.JasperException;
 import org.apache.jasper.xmlparser.ParserUtils;
 import org.apache.jasper.xmlparser.TreeNode;
@@ -50,11 +51,11 @@
     private ServletContext ctxt;
     private volatile boolean initialized = false;
 
-    private String defaultIsXml = null;		// unspecified
+    private final static String defaultIsXml = null;		// unspecified
     private String defaultIsELIgnored = null;	// unspecified
-    private String defaultIsScriptingInvalid = null;
+    private final static String defaultIsScriptingInvalid = null;
     private String defaultDeferedSyntaxAllowedAsLiteral = null;
-    private String defaultTrimDirectiveWhitespaces = null;
+    private final static String defaultTrimDirectiveWhitespaces = null;
     private JspProperty defaultJspProperty;
 
     public JspConfig(ServletContext ctxt) {
@@ -85,16 +86,31 @@
 
             is = uri.openStream();
             InputSource ip = new InputSource(is);
-            ip.setSystemId(uri.toExternalForm()); 
+            ip.setSystemId(uri.toExternalForm());
+
+            boolean validate = Boolean.parseBoolean(
+                    ctxt.getInitParameter(Constants.XML_VALIDATION_TLD_INIT_PARAM));
+            String blockExternalString =
+                    ctxt.getInitParameter(Constants.XML_BLOCK_EXTERNAL_INIT_PARAM);
+            boolean blockExternal;
+            if (blockExternalString == null) {
+                blockExternal = Constants.IS_SECURITY_ENABLED;
+            } else {
+                blockExternal = Boolean.parseBoolean(blockExternalString);
+            }
 
-            ParserUtils pu = new ParserUtils();
+            ParserUtils pu = new ParserUtils(validate, blockExternal);
             TreeNode webApp = pu.parseXMLDocument(WEB_XML, ip);
 
             if (webApp == null
                     || getVersion(webApp) < 2.4) {
                 defaultIsELIgnored = "true";
+                defaultDeferedSyntaxAllowedAsLiteral = "true";
                 return;
             }
+            if (getVersion(webApp) < 2.5) {
+                defaultDeferedSyntaxAllowedAsLiteral = "true";
+            }
             TreeNode jspConfig = webApp.findChild("jsp-config");
             if (jspConfig == null) {
                 return;
@@ -223,7 +239,8 @@
                     defaultJspProperty = new JspProperty(defaultIsXml,
                             defaultIsELIgnored,
                             defaultIsScriptingInvalid,
-                            null, null, null, defaultDeferedSyntaxAllowedAsLiteral, 
+                            null, null, null,
+                            defaultDeferedSyntaxAllowedAsLiteral,
                             defaultTrimDirectiveWhitespaces);
                     initialized = true;
                 }
@@ -276,7 +293,7 @@
 
         init();
 
-        // JSP Configuration settings do not apply to tag files	    
+        // JSP Configuration settings do not apply to tag files
         if (jspProperties == null || uri.endsWith(".tag")
                 || uri.endsWith(".tagx")) {
             return defaultJspProperty;
@@ -397,7 +414,7 @@
         }
 
         return new JspProperty(isXml, isELIgnored, isScriptingInvalid,
-                pageEncoding, includePreludes, includeCodas, 
+                pageEncoding, includePreludes, includeCodas,
                 isDeferedSyntaxAllowedAsLiteral, isTrimDirectiveWhitespaces);
     }
 
@@ -487,7 +504,7 @@
         public JspProperty(String isXml, String elIgnored,
                 String scriptingInvalid, String pageEncoding,
                 Vector includePrelude, Vector includeCoda,
-                String deferedSyntaxAllowedAsLiteral, 
+                String deferedSyntaxAllowedAsLiteral,
                 String trimDirectiveWhitespaces) {
 
             this.isXml = isXml;
@@ -523,11 +540,11 @@
         public Vector getIncludeCoda() {
             return includeCoda;
         }
-        
+
         public String isDeferedSyntaxAllowedAsLiteral() {
             return deferedSyntaxAllowedAsLiteral;
         }
-        
+
         public String isTrimDirectiveWhitespaces() {
             return trimDirectiveWhitespaces;
         }
--- java/org/apache/jasper/compiler/JspDocumentParser.java.orig	2014-07-15 15:26:24.033406000 -0400
+++ java/org/apache/jasper/compiler/JspDocumentParser.java	2014-07-17 17:50:17.102406000 -0400
@@ -5,9 +5,9 @@
  * The ASF licenses this file to You under the Apache License, Version 2.0
  * (the "License"); you may not use this file except in compliance with
  * the License.  You may obtain a copy of the License at
- * 
+ *
  *      http://www.apache.org/licenses/LICENSE-2.0
- * 
+ *
  * Unless required by applicable law or agreed to in writing, software
  * distributed under the License is distributed on an "AS IS" BASIS,
  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
@@ -31,17 +31,20 @@
 import javax.xml.parsers.SAXParser;
 import javax.xml.parsers.SAXParserFactory;
 
+import org.apache.jasper.Constants;
 import org.apache.jasper.JasperException;
 import org.apache.jasper.JspCompilationContext;
+import org.apache.tomcat.util.descriptor.DigesterFactory;
+import org.apache.tomcat.util.descriptor.LocalResolver;
 import org.xml.sax.Attributes;
 import org.xml.sax.InputSource;
 import org.xml.sax.Locator;
 import org.xml.sax.SAXException;
 import org.xml.sax.SAXParseException;
 import org.xml.sax.XMLReader;
-import org.xml.sax.ext.LexicalHandler;
+import org.xml.sax.ext.DefaultHandler2;
+import org.xml.sax.ext.EntityResolver2;
 import org.xml.sax.helpers.AttributesImpl;
-import org.xml.sax.helpers.DefaultHandler;
 
 /**
  * Class implementing a parser for a JSP document, that is, a JSP page in XML
@@ -52,19 +55,14 @@
  */
 
 class JspDocumentParser
-    extends DefaultHandler
-    implements LexicalHandler, TagConstants {
+    extends DefaultHandler2
+    implements TagConstants {
 
     private static final String JSP_VERSION = "version";
     private static final String LEXICAL_HANDLER_PROPERTY =
         "http://xml.org/sax/properties/lexical-handler";
     private static final String JSP_URI = "http://java.sun.com/JSP/Page";
 
-    private static final EnableDTDValidationException ENABLE_DTD_VALIDATION_EXCEPTION =
-        new EnableDTDValidationException(
-            "jsp.error.enable_dtd_validation",
-            null);
-
     private ParserController parserController;
     private JspCompilationContext ctxt;
     private PageInfo pageInfo;
@@ -78,7 +76,7 @@
      * Outermost (in the nesting hierarchy) node whose body is declared to be
      * scriptless. If a node's body is declared to be scriptless, all its
      * nested nodes must be scriptless, too.
-     */ 
+     */
     private Node scriptlessBodyNode;
 
     private Locator locator;
@@ -99,6 +97,7 @@
     private boolean inDTD;
 
     private boolean isValidating;
+    private final EntityResolver2 entityResolver;
 
     private ErrorDispatcher err;
     private boolean isTagFile;
@@ -110,8 +109,6 @@
     // Flag set to delay incrmenting tagDependentNesting until jsp:body
     // is first encountered
     private boolean tagDependentPending = false;
-    // Tag being parsed that should have an empty body 
-    private Node tagEmptyBody = null;
 
     /*
      * Constructor
@@ -129,6 +126,20 @@
         this.isTagFile = isTagFile;
         this.directivesOnly = directivesOnly;
         this.isTop = true;
+
+        String blockExternalString = ctxt.getServletContext().getInitParameter(
+                Constants.XML_BLOCK_EXTERNAL_INIT_PARAM);
+        boolean blockExternal;
+        if (blockExternalString == null) {
+            blockExternal = Constants.IS_SECURITY_ENABLED;
+        } else {
+            blockExternal = Boolean.parseBoolean(blockExternalString);
+        }
+
+        this.entityResolver = new LocalResolver(
+                DigesterFactory.SERVLET_API_PUBLIC_IDS,
+                DigesterFactory.SERVLET_API_SYSTEM_IDS,
+                blockExternal);
     }
 
     /*
@@ -247,11 +258,34 @@
         }
     }
 
+
+    @Override
+    public InputSource getExternalSubset(String name, String baseURI)
+            throws SAXException, IOException {
+        return entityResolver.getExternalSubset(name, baseURI);
+    }
+
+
+
+    @Override
+    public InputSource resolveEntity(String publicId, String systemId)
+            throws SAXException, IOException {
+        return entityResolver.resolveEntity(publicId, systemId);
+    }
+
+
+    @Override
+    public InputSource resolveEntity(String name, String publicId, String baseURI, String systemId)
+            throws SAXException, IOException {
+        return entityResolver.resolveEntity(name, publicId, baseURI, systemId);
+    }
+
+
     /*
      * Receives notification of the start of an element.
      *
      * This method assigns the given tag attributes to one of 3 buckets:
-     * 
+     *
      * - "xmlns" attributes that represent (standard or custom) tag libraries.
      * - "xmlns" attributes that do not represent tag libraries.
      * - all remaining attributes.
@@ -271,8 +305,6 @@
         AttributesImpl nonTaglibAttrs = null;
         AttributesImpl nonTaglibXmlnsAttrs = null;
 
-        checkEmptyBody();
-
         processChars();
 
         checkPrefixes(uri, qName, attrs);
@@ -283,7 +315,7 @@
         }
 
         String currentPrefix = getPrefix(current.getQName());
-        
+
         // jsp:text must not have any subelements
         if (JSP_URI.equals(uri) && TEXT_ACTION.equals(current.getLocalName())
                 && "jsp".equals(currentPrefix)) {
@@ -298,7 +330,7 @@
         if (attrs != null) {
             /*
              * Notice that due to a bug in the underlying SAX parser, the
-             * attributes must be enumerated in descending order. 
+             * attributes must be enumerated in descending order.
              */
             boolean isTaglib = false;
             for (int i = attrs.getLength() - 1; i >= 0; i--) {
@@ -433,10 +465,9 @@
                 if (scriptlessBodyNode == null
                         && bodyType.equalsIgnoreCase(TagInfo.BODY_CONTENT_SCRIPTLESS)) {
                     scriptlessBodyNode = node;
-                } else if (TagInfo.BODY_CONTENT_TAG_DEPENDENT.equalsIgnoreCase(bodyType)) {
+                }
+                else if (TagInfo.BODY_CONTENT_TAG_DEPENDENT.equalsIgnoreCase(bodyType)) {
                     tagDependentPending = true;
-                } else if (TagInfo.BODY_CONTENT_EMPTY.equalsIgnoreCase(bodyType)) {
-                    tagEmptyBody = node;
                 }
             }
         }
@@ -451,7 +482,7 @@
      * invoke this method with chunks of it.  This is a problem when we try
      * to determine if the text contains only whitespaces, or when we are
      * looking for an EL expression string.  Therefore it is necessary to
-     * buffer and concatenate the chunks and process the concatenated text 
+     * buffer and concatenate the chunks and process the concatenated text
      * later (at beginTag and endTag)
      *
      * @param buf The characters
@@ -460,10 +491,7 @@
      *
      * @throws SAXException
      */
-    public void characters(char[] buf, int offset, int len)
-    throws SAXException {
-
-        checkEmptyBody();
+    public void characters(char[] buf, int offset, int len) {
 
         if (charBuffer == null) {
             charBuffer = new StringBuffer();
@@ -622,10 +650,6 @@
     public void endElement(String uri, String localName, String qName)
         throws SAXException {
 
-        if (tagEmptyBody != null) {
-            tagEmptyBody = null;
-        }
-        
         processChars();
 
         if (directivesOnly &&
@@ -677,6 +701,23 @@
             scriptlessBodyNode = null;
         }
 
+        if (current instanceof Node.CustomTag) {
+        	String bodyType = getBodyType((Node.CustomTag) current);
+        	if (TagInfo.BODY_CONTENT_EMPTY.equalsIgnoreCase(bodyType)) {
+        		// Children - if any - must be JSP attributes
+        		Node.Nodes children = current.getBody();
+        		if (children != null && children.size() > 0) {
+        			for (int i = 0; i < children.size(); i++) {
+        				Node child = children.getNode(i);
+        				if (!(child instanceof Node.NamedAttribute)) {
+        					throw new SAXParseException(Localizer.getMessage(
+        							"jasper.error.emptybodycontent.nonempty",
+        							current.qName), locator);
+        				}
+        			}
+        		}
+        	}
+        }
         if (current.getParent() != null) {
             current = current.getParent();
         }
@@ -715,7 +756,6 @@
      */
     public void startCDATA() throws SAXException {
 
-        checkEmptyBody();
         processChars();  // Flush char buffer and remove white spaces
         startMark = new Mark(ctxt, path, locator.getLineNumber(),
                              locator.getColumnNumber());
@@ -748,7 +788,8 @@
     public void startDTD(String name, String publicId, String systemId)
         throws SAXException {
         if (!isValidating) {
-            fatalError(ENABLE_DTD_VALIDATION_EXCEPTION);
+            fatalError(new EnableDTDValidationException(
+                    "jsp.error.enable_dtd_validation", null));
         }
 
         inDTD = true;
@@ -776,7 +817,7 @@
     }
 
     /*
-     * Receives notification of the start of a Namespace mapping. 
+     * Receives notification of the start of a Namespace mapping.
      */
     public void startPrefixMapping(String prefix, String uri)
         throws SAXException {
@@ -785,7 +826,7 @@
         if (directivesOnly && !(JSP_URI.equals(uri))) {
             return;
         }
-        
+
         try {
             taglibInfo = getTaglibInfo(prefix, uri);
         } catch (JasperException je) {
@@ -806,7 +847,7 @@
     }
 
     /*
-     * Receives notification of the end of a Namespace mapping. 
+     * Receives notification of the end of a Namespace mapping.
      */
     public void endPrefixMapping(String prefix) throws SAXException {
 
@@ -1284,7 +1325,8 @@
                             prefix,
                             uri,
                             location,
-                            err);
+                            err,
+                            null);
                     if (ctxt.getOptions().isCaching()) {
                         ctxt.getOptions().getCache().put(uri, result);
                     }
@@ -1398,13 +1440,6 @@
         return "";
     }
 
-    private void checkEmptyBody() throws SAXException {
-        if (tagEmptyBody != null) {
-            throw new SAXParseException(Localizer.getMessage(
-                    "jasper.error.emptybodycontent.nonempty",
-                    tagEmptyBody.qName), locator);
-        }
-    }
     /*
      * Gets SAXParser.
      *
@@ -1420,17 +1455,25 @@
         throws Exception {
 
         SAXParserFactory factory = SAXParserFactory.newInstance();
-        factory.setNamespaceAware(true);
 
+        factory.setNamespaceAware(true);
         // Preserve xmlns attributes
         factory.setFeature(
             "http://xml.org/sax/features/namespace-prefixes",
             true);
+
         factory.setValidating(validating);
-        //factory.setFeature(
-        //    "http://xml.org/sax/features/validation",
-        //    validating);
-        
+        if (validating) {
+            // Enable DTD validation
+            factory.setFeature(
+                    "http://xml.org/sax/features/validation",
+                    true);
+            // Enable schema validation
+            factory.setFeature(
+                    "http://apache.org/xml/features/validation/schema",
+                    true);
+        }
+
         // Configure the parser
         SAXParser saxParser = factory.newSAXParser();
         XMLReader xmlReader = saxParser.getXMLReader();
@@ -1450,6 +1493,12 @@
         EnableDTDValidationException(String message, Locator loc) {
             super(message, loc);
         }
+
+        @Override
+        public synchronized Throwable fillInStackTrace() {
+            // This class does not provide a stack trace
+            return this;
+        }
     }
 
     private static String getBodyType(Node.CustomTag custom) {
--- java/org/apache/jasper/compiler/TagLibraryInfoImpl.java.orig	2014-07-15 15:26:24.042405000 -0400
+++ java/org/apache/jasper/compiler/TagLibraryInfoImpl.java	2014-07-17 17:50:17.108408000 -0400
@@ -5,9 +5,9 @@
  * The ASF licenses this file to You under the Apache License, Version 2.0
  * (the "License"); you may not use this file except in compliance with
  * the License.  You may obtain a copy of the License at
- * 
+ *
  *      http://www.apache.org/licenses/LICENSE-2.0
- * 
+ *
  * Unless required by applicable law or agreed to in writing, software
  * distributed under the License is distributed on an "AS IS" BASIS,
  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
@@ -33,6 +33,7 @@
 import java.util.jar.JarFile;
 import java.util.zip.ZipEntry;
 
+import javax.servlet.ServletContext;
 import javax.servlet.jsp.tagext.FunctionInfo;
 import javax.servlet.jsp.tagext.PageData;
 import javax.servlet.jsp.tagext.TagAttributeInfo;
@@ -45,6 +46,7 @@
 import javax.servlet.jsp.tagext.ValidationMessage;
 import javax.servlet.jsp.tagext.VariableInfo;
 
+import org.apache.jasper.Constants;
 import org.apache.jasper.JasperException;
 import org.apache.jasper.JspCompilationContext;
 import org.apache.jasper.xmlparser.ParserUtils;
@@ -54,7 +56,7 @@
 
 /**
  * Implementation of the TagLibraryInfo class from the JSP spec.
- * 
+ *
  * @author Anil K. Vijendran
  * @author Mandar Raje
  * @author Pierre Delisle
@@ -67,7 +69,7 @@
     private Log log = LogFactory.getLog(TagLibraryInfoImpl.class);
 
     private JspCompilationContext ctxt;
-    
+
     private PageInfo pi;
 
     private ErrorDispatcher err;
@@ -130,8 +132,9 @@
     /**
      * Constructor.
      */
-    public TagLibraryInfoImpl(JspCompilationContext ctxt, ParserController pc, PageInfo pi,
-            String prefix, String uriIn, String[] location, ErrorDispatcher err)
+    public TagLibraryInfoImpl(JspCompilationContext ctxt, ParserController pc,
+            PageInfo pi, String prefix, String uriIn, String[] location,
+            ErrorDispatcher err, Mark mark)
             throws JasperException {
         super(prefix, uriIn);
 
@@ -157,7 +160,7 @@
                         throw new FileNotFoundException(location[0]);
                     }
                 } catch (FileNotFoundException ex) {
-                    err.jspError("jsp.error.file.not.found", location[0]);
+                    err.jspError(mark, "jsp.error.file.not.found", location[0]);
                 }
 
                 parseTLD(ctxt, location[0], in, null);
@@ -179,7 +182,7 @@
                     in = jarFile.getInputStream(jarEntry);
                     parseTLD(ctxt, location[0], in, jarFileUrl);
                 } catch (Exception ex) {
-                    err.jspError("jsp.error.tld.unable_to_read", location[0],
+                    err.jspError(mark, "jsp.error.tld.unable_to_read", location[0],
                             location[1], ex.toString());
                 }
             }
@@ -204,7 +207,7 @@
         Collection coll = pi.getTaglibs();
         return (TagLibraryInfo[]) coll.toArray(new TagLibraryInfo[0]);
     }
-    
+
     /*
      * @param ctxt The JSP compilation context @param uri The TLD's uri @param
      * in The TLD's input stream @param jarFileUrl The JAR file containing the
@@ -216,8 +219,20 @@
         Vector tagFileVector = new Vector();
         Hashtable functionTable = new Hashtable();
 
+        ServletContext servletContext = ctxt.getServletContext();
+        boolean validate = Boolean.parseBoolean(servletContext.getInitParameter(
+                        Constants.XML_VALIDATION_TLD_INIT_PARAM));
+        String blockExternalString = servletContext.getInitParameter(
+                Constants.XML_BLOCK_EXTERNAL_INIT_PARAM);
+        boolean blockExternal;
+        if (blockExternalString == null) {
+            blockExternal = Constants.IS_SECURITY_ENABLED;
+        } else {
+            blockExternal = Boolean.parseBoolean(blockExternalString);
+        }
+
         // Create an iterator over the child elements of our <taglib> element
-        ParserUtils pu = new ParserUtils();
+        ParserUtils pu = new ParserUtils(validate, blockExternal);
         TreeNode tld = pu.parseXMLDocument(uri, in);
 
         // Check to see if the <taglib> root element contains a 'version'
@@ -301,7 +316,7 @@
 
     /*
      * @param uri The uri of the TLD @param ctxt The compilation context
-     * 
+     *
      * @return String array whose first element denotes the path to the TLD. If
      * the path to the TLD points to a jar file, then the second element denotes
      * the name of the TLD entry in the jar file, which is hardcoded to
@@ -438,11 +453,11 @@
     /*
      * Parses the tag file directives of the given TagFile and turns them into a
      * TagInfo.
-     * 
+     *
      * @param elem The <tag-file> element in the TLD @param uri The location of
      * the TLD, in case the tag file is specified relative to it @param jarFile
      * The JAR file, in case the tag file is packaged in a JAR
-     * 
+     *
      * @return TagInfo correspoding to tag file directives
      */
     private TagFileInfo createTagFileInfo(TreeNode elem, String uri,
@@ -463,8 +478,8 @@
                 // Ignore <example> element: Bugzilla 33538
             } else if ("tag-extension".equals(tname)) {
                 // Ignore <tag-extension> element: Bugzilla 33538
-            } else if ("icon".equals(tname) 
-                    || "display-name".equals(tname) 
+            } else if ("icon".equals(tname)
+                    || "display-name".equals(tname)
                     || "description".equals(tname)) {
                 // Ignore these elements: Bugzilla 38015
             } else {
@@ -583,7 +598,7 @@
             // translation time) the type is fixed at java.lang.String.
             type = "java.lang.String";
         }
-        
+
         return new TagAttributeInfo(name, required, type, rtexprvalue,
                 isFragment, null, deferredValue, deferredMethod, expectedType,
                 methodSignature);
@@ -735,7 +750,7 @@
 
     /**
      * The instance (if any) for the TagLibraryValidator class.
-     * 
+     *
      * @return The TagLibraryValidator instance, if any.
      */
     public TagLibraryValidator getTagLibraryValidator() {
@@ -746,7 +761,7 @@
      * Translation-time validation of the XML document associated with the JSP
      * page. This is a convenience method on the associated TagLibraryValidator
      * class.
-     * 
+     *
      * @param thePage
      *            The JSP page object
      * @return A string indicating whether the page is valid or not.
--- java/org/apache/jasper/compiler/TagPluginManager.java.orig	2014-07-15 15:26:24.050430000 -0400
+++ java/org/apache/jasper/compiler/TagPluginManager.java	2014-07-17 17:50:17.114413000 -0400
@@ -5,9 +5,9 @@
  * The ASF licenses this file to You under the Apache License, Version 2.0
  * (the "License"); you may not use this file except in compliance with
  * the License.  You may obtain a copy of the License at
- * 
+ *
  *      http://www.apache.org/licenses/LICENSE-2.0
- * 
+ *
  * Unless required by applicable law or agreed to in writing, software
  * distributed under the License is distributed on an "AS IS" BASIS,
  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
@@ -21,6 +21,7 @@
 import java.io.*;
 import javax.servlet.ServletContext;
 
+import org.apache.jasper.Constants;
 import org.apache.jasper.JasperException;
 import org.apache.jasper.xmlparser.ParserUtils;
 import org.apache.jasper.xmlparser.TreeNode;
@@ -65,7 +66,7 @@
         });
 
     }
- 
+
     private void init(ErrorDispatcher err) throws JasperException {
 	if (initialized)
 	    return;
@@ -74,8 +75,18 @@
 	if (is == null)
 	    return;
 
-	TreeNode root = (new ParserUtils()).parseXMLDocument(TAG_PLUGINS_XML,
-							     is);
+    String blockExternalString = ctxt.getInitParameter(
+            Constants.XML_BLOCK_EXTERNAL_INIT_PARAM);
+    boolean blockExternal;
+    if (blockExternalString == null) {
+        blockExternal = Constants.IS_SECURITY_ENABLED;
+    } else {
+        blockExternal = Boolean.parseBoolean(blockExternalString);
+    }
+
+    ParserUtils pu = new ParserUtils(false, blockExternal);
+
+	TreeNode root = pu.parseXMLDocument(TAG_PLUGINS_XML, is);
 	if (root == null) {
 	    return;
 	}
@@ -118,7 +129,7 @@
     }
 
     /**
-     * Invoke tag plugin for the given custom tag, if a plugin exists for 
+     * Invoke tag plugin for the given custom tag, if a plugin exists for
      * the custom tag's tag handler.
      *
      * The given custom tag node will be manipulated by the plugin.
@@ -221,7 +232,7 @@
         }
 
         public void generateBody() {
-            // Since we'll generate the body anyway, this is really a nop, 
+            // Since we'll generate the body anyway, this is really a nop,
             // except for the fact that it lets us put the Java sources the
             // plugins produce in the correct order (w.r.t the body).
             curNodes = node.getAtETag();
--- java/org/apache/jasper/compiler/TldLocationsCache.java.orig	2014-07-15 15:26:24.057383000 -0400
+++ java/org/apache/jasper/compiler/TldLocationsCache.java	2014-07-17 17:50:17.121406000 -0400
@@ -5,9 +5,9 @@
  * The ASF licenses this file to You under the Apache License, Version 2.0
  * (the "License"); you may not use this file except in compliance with
  * the License.  You may obtain a copy of the License at
- * 
+ *
  *      http://www.apache.org/licenses/LICENSE-2.0
- * 
+ *
  * Unless required by applicable law or agreed to in writing, software
  * distributed under the License is distributed on an "AS IS" BASIS,
  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
@@ -45,7 +45,7 @@
 /**
  * A container for all tag libraries that are defined "globally"
  * for the web application.
- * 
+ *
  * Tag Libraries can be defined globally in one of two ways:
  *   1. Via <taglib> elements in web.xml:
  *      the uri and location of the tag-library are specified in
@@ -128,7 +128,12 @@
         noTldJars.add("el-api.jar");
         noTldJars.add("jasper.jar");
         noTldJars.add("jasper-el.jar");
-        noTldJars.add("jasper-jdt.jar");
+        noTldJars.add("ecj-3.7.jar");
+        noTldJars.add("ecj-3.7.1.jar");
+        noTldJars.add("ecj-3.7.2.jar");
+        noTldJars.add("ecj-4.2.1.jar");
+        noTldJars.add("ecj-4.2.2.jar");
+        noTldJars.add("ecj-4.3.1.jar");
         noTldJars.add("jsp-api.jar");
         noTldJars.add("servlet-api.jar");
         noTldJars.add("tomcat-coyote.jar");
@@ -160,16 +165,16 @@
         noTldJars.add("tools.jar");
         noTldJars.add("sunpkcs11.jar");
     }
-    
+
     public TldLocationsCache(ServletContext ctxt) {
         this(ctxt, true);
     }
 
-    /** Constructor. 
+    /** Constructor.
      *
-     * @param ctxt the servlet context of the web application in which Jasper 
+     * @param ctxt the servlet context of the web application in which Jasper
      * is running
-     * @param redeployMode if true, then the compiler will allow redeploying 
+     * @param redeployMode if true, then the compiler will allow redeploying
      * a tag library from the same jar, at the expense of slowing down the
      * server a bit. Note that this may only work on JDK 1.3.1_01a and later,
      * because of JDK bug 4211817 fixed in this release.
@@ -185,8 +190,8 @@
     /**
      * Sets the list of JARs that are known not to contain any TLDs.
      *
-     * @param jarNames List of comma-separated names of JAR files that are 
-     * known not to contain any TLDs 
+     * @param jarNames List of comma-separated names of JAR files that are
+     * known not to contain any TLDs
      */
     public static void setNoTldJars(String jarNames) {
         if (jarNames != null) {
@@ -205,7 +210,7 @@
      * in the web application. A tag library is 'exposed' either explicitly in
      * web.xml or implicitly via the uri tag in the TLD of a taglib deployed
      * in a jar file (WEB-INF/lib).
-     * 
+     *
      * @param uri The taglib uri
      *
      * @return An array of two Strings: The first element denotes the real
@@ -221,7 +226,7 @@
         return (String[]) mappings.get(uri);
     }
 
-    /** 
+    /**
      * Returns the type of a URI:
      *     ABS_URI
      *     ROOT_REL_URI
@@ -252,7 +257,7 @@
 
     /*
      * Populates taglib map described in web.xml.
-     */    
+     */
     private void processWebDotXml() throws Exception {
 
         InputStream is = null;
@@ -286,15 +291,29 @@
             }
             is = uri.openStream();
             InputSource ip = new InputSource(is);
-            ip.setSystemId(uri.toExternalForm()); 
+            ip.setSystemId(uri.toExternalForm());
+
+            boolean validate = Boolean.parseBoolean(
+                    ctxt.getInitParameter(
+                            Constants.XML_VALIDATION_TLD_INIT_PARAM));
+            String blockExternalString = ctxt.getInitParameter(
+                    Constants.XML_BLOCK_EXTERNAL_INIT_PARAM);
+            boolean blockExternal;
+            if (blockExternalString == null) {
+                blockExternal = Constants.IS_SECURITY_ENABLED;
+            } else {
+                blockExternal = Boolean.parseBoolean(blockExternalString);
+            }
 
             // Parse the web application deployment descriptor
+            ParserUtils pu = new ParserUtils(validate, blockExternal);
+
             TreeNode webtld = null;
             // altDDName is the absolute path of the DD
             if (altDDName != null) {
-                webtld = new ParserUtils().parseXMLDocument(altDDName, ip);
+                webtld = pu.parseXMLDocument(altDDName, ip);
             } else {
-                webtld = new ParserUtils().parseXMLDocument(WEB_XML, ip);
+                webtld = pu.parseXMLDocument(WEB_XML, ip);
             }
 
             // Allow taglib to be an element of the root or jsp-config (JSP2.0)
@@ -453,11 +472,23 @@
      * Returns the value of the uri element of the given TLD, or null if the
      * given TLD does not contain any such element.
      */
-    private String getUriFromTld(String resourcePath, InputStream in) 
+    private String getUriFromTld(String resourcePath, InputStream in)
         throws JasperException
     {
-        // Parse the tag library descriptor at the specified resource path
-        TreeNode tld = new ParserUtils().parseXMLDocument(resourcePath, in);
+        boolean validate = Boolean.parseBoolean(
+                ctxt.getInitParameter(
+                        Constants.XML_VALIDATION_TLD_INIT_PARAM));
+        String blockExternalString = ctxt.getInitParameter(
+                Constants.XML_BLOCK_EXTERNAL_INIT_PARAM);
+        boolean blockExternal;
+        if (blockExternalString == null) {
+            blockExternal = Constants.IS_SECURITY_ENABLED;
+        } else {
+            blockExternal = Boolean.parseBoolean(blockExternalString);
+        }
+
+        ParserUtils pu = new ParserUtils(validate, blockExternal);
+        TreeNode tld = pu.parseXMLDocument(resourcePath, in);
         TreeNode uri = tld.findChild("uri");
         if (uri != null) {
             String body = uri.getBody();
@@ -471,7 +502,7 @@
     /*
      * Scans all JARs accessible to the webapp's classloader and its
      * parent classloaders for TLDs.
-     * 
+     *
      * The list of JARs always includes the JARs under WEB-INF/lib, as well as
      * all shared JARs in the classloader delegation chain of the webapp's
      * classloader.
@@ -479,7 +510,7 @@
      * Considering JARs in the classloader delegation chain constitutes a
      * Tomcat-specific extension to the TLD search
      * order defined in the JSP spec. It allows tag libraries packaged as JAR
-     * files to be shared by web applications by simply dropping them in a 
+     * files to be shared by web applications by simply dropping them in a
      * location that all web applications have access to (e.g.,
      * <CATALINA_HOME>/common/lib).
      *
--- java/org/apache/jasper/xmlparser/ParserUtils.java.orig	2014-07-15 15:26:24.062402000 -0400
+++ java/org/apache/jasper/xmlparser/ParserUtils.java	2014-07-17 17:50:17.128407000 -0400
@@ -5,16 +5,15 @@
  * The ASF licenses this file to You under the Apache License, Version 2.0
  * (the "License"); you may not use this file except in compliance with
  * the License.  You may obtain a copy of the License at
- * 
+ *
  *      http://www.apache.org/licenses/LICENSE-2.0
- * 
+ *
  * Unless required by applicable law or agreed to in writing, software
  * distributed under the License is distributed on an "AS IS" BASIS,
  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  * See the License for the specific language governing permissions and
  * limitations under the License.
  */
-
 package org.apache.jasper.xmlparser;
 
 import java.io.IOException;
@@ -27,8 +26,9 @@
 import org.apache.jasper.Constants;
 import org.apache.jasper.JasperException;
 import org.apache.jasper.compiler.Localizer;
-import org.apache.juli.logging.Log;
-import org.apache.juli.logging.LogFactory;
+import org.apache.tomcat.util.descriptor.DigesterFactory;
+import org.apache.tomcat.util.descriptor.LocalResolver;
+import org.apache.tomcat.util.descriptor.XmlErrorHandler;
 import org.w3c.dom.Comment;
 import org.w3c.dom.Document;
 import org.w3c.dom.NamedNodeMap;
@@ -36,7 +36,6 @@
 import org.w3c.dom.NodeList;
 import org.w3c.dom.Text;
 import org.xml.sax.EntityResolver;
-import org.xml.sax.ErrorHandler;
 import org.xml.sax.InputSource;
 import org.xml.sax.SAXException;
 import org.xml.sax.SAXParseException;
@@ -48,24 +47,45 @@
  * use a separate class loader for the parser to be used.
  *
  * @author Craig R. McClanahan
- * @version $Revision: 595799 $ $Date: 2007-11-16 21:02:12 +0100 (Fri, 16 Nov 2007) $
+ * @version $Id: ParserUtils.java 1558828 2014-01-16 15:12:59Z markt $
  */
-
 public class ParserUtils {
 
     /**
-     * An error handler for use when parsing XML documents.
+     * An entity resolver for use when parsing XML documents.
      */
-    static ErrorHandler errorHandler = new MyErrorHandler();
+    static EntityResolver entityResolver;
+
+    private final EntityResolver entityResolverInstance;
 
     /**
-     * An entity resolver for use when parsing XML documents.
+     * @deprecated Unused. Will be removed in Tomcat 7.
+     *             Use {@link ParserUtils#ParserUtils(boolean,boolean)} instead.
      */
-    static EntityResolver entityResolver = new MyEntityResolver();
-
-    // Turn off for JSP 2.0 until switch over to using xschema.
+    @Deprecated
     public static boolean validating = false;
 
+    private final boolean useValidation;
+
+    /**
+     * @deprecated Unused. Will be removed in Tomcat 7.
+     *             Use {@link ParserUtils#ParserUtils(boolean,boolean)} instead.
+     */
+    @Deprecated
+    public ParserUtils() {
+        this(true, Constants.IS_SECURITY_ENABLED);
+    }
+
+    public ParserUtils(boolean useValidation, boolean blockExternal) {
+        this.useValidation = useValidation;
+        if (entityResolver == null) {
+            this.entityResolverInstance = new LocalResolver(
+                    DigesterFactory.SERVLET_API_PUBLIC_IDS,
+                    DigesterFactory.SERVLET_API_SYSTEM_IDS, blockExternal);
+        } else {
+            this.entityResolverInstance = entityResolver;
+        }
+    }
 
     // --------------------------------------------------------- Public Methods
 
@@ -73,13 +93,13 @@
      * Parse the specified XML document, and return a <code>TreeNode</code>
      * that corresponds to the root node of the document tree.
      *
-     * @param uri URI of the XML document being parsed
+     * @param location Location (eg URI) of the XML document being parsed
      * @param is Input source containing the deployment descriptor
      *
      * @exception JasperException if an input/output error occurs
      * @exception JasperException if a parsing error occurs
      */
-    public TreeNode parseXMLDocument(String uri, InputSource is)
+    public TreeNode parseXMLDocument(String location, InputSource is)
         throws JasperException {
 
         Document document = null;
@@ -89,27 +109,42 @@
             DocumentBuilderFactory factory =
                 DocumentBuilderFactory.newInstance();
             factory.setNamespaceAware(true);
-            factory.setValidating(validating);
+            factory.setValidating(useValidation);
+            if (useValidation) {
+                // Enable DTD validation
+                factory.setFeature(
+                        "http://xml.org/sax/features/validation",
+                        true);
+                // Enable schema validation
+                factory.setFeature(
+                        "http://apache.org/xml/features/validation/schema",
+                        true);
+            }
             DocumentBuilder builder = factory.newDocumentBuilder();
-            builder.setEntityResolver(entityResolver);
-            builder.setErrorHandler(errorHandler);
+            builder.setEntityResolver(entityResolverInstance);
+            XmlErrorHandler handler = new XmlErrorHandler();
+            builder.setErrorHandler(handler);
             document = builder.parse(is);
+            if (!handler.getErrors().isEmpty()) {
+                // throw the first to indicate there was a error during processing
+                throw handler.getErrors().iterator().next();
+            }
 	} catch (ParserConfigurationException ex) {
             throw new JasperException
-                (Localizer.getMessage("jsp.error.parse.xml", uri), ex);
+                (Localizer.getMessage("jsp.error.parse.xml", location), ex);
 	} catch (SAXParseException ex) {
             throw new JasperException
                 (Localizer.getMessage("jsp.error.parse.xml.line",
-				      uri,
+                      location,
 				      Integer.toString(ex.getLineNumber()),
 				      Integer.toString(ex.getColumnNumber())),
 		 ex);
 	} catch (SAXException sx) {
             throw new JasperException
-                (Localizer.getMessage("jsp.error.parse.xml", uri), sx);
+                (Localizer.getMessage("jsp.error.parse.xml", location), sx);
         } catch (IOException io) {
             throw new JasperException
-                (Localizer.getMessage("jsp.error.parse.xml", uri), io);
+                (Localizer.getMessage("jsp.error.parse.xml", location), io);
 	}
 
         // Convert the resulting document to a graph of TreeNodes
@@ -133,6 +168,17 @@
         return (parseXMLDocument(uri, new InputSource(is)));
     }
 
+    /**
+     * Set the EntityResolver.
+     * This is needed when the dtds and Jasper itself are in different
+     * classloaders (e.g. OSGi environment).
+     *
+     * @param er EntityResolver to use.
+     */
+    public static void setEntityResolver(EntityResolver er) {
+
+        entityResolver = er;
+    }
 
     // ------------------------------------------------------ Protected Methods
 
@@ -176,60 +222,11 @@
                             treeNode.setBody(body);
                     }
                 } else {
-                    TreeNode treeChild = convert(treeNode, child);
+                    convert(treeNode, child);
                 }
             }
         }
-        
         // Return the completed TreeNode graph
         return (treeNode);
     }
 }
-
-
-// ------------------------------------------------------------ Private Classes
-
-class MyEntityResolver implements EntityResolver {
-
-    public InputSource resolveEntity(String publicId, String systemId)
-            throws SAXException {
-        for (int i = 0; i < Constants.CACHED_DTD_PUBLIC_IDS.length; i++) {
-            String cachedDtdPublicId = Constants.CACHED_DTD_PUBLIC_IDS[i];
-            if (cachedDtdPublicId.equals(publicId)) {
-                String resourcePath = Constants.CACHED_DTD_RESOURCE_PATHS[i];
-                InputStream input = this.getClass().getResourceAsStream(
-                        resourcePath);
-                if (input == null) {
-                    throw new SAXException(Localizer.getMessage(
-                            "jsp.error.internal.filenotfound", resourcePath));
-                }
-                InputSource isrc = new InputSource(input);
-                return isrc;
-            }
-        }
-        Log log = LogFactory.getLog(MyEntityResolver.class);
-        if (log.isDebugEnabled())
-            log.debug("Resolve entity failed" + publicId + " " + systemId);
-        log.error(Localizer.getMessage("jsp.error.parse.xml.invalidPublicId",
-                publicId));
-        return null;
-    }
-}
-
-class MyErrorHandler implements ErrorHandler {
-
-    public void warning(SAXParseException ex) throws SAXException {
-        Log log = LogFactory.getLog(MyErrorHandler.class);
-        if (log.isDebugEnabled())
-            log.debug("ParserUtils: warning ", ex);
-        // We ignore warnings
-    }
-
-    public void error(SAXParseException ex) throws SAXException {
-        throw ex;
-    }
-
-    public void fatalError(SAXParseException ex) throws SAXException {
-        throw ex;
-    }
-}
\ No newline at end of file
--- webapps/docs/changelog.xml.orig	2014-07-15 15:26:24.071388000 -0400
+++ webapps/docs/changelog.xml	2014-07-17 17:50:17.138409000 -0400
@@ -1,4 +1,4 @@
-<?xml version="1.0" encoding="ISO-8859-1"?>
+<?xml version="1.0" encoding="UTF-8"?>
 <!--
   Licensed to the Apache Software Foundation (ASF) under one or more
   contributor license agreements.  See the NOTICE file distributed with
@@ -18,6 +18,7 @@
 <!DOCTYPE document [
   <!ENTITY project SYSTEM "project.xml">
 ]>
+<?xml-stylesheet type="text/xsl" href="tomcat-docs.xsl"?>
 <document url="changelog.html">
 
   &project;
@@ -29,84 +30,2629 @@
     <author email="rjung@apache.org">Rainer Jung</author>
     <author email="pero@apache.org">Peter Rossbach</author>
     <author email="kkolinko@apache.org">Konstantin Kolinko</author>
+    <author email="jfclere@apache.org">Jean-Frederic Clere</author>
+    <author email="kfujino@apache.org">Keiichi Fujino</author>
+    <author email="mturk@apache.org">Mladen Turk</author>
+    <author email="timw@apache.org">Tim Whittington</author>
+    <author email="slaurent@apache.org">Sylvain Laurent</author>
+    <author email="schultz@apache.org">Christopher Schultz</author>
     <title>Changelog</title>
   </properties>
 
 <body>
-<section name="Tomcat 6.0.24 (jfclere)">
+<!-- Section names:
+ General, Catalina, Coyote, Jasper, Cluster, Web applications, Other
+-->
+<section name="Tomcat 6.0.39 (markt)">
+  <subsection name="Catalina">
+    <changelog>
+      <fix>
+        <bug>55166</bug>: Fix regression that broke XML validation when running
+        on some Java 5 JVMs. (kkolinko)
+      </fix>
+    </changelog>
+  </subsection>
+  <subsection name="Coyote">
+    <changelog>
+      <fix>
+        Make the HTTP NIO connector tolerant of whitespace in the individual
+        values used for the ciphers attribute. (markt)
+      </fix>
+      <fix>
+        Remove dependency introduced on the jsp-api.jar as part of the XML
+        validation changes introduced in 6.0.38. (markt)
+      </fix>
+    </changelog>
+  </subsection>
+  <subsection name="Jasper">
+    <changelog>
+      <fix>
+        Correct several errors in jspxml Schema and DTD. (kkolinko)
+      </fix>
+    </changelog>
+  </subsection>
+  <subsection name="Cluster">
+    <changelog>
+      <scode>
+        Remove an empty TestTwoPhaseCommit test from Tribes. (kkolinko)
+      </scode>
+    </changelog>
+  </subsection>
+  <subsection name="Web applications">
+    <changelog>
+      <fix>
+        Fix broken link in Jasper How-To documentation. (markt)
+      </fix>
+      <fix>
+        Align index.html and index.jsp in ROOT web application. Correct links
+        to specifications and to the Tomcat mailing lists. (kkolinko)
+      </fix>
+      <fix>
+        Remove second copy of RUNNING.txt from the full-docs distribution. Some
+        unpacking utilities can't handle multiple copies of a file with the same
+        name in a directory. (kkolinko)
+      </fix>
+    </changelog>
+  </subsection>
+  <subsection name="Other">
+    <changelog>
+      <update>
+        Update sample Eclipse IDE project: use JUnit 4 library and prefer a
+        Java 5 JDK when several JDKs are configured. Cleanup the Ant build
+        files. (kkolinko)
+      </update>
+      <fix>
+        Correct Maven dependencies for individual JAR files. (markt)
+      </fix>
+    </changelog>
+  </subsection>
+</section>
+<section name="Tomcat 6.0.38 (markt)"  rtext="not released">
+  <subsection name="Catalina">
+    <changelog>
+      <fix>
+        Ensure that when Tomcat&apos;s anti-resource locking features are used
+        that the temporary copy of the web application and not the original is
+        removed when the web application stops. (markt/kkolinko) 
+      </fix>
+      <fix>
+        <bug>55019</bug>: Fix a potential exception when accessing JSPs while
+        running under a SecurityManager. (jfclere)
+      </fix>
+      <fix>
+        <bug>55052</bug>: Make JULI&apos;s LogManager to additionally look for
+        logging properties without prefixes if the property cannot be found with
+        a prefix. (kkolinko)
+      </fix>
+      <fix>
+        <bug>55266</bug>: Ensure that the session ID is parsed from the request
+        before any redirect as the session ID may need to be encoded as part of
+        the redirect URL. (markt)
+      </fix>
+      <fix>
+        <bug>55404</bug>: Log warnings about using security roles in web.xml as
+        warnings. (markt)
+      </fix>
+      <fix>
+        <bug>55268</bug>: Added optional --service-start-wait-time
+        command-line option to change service start wait time from default
+        of 10 seconds. (schultz)
+      </fix>
+      <fix>
+        Correctly associate the default resource bundle with the English locale
+        so that requests that specify an Accept-Language of English ahead of
+        French, Spanish or Japanese get the English messages they asked for.
+        (markt) 
+      </fix>
+      <fix>
+        Add missing JavaEE 5 XML schema definitions. (markt)
+      </fix>
+      <fix>
+        When Catalina parses TLD files, always use a namespace aware parser to
+        be consistent with how Jasper parses TLD files. The
+        <code>tldNamespaceAware</code> attribute of the Context is now ignored.
+        (markt)
+      </fix>
+      <fix>
+        As per section SRV.14.4.3 of the Servlet 2.5 specification, a namespace
+        aware, validating parser will be used when processing <code>*.tld</code>
+        and <code>web.xml</code> files if the system property
+        <code>org.apache.catalina.STRICT_SERVLET_COMPLIANCE</code> is set to
+        <code>true</code>. (markt) 
+      </fix>
+      <fix>
+        Ensure that sessions IDs are not parsed from URLs for Contexts where
+        <code>disableURLRewriting</code> is <code>true</code>. (markt)
+      </fix>
+      <add>
+        Add an option to the Context to control the blocking of XML external
+        entities when parsing XML configuration files and enable this blocking
+        by default when a security manager is used. The block is implemented via
+        a custom resolver to enable the logging of any blocked entities. (markt)
+      </add>
+      <fix>
+        <bug>56016</bug>: When loading resources for XML schema validation, take
+        account of the possibility that servlet-api.jar and jsp-api.jar may not
+        be loaded by the same class loader. Patch by Juan Carlos Estibariz.
+        (markt)
+      </fix>
+    </changelog>
+  </subsection>
+  <subsection name="Coyote">
+    <changelog>
+      <fix>
+        <bug>52811</bug>: Fix parsing of Content-Type header in
+        <code>HttpServletResponse.setContentType()</code>. Introduces a new HTTP
+        header parser that follows RFC2616. (markt)
+      </fix>
+      <fix>
+        <bug>54691</bug>: Add configuration attribute "sslEnabledProtocols"
+        to HTTP connector and document it. (Internally this attribute has
+        been already implemented but not documented, under names "protocols"
+        and "sslProtocols". Those names of this attribute are now deprecated).
+        (schultz)
+      </fix>
+      <fix>
+        <bug>54947</bug>: Fix the HTTP NIO connector that incorrectly rejected a
+        request if the CRLF terminating the request line was split across
+        multiple packets. Patch by Konstantin Preier. (markt)
+      </fix>
+      <fix>
+        <bug>55228</bug>: Allow web applications to set a HTTP Date header.
+        (markt)
+      </fix>
+      <fix>
+        Better adherence to RFC2616 for content-length headers. (markt)
+      </fix>
+      <fix>
+        Add support for limiting the size of chunk extensions when using chunked
+        encoding. (markt)
+      </fix>
+      <fix>
+        <bug>55749</bug>: Improve the error message when SSLEngine is disabled
+        in the AprLifecycleListener and SSL is configured for an APR/native
+        connector. (markt)
+      </fix>
+      <fix>
+        Avoid possible NPE if a content type is specified without a character set.
+        (markt)
+      </fix>
+    </changelog>
+  </subsection>
+  <subsection name="Jasper">
+    <changelog>
+      <fix>
+        <bug>55198</bug>: Ensure attribute values in tagx files that include EL
+        and quoted XML characters are correctly quoted in the output. (markt)
+      </fix>
+      <fix>
+        <bug>55671</bug>: Consistently use the configuration option name
+        <code>genStringAsCharArray</code> rather than a mixture of
+        <code>genStrAsCharArray</code> and <code>genStringAsCharArray</code> but
+        retain support for <code>genStrAsCharArray</code> as in initialisation
+        parameter for the JSP servlet to retain backwards compatibility with
+        existing configurations. (markt)
+      </fix>
+      <fix>
+        <bug>55691</bug>: Fix <code>javax.el.ArrayELResolver</code> to correctly
+        handle the case where the base object is an array of primitives. (markt)
+      </fix>
+      <fix>
+        <bug>55973</bug>: Fix processing of XML schemas when validation is
+        enabled in Jasper. (kkolinko)
+      </fix>
+    </changelog>
+  </subsection>
+  <subsection name="Web applications">
+    <changelog>
+      <add>
+        Add documentation for
+        <code>o.a.c.tribes.group.interceptors.TcpFailureDetector</code>.
+        (kfujino)
+      </add>
+      <add>
+        Complete the documentation for
+        <code>MessageDispatch15Interceptor</code>. (kfujino)
+      </add>
+      <add>
+        Add to cluster document a description of
+        <code>notifyLifecycleListenerOnFailure</code> and
+        <code>heartbeatBackgroundEnabled</code>. (kfujino)
+      </add>
+      <fix>
+        <bug>55746</bug>: Add documentation on the <code>allRolesMode</code> to
+        the <code>CombinedRealm</code> and <code>LockOutRealm</code>. Patch by
+        Cdric Couralet. (markt)
+      </fix>
+      <fix>
+        Fix the sample configuration of <code>StaticMembershipInterceptor</code>
+        in order to prevent warning log. uniqueId must be 16 bytes. (kfujino)
+      </fix>
+      <fix>
+        <bug>55119</bug>: Avoid CVE-2013-1571 when generating Javadoc. (markt)
+      </fix>
+    </changelog>
+  </subsection>
+  <subsection name="Other">
+    <changelog>
+      <update>
+        Update Maven Central location used to download dependencies at build
+        time to be <code>repo.maven.apache.org</code>. (kkolinko)
+      </update>
+      <fix>
+        <bug>55663</bug>: Minor correction to the wording of the NOTICE files to
+        align them with the
+        <a href="http://www.apache.org/legal/src-headers.html#notice">requirements
+        for NOTICE files</a>. (violetagg)
+      </fix>
+      <fix>
+        Add <code>@since</code> markers to the common annotations classes and
+        fix a few specification compliance issues. (markt)
+      </fix>
+      <update>
+        Update to Eclipse JDT Compiler 4.3.1. (markt)
+      </update>
+      <update>
+        Update the Apache Jakarta JSTL implementation used by the exmaples web
+        application to 1.1.2. (markt)
+      </update>
+    </changelog>
+  </subsection>
+</section>
+<section name="Tomcat 6.0.37 (jfclere)" rtext="released 2013-05-03">
+  <subsection name="Catalina">
+    <changelog>
+      <fix>
+        <bug>52055</bug>: Ensure that filters are recycled. (markt/kkolinko)
+      </fix>
+      <fix>
+        <bug>52184</bug>: Reduce log level for invalid cookies. (markt)
+      </fix>
+      <fix>
+        <bug>53481</bug>: Added support for SSLHonorCipherOrder to allow
+        the server to impose its cipher order on the client. Based on a patch
+        provided by Marcel &#x160;ebek. (schultz)
+      </fix>
+      <fix>
+        <bug>54044</bug>: Correct bug in timestamp cache used by logging
+        (including the access log valve) that meant entries could be made with
+        an earlier timestamp than the true timestamp. (markt) 
+      </fix>
+      <fix>
+        In FormAuthenticator: If it is configured to change Session IDs,
+        do the change before displaying the login form. (kkolinko)
+      </fix>
+      <fix>
+        <bug>54054</bug>: Do not share shell environment variables between
+        multiple instances of the CGI servlet. (markt)
+      </fix>
+      <fix>
+        <bug>54087</bug>: Correctly handle (ignore) invalid If-Modified-Since
+        header rather than throwing an exception. (markt/kkolinko)
+      </fix>
+      <fix>
+        <bug>54220</bug>: Ensure the ErrorReportValve only generates an error
+        report if the error flag on the response has been set. (markt)
+      </fix>
+      <fix>
+        Fix memory leak of servlet instances when running with a
+        SecurityManager and either init() or destroy() methods fail
+        or the servlet is a SingleThreadModel one, and of filter instances
+        if their destroy() method fails with an Error. (kkolinko)
+      </fix>
+      <fix>
+        <bug>54382</bug>: Fix NPE when SSI processing is enabled and an empty
+        SSI directive is present. (markt)
+      </fix>
+      <fix>
+        <bug>54483</bug>: Correct one of the Spanish translations. Based on a
+        suggestion from adinamita. (kkolinko)
+      </fix>
+      <update>
+        <bug>54527</bug>: Synchronize conf/web.xml mime mapping with Tomcat 7.
+        (markt)
+      </update>
+    </changelog>
+  </subsection>
+  <subsection name="Coyote">
+    <changelog>
+      <fix>
+        <bug>54248</bug>: Ensure that byte order marks are swallowed when using
+        a Reader to read a request body with a BOM for those encodings that
+        require byte order marks. (markt)
+      </fix>
+      <fix>
+        <bug>54324</bug>: Allow APR connector to disable TLS compression
+        if OpenSSL supports it. (schultz)
+      </fix>
+      <fix>
+        <bug>54456</bug>: Ensure that if a client aborts a request when sending
+        a chunked request body that this is communicated correctly to the client
+        reading the request body. (markt)
+      </fix>
+      <update>
+        Update the native component of the APR/native connector to 1.1.27 and
+        make that version the recommended minimum version. (kkolinko)
+      </update>
+    </changelog>
+  </subsection>
+  <subsection name="Jasper">
+    <changelog>
+      <fix>
+        <bug>54615</bug>:  Tomcat 6 doesn't build against ecj 4.x (kkolinko)
+      </fix>
+    </changelog>
+  </subsection>
+  <subsection name="Cluster">
+    <changelog>
+      <fix>
+        <bug>54045</bug>: Make sure getMembers() returns available member when
+        TcpFailureDetector works in static cluster. (kfujino)
+      </fix>
+    </changelog>
+  </subsection>
+  <subsection name="Web applications">
+    <changelog>
+      <update>
+        <bug>22278</bug>: Add a commented out sample configuration of
+        <code>RemoteAddrValve</code> to <code>META-INF/context.xml</code>
+        files of the Manager and Host Manager applications. (kkolinko)
+      </update>
+      <fix>
+        <bug>54080</bug>: Clarify documentation for initial value of
+        <code>internalProxies</code> attribute of <code>RemoteIpValve</code>.
+        (schultz/kkolinko)
+      </fix>
+      <fix>
+        <bug>54198</bug>: Clarify that
+        <code>HttpServletResponse.sendError(int)</code> results in an HTML
+        response by default. (markt)
+      </fix>
+      <fix>
+        <bug>54207</bug>: Correct JNDI factory package name in Javadoc for
+        <code>org.apache.naming.java.javaURLContextFactory</code>. (markt)
+      </fix>
+    </changelog>
+  </subsection>
+  <subsection name="Other">
+    <changelog>
+      <update>
+       Add sample Apache Commons Daemon JSVC wrapper script bin/daemon.sh that
+       can be used with /etc/init.d. (kkolinko)
+      </update>
+      <update>
+        In the build configuration: introduce property "tomcat.output" that is
+        used to specify location of the build output directory. This simplifies
+        configuration if someone wants to move the <code>output</code> directory
+        elsewhere (e.g. out of the source tree). (kkolinko)
+      </update>
+      <fix>
+        <bug>54390</bug>: Use 'java_home' on Mac OS X to auto-detect JAVA_HOME.
+        (schultz)
+      </fix>
+      <update>
+        <bug>54601</bug>: Change catalina.sh to consistently use LOGGING_MANAGER
+          variable to configure logging, instead of modifying JAVA_OPTS one.
+          (kkolinko) 
+      </update>
+      <update>
+        <bug>54890</bug>: Update to Apache Commons Daemon 1.0.15. (mturk)
+      </update>
+    </changelog>
+  </subsection>
+</section>
+<section name="Tomcat 6.0.36 (jfclere)" rtext="released 2012-10-19">
+  <subsection name="Catalina">
+    <changelog>
+      <update>
+        <bug>48692</bug>: Provide option to parse
+        <code>application/x-www-form-urlencoded</code> PUT requests. (schultz)
+      </update>
+      <add>
+        <bug>50306</bug>: New StuckThreadDetectionValve to detect requests that
+        take a long time to process, which might indicate that their processing
+        threads are stuck. Based on a patch provided by TomLu. (kkolinko)
+      </add>
+      <fix>
+        <bug>50570</bug>: Enable FIPS mode to be set in AprLifecycleListener.
+        Based upon a patch from Chris Beckey. Note that this mode requires
+        tomcat-native 1.1.23 or later linked to a FIPS-capable OpenSSL library,
+        which one has to build by themselves. (schultz/kkolinko)
+      </fix>
+      <fix>
+        Improve synchronization and error handling in AprLifecycleListener.
+        Do not allow to change SSL options if SSL has already been initialized.
+        (schultz/kkolinko)
+      </fix>
+      <fix>
+        <bug>52225</bug>: Fix ClassCastException when adding an alias for an
+        existing host via JMX. (kkolinko)
+      </fix>
+      <fix>
+        <bug>52293</bug>: Correctly handle the case when
+        <code>antiResourceLocking</code> is enabled at the Context level when
+        <code>unpackWARs</code> is disabled at the Host level. Correctly
+        handle multi-level contexts when <code>antiResourceLocking</code>
+        is enabled. Patch by Justin Miller. (kkolinko)
+      </fix>
+      <fix>
+        Do not throw IllegalArgumentException from parseParameters() call
+        when chunked POST request is too large, but treat it like an IO error.
+        The <code>FailedRequestFilter</code> filter can be used to detect this
+        condition. (kkolinko)
+      </fix>
+      <fix>
+        <bug>52384</bug>: Do not fail with parameter parsing when debug logging
+        is enabled. (kkolinko)
+      </fix>
+      <fix>
+        Do not flag extra '&amp;' characters in parameters as parse errors.
+        (kkolinko)
+      </fix>
+      <fix>
+        <bug>52488</bug>: Correct typos: exipre -> expire. Based on a patch by
+        prockter. (markt)
+      </fix>
+      <fix>
+        Reduce log level for the message about hitting
+        <code>maxParameterCount</code> limit from WARN to INFO.
+        Fix limit comparison to allow exactly <code>maxParameterCount</code>
+        parameters, as documentation says, instead of
+        <code>(maxParameterCount-1)</code>. (kkolinko)
+      </fix>
+      <fix>
+        Slightly improve performance of UDecoder.convert(). Align
+        <code>%2f</code> handling between implementations. (kkolinko)
+      </fix>
+      <add>
+        Add <code>denyStatus</code> attribute to <code>RequestFilterValve</code>
+        (<code>RemoteAddrValve</code>, <code>RemoteHostValve</code> valves).
+        It allows to use different HTTP response code when rejecting denied
+        request. E.g. 404 instead of 403. (kkolinko)
+      </add>
+      <add>
+        Add <code>SetCharacterEncodingFilter</code> (similar to the one
+        contained in the examples web application) to the
+        <code>org.apache.catalina.filters</code> package so that it is
+        available for all web applications. (kkolinko)
+      </add>
+      <add>
+        <bug>52500</bug>: Added configurable mechanism to retrieve user names
+        from X509 client certificates. Based on a patch provided by
+        Michael Furman. (schultz/kkolinko)
+      </add>
+      <fix>
+        <bug>52719</bug>: Fix a theoretical resource leak in the JAR validation
+        that checks for non-permitted classes in web application JARs. (markt)
+      </fix>
+      <fix>
+        <bug>52830</bug>: Correct JNDI lookups when using
+        <code>javax.naming.Name</code> to identify the resource rather than a
+        <code>java.lang.String</code>. (markt)
+      </fix>
+      <add>
+        <bug>52850</bug>: Extend memory leak prevention and detection code to
+        work with IBM as well as Oracle JVMs. Based on a patch provided by
+        Rohit Kelapure. (kkolinko)
+      </add>
+      <add>
+        <bug>52996</bug>: In <code>StandardThreadExecutor</code>:
+        Add the ability to configure a job queue size
+        (<code>maxQueueSize</code> attribute).
+        Add a variant of execute method that allows to specify a timeout for
+        how long we want to try to add something to the queue.
+        Based on a patch by R&#252;diger Pl&#252;m. (kkolinko)
+      </add>
+      <fix>
+        <bug>53047</bug>: If a JDBCRealm or DataSourceRealm is configured for
+        an all roles mode that only requires authorization (and no roles) and no
+        role table or column is defined, don't populate the Principal's roles.
+        (markt/kkolinko)
+      </fix>
+      <fix>
+        <bug>53050</bug>: Fix handling of entropy value when initializing
+        session id generator in session manager. Based on proposal by
+        Andras Rozsa. (kkolinko)
+      </fix>
+      <fix>
+        <bug>53056</bug>: Add APR version number to tcnative version INFO log
+        message. (schultz)
+      </fix>
+      <fix>
+        <bug>53057</bug>: Add OpenSSL version number INFO log message when
+        initializing. (schultz)
+      </fix>
+      <fix>
+        <bug>53071</bug>: Use the message from the Throwable for the error
+        report generated by the <code>ErrorReportValve</code> if none was
+        specified via <code>sendError()</code>. Use the standard text for HTTP
+        error codes. (markt/rjung)
+      </fix>
+      <update>
+        <bug>53230</bug>: Change session managers to throw
+        TooManyActiveSessionsException instead of IllegalStateException
+        when the maximum number of sessions has been exceeded and a new
+        session will not be created. (schultz/kkolinko)
+      </update>
+      <fix>
+        <bug>53267</bug>: Ensure that using the GC Daemon Protection feature of
+        the <code>JreMemoryLeakPreventionListener</code> does not trigger a
+        full GC every hour. (markt/kkolinko)
+      </fix>
+      <fix>
+        <bug>53531</bug>: Fix ExpandWar.expand to check the return value of
+        File.mkdir and File.mkdirs. (schultz)
+      </fix>
+      <fix>
+        Make the CSRF nonce cache in <code>CsrfPreventionFilter</code>
+        serializable so that it can be replicated across a cluster and/or
+        persisted across Tomcat restarts. (markt)
+      </fix>
+      <fix>
+        <bug>53584</bug>: Ignore path parameters when comparing URIs for FORM
+        authentication. This prevents users being prompted twice for passwords
+        when logging in when session IDs are being encoded as path parameters.
+        (markt)
+      </fix>
+      <fix>
+        Various improvements to the DIGEST authenticator including
+        <bug>52954</bug>, the disabling caching of an authenticated user in the
+        session by default, tracking server rather than client nonces and better
+        handling of stale nonce values. (markt)
+      </fix>
+      <fix>
+        CVE-2012-3546: Fix bypass of security constraint checks with FORM
+        authentication. Remove unneeded processing in <code>RealmBase</code>.
+        (kkolinko)
+      </fix>
+      <fix>
+        <bug>53800</bug>: <code>FileDirContext.list()</code> did not provide
+        correct paths for subdirectories. Patch provided by Kevin Wooten.
+        (kkolinko)
+      </fix>
+      <fix>
+        <bug>53830</bug>: Better handling of <code>Manager.randomFile</code>
+        default value on Windows. (kkolinko)
+      </fix>
+      <fix>
+        CVE-2012-4431: Fix bypass of <code>CsrfPreventionFilter</code> when
+        there is no session. Improve session management in the filter.
+        (kkolinko)
+      </fix>
+    </changelog>
+  </subsection>
+  <subsection name="Coyote">
+    <changelog>
+      <fix>
+        <bug>42181</bug>: Better handling of edge conditions in chunk header
+        processing. (kkolinko)
+      </fix>
+      <update>
+        <bug>51477</bug>: Support all SSL protocol combinations in the APR/native
+        connector. This only works when using the native library version 1.1.21
+        or later. (rjung)
+      </update>
+      <fix>
+        <bug>52055</bug> (comment 14): Correctly reset
+        <code>ChunkedInputFilter.needCRLFParse</code> flag when the filter
+        is recycled. (kkolinko)
+      </fix>
+      <fix>
+        <bug>52606</bug>: Ensure replayed POST bodies are available when using
+        AJP. (markt)
+      </fix>
+      <fix>
+        <bug>52858</bug>, CVE-2012-4534: Fix high CPU load with SSL, NIO and
+        sendfile when client breaks the connection before reading all the
+        requested data.
+        (fhanik/kkolinko)
+      </fix>
+      <fix>
+        <bug>53119</bug>: Prevent buffer overflow errors being reported when a
+        client disconnects before the response has been fully written from an
+        AJP connection using the APR/native connector. (kkolinko)
+      </fix>
+      <fix>
+        Improve <code>InternalNioInputBuffer.parseHeaders()</code>. (kkolinko)
+      </fix>
+      <add>
+        Implement <code>maxHeaderCount</code> attribute on Connector.
+        It is equivalent of LimitRequestFields directive of
+        <a href="http://httpd.apache.org/">Apache HTTPD</a>.
+        Default value is 100. (kkolinko)
+      </add>
+      <fix>
+        In JkCoyoteHandler connector for AJP/1.3 protocol
+        (in <code>JkMain.setProperty()</code>):
+        Fix setting of properties when connector has already started for
+        properties that have aliases. E.g. it now allows to change
+        <code>maxHeaderCount</code> attribute on Connector MBean via JMX.
+        (kkolinko)
+      </fix>
+      <fix>
+        <bug>53725</bug>: Fix possible corruption of GZIP'd output. (kkolinko)
+      </fix>
+    </changelog>
+  </subsection>
+  <subsection name="Jasper">
+    <changelog>
+      <fix>
+        <bug>48097</bug> (comment 7), <bug>53366</bug> (comment 1):
+        If JSP page unexpectedly fails to initialize PageContext instance,
+        write exception to the logs instead of silent swallowing. (kkolinko)
+      </fix>
+      <fix>
+        <bug>52335</bug>: Only handle <code>&lt;\%</code> and not
+        <code>\%</code> as escaped in template text. (markt)
+      </fix>
+      <fix>
+        <bug>52666</bug>: Correct coercion order in EL when processing the
+        equality and inequality operators. (markt)
+      </fix>
+      <fix>
+        <bug>53001</bug>: Revert the fix for <bug>46915</bug> since the use case
+        described in the bug is invalid since it breaks the EL specification.
+        (markt)
+      </fix>
+      <fix>
+        <bug>53032</bug>: Modify <code>JspC</code> so it extends
+        <code>org.apache.tools.ant.Task</code> enabling it to work with features
+        such as namespaces within build.xml files. (markt)
+      </fix>
+    </changelog>
+  </subsection>
+  <subsection name="Cluster">
+    <changelog>
+      <fix>
+        Replicate principal in ClusterSingleSignOn. (kfujino)
+      </fix>
+      <fix>
+        <bug>53513</bug>: Fix race condition between the processing of session
+        sync message and transfer complete message. (kfujino)
+      </fix>
+      <fix>
+        <bug>53606</bug>: Fix potential NPE in <code>TcpPingInterceptor</code>.
+        Based on a patch by F. Arnoud. (markt)
+      </fix>
+      <fix>
+        <bug>53607</bug>: To avoid NPE, set TCP PING data to ChannelMessage.
+        Patch provided by F.Arnoud (kfujino)
+      </fix>
+      <fix>
+        Fix a behavior of TcpPingInterceptor#useThread.
+        Do not start a ping thread when useThread is set to false. (kfujino)
+      </fix>
+    </changelog>
+  </subsection>
+  <subsection name="Web applications">
+    <changelog>
+      <fix>
+        <bug>52243</bug>: Improve windows service documentation to clarify how
+        to include <code>#</code> and/or <code>;</code> in the value of an
+        environment variable that is passed to the service. (markt)
+      </fix>
+      <fix>
+        <bug>52515</bug>: Make it clear in the Realm how-to in the documentation
+        web application that digested password storage when using DIGEST
+        authentication requires that MD5 digests are used. (markt)
+      </fix>
+      <fix>
+        <bug>52641</bug>: Remove mentioning of ldap.jar from docs.
+        Patch provided by Felix Schumacher. (rjung)
+      </fix>
+      <fix>
+        Remove obsolete bug warning from windows service
+        documentation page. (rjung)
+      </fix>
+      <fix>
+        <bug>52983</bug>: Remove unnecessary code that makes switching to
+        other authentication methods difficult. (markt)
+      </fix>
+      <fix>
+        <bug>53158</bug>: Fix documented defaults for DBCP.
+        Patch provided by ph.dezanneau at gmail.com. (rjung)
+      </fix>
+      <update>
+        Update JavaSE documentation links to point to the current
+        docs.oracle.com site, instead of obsolete ones (download.oracle.com,
+        java.sun.com). (kkolinko)
+      </update>
+      <update>
+        <bug>53289</bug>: Clarify <code>ResourceLink</code> example that
+        uses DataSource.getConnection(username, password) method. Not all
+        data source implementations support it. (kkolinko)
+      </update>
+      <fix>
+        Prevent the custom error pages for the Manager and Host Manager
+        applications from being accessed directly. Configure custom
+        pages for error codes 401 and 403 in Host Manager application.
+        (markt/kkolinko)
+      </fix>
+      <fix>
+        Correct documentation for <code>enableLookups</code> attribute
+        of a Connector. By default DNS lookups are disabled. (kkolinko)
+      </fix>
+      <fix>
+        Fix several HTML markup errors in servlets of examples web application.
+        (kkolinko)
+      </fix>
+      <update>
+        Change the index page of ROOT webapp to mention "manager-gui" role
+        instead of "manager" one. (kkolinko)
+      </update>
+      <fix>
+        <bug>53473</bug>: Correct the allowed values for the SSI option
+        <code>isVirtualWebappRelative</code> which are <code>true</code> or
+        <code>false</code>. (markt)
+      </fix>
+      <fix>
+        <bug>53664</bug>: Minor JNDI Howto document enhancement concerning mail
+        properties. Patch provided by Mark Eggers. (schultz)
+      </fix>
+      <fix>
+        <bug>53601</bug>: Clarify that to build Apache Tomcat 6 from sources
+        a Java 5 JDK is recommended. (kkolinko)
+      </fix>
+      <fix>
+        <bug>53793</bug>: Change links on the list of applications in the
+        Manager to point to <code>/appname/</code> instead of
+        <code>/appname</code>. (kkolinko)
+      </fix>
+    </changelog>
+  </subsection>
+  <subsection name="Other">
+    <changelog>
+      <fix>
+        <bug>49402</bug>, <bug>52124</bug>: Fix Maven publishing script:
+        make sure it finds tomcat-juli.jar and use later version of
+        wagon-ssh. (jfclere)
+      </fix>
+      <fix>
+        Update Apache Commons Daemon to 1.0.10. It resolves <bug>52548</bug>
+        which meant that services created with service.bat did not set the
+        <code>catalina.home</code> and <code>catalina.base</code> system
+        properties. (markt, kkolinko)
+      </fix>
+      <update>
+        Update Apache Commons Pool to 1.5.7. (kkolinko)
+      </update>
+      <update>
+        <bug>52579</bug>: Add a note about Sun's Charset.decode() bug to the
+        RELEASE-NOTES file. (kkolinko)
+      </update>
+      <update>
+        <bug>52805</bug>: Update to Eclipse JDT Compiler 3.7.2. (kkolinko)
+      </update>
+      <update>
+        Update the native component of the APR/native connectors to 1.1.23
+        and take advantage of the simplified distribution. (kkolinko) 
+      </update>
+      <fix>
+        When building a Windows installer do not copy whole "res" folder to
+        output/dist, but only the files that we need. Apply fixcrlf filter
+        only after the files are copied, so that <code>INSTALLLICENSE</code>
+        file had correct line ends. (kkolinko)
+      </fix>
+      <update>
+        Remove <code>res/License.rtf</code>. The file that is actually shown
+        by the Windows installer is <code>res/INSTALLLICENSE</code>.
+        (kkolinko)
+      </update>
+      <update>
+        Improve <code>RUNNING.txt</code>. (kkolinko)
+      </update>
+      <update>
+        Align the script that deploys Maven jars for Tomcat
+        (<code>res/maven/mvn-pub.xml</code>) with the Tomcat 7 version,
+        making full use of Nexus. (markt)
+      </update>
+      <add>
+        <bug>53034</bug>: Add <code>project.url</code> and
+        <code>project.licenses</code> sections to the POMs for the Maven
+        artifacts. (kkolinko)
+      </add>
+      <fix>
+        <bug>53454</bug>: Return correct content-length header for HEAD requests
+        when content length is greater than 2GB. (markt)
+      </fix>
+    </changelog>
+  </subsection>
+</section>
+<section name="Tomcat 6.0.35 (jfclere)" rtext="released 2011-12-05">
+  <subsection name="Catalina">
+    <changelog>
+      <fix>
+        Fix regression in decoding of parameters that contain spaces.
+        Patch by Willem Fibbe. (kkolinko)
+      </fix>
+    </changelog>
+  </subsection>
+</section>
+<section name="Tomcat 6.0.34 (jfclere)" rtext="not released">
+  <subsection name="Catalina">
+    <changelog>
+      <fix>
+        <bug>51550</bug>: Display an error page rather than an empty response
+        for an IllegalStateException caused by too many active sessions. (markt)
+      </fix>
+      <add>
+        <bug>51640</bug>: Improve the memory leak prevention for leaks
+        triggered by java.sql.DriverManager. (markt/kkolinko)
+      </add>
+      <fix>
+        <bug>51688</bug>: JreMemoryLeakPreventionListener now protects against
+        AWT thread creation. (schultz)
+      </fix>
+      <fix>
+        <bug>51758</bug>: The digester (used for processing XML files) used the
+        logger name <code>org.apache.commons.digester.Digester</code> rather
+        than the expected <code>org.apache.tomcat.util.digester.Digester</code>.
+        The digester has been changed to use the expected logger name.
+        (kkolinko)
+      </fix>
+      <add>
+        <bug>51862</bug>: Added a <code>classesToInitialize</code> attribute to 
+        <code>JreMemoryLeakPreventionListener</code> to allow pre-loading of configurable
+        classes to avoid some classloader leaks. (slaurent)
+      </add>
+      <fix>
+        <bug>51872</bug>: Ensure that the access log always uses the correct
+        value for the remote IP address associated with the request and that
+        requests with multiple errors do not result in multiple entries in
+        the access log. (markt)
+      </fix>
+      <add>
+        Allow to overwrite the check for distributability
+        of session attributes by session implementations. (rjung)
+      </add>
+      <add>
+        Provide the log format "OneLineFormatter" for JULI that provides the same
+        information as the default plus thread name but on a single line.
+        (markt/rjung)
+      </add>
+      <fix>
+        Ensure the the memory leak protection for the HttpClient keep-alive
+        always operates even if the thread has already stopped. (markt)
+      </fix>
+      <fix>
+        <bug>51940</bug>: Do not limit saving of request bodies during FORM
+        authentication to POST requests since any HTTP method may include a
+        request body. Based on a patch by Nicholas Sushkin. (kkolinko)
+      </fix>
+      <fix>
+        <bug>52091</bug>: Address performance issues related to lock contention
+        in StandardWrapper. Based on patch provided by Taiki Sugawara.
+        (kkolinko)
+      </fix>
+      <update>
+        In GenericPrincipal, SerializablePrincipal: Do not sort lists of roles
+        that have only one element. (kkolinko)
+      </update>
+      <add>
+        Make configuration issue for CsrfPreventionFilter result in the
+        failure of the filter rather than just a warning message. (kkolinko)
+      </add>
+      <fix>
+        Ensure changes to the configuration of RemoteAddrValve and
+        RemoteHostValve via JMX are thread-safe. (kkolinko)
+      </fix>
+      <add>
+        Make configuration issue for RemoteAddrValve and
+        RemoteHostValve result in the failure of the valve rather than
+        just a warning message. (kkolinko)
+      </add>
+      <update>
+        In <code>RequestFilterValve</code> (<code>RemoteAddrValve</code>,
+        <code>RemoteHostValve</code>): refactor value matching logic into
+        separate method and expose this new method <code>isAllowed</code>
+        through JMX. (kkolinko)
+      </update>
+      <add>
+        Improve performance of parameter processing for GET and POST requests.
+        Also add an option to limit the maximum number of parameters processed
+        per request. This defaults to 10000. Excessive parameters are ignored.
+        Note that <code>FailedRequestFilter</code> can be used to reject the
+        request if some parameters were ignored. (markt/kkolinko)
+      </add>
+      <add>
+        New filter <code>FailedRequestFilter</code> that will reject a request
+        if there were errors during HTTP parameter parsing. (kkolinko)
+      </add>
+    </changelog>
+  </subsection>
+  <subsection name="Coyote">
+    <changelog>
+      <fix>
+        <bug>50394</bug>: Return -1 from read operation instead of throwing an
+        exception when encountering an EOF with the HTTP APR connector.
+        (kkolinko)
+      </fix>
+      <fix>
+        <bug>51698</bug>: Fix CVE-2011-3190. Prevent AJP message injection.
+        (markt)
+      </fix>
+      <fix>
+        Detect incomplete AJP messages and reject the associated request if one
+        is found. (markt)
+      </fix>
+      <fix>
+        <bug>51794</bug>: Fix race condition in NioEndpoint selector. Patch
+        provided by dlord. (fhanik)
+      </fix>
+      <fix>
+        <bug>51905</bug>: Fix infinite loop in AprEndpoint shutdown if
+        acceptor unlock fails. Reduce timeout before forcefully closing
+        the socket from 30s to 10s. (kkolinko)
+      </fix>
+      <fix>
+        <bug>52121</bug>: Fix possible output corruption when compression is
+        enabled for a connector and the response is flushed. Test
+        case provided by David Marcks. (kkolinko)
+      </fix>
+      <fix>
+        Replace unneeded call that iterated events queue in NioEndpoint.Poller.
+        (kkolinko)
+      </fix>
+      <fix>
+        Improve MimeHeaders.toString(). (kkolinko)
+      </fix>
+      <fix>
+        Allow the BIO HTTP connector to be used with SSL when running under Java
+        7. (markt) 
+      </fix>
+      <fix>
+        Improve multi-byte character handling in all connectors. (rjung)
+      </fix>
+    </changelog>
+  </subsection>
+  <subsection name="Jasper">
+    <changelog>
+      <fix>
+        <bug>51220</bug>: Correct copy/paste error in original commit for this
+        issue. (markt)
+      </fix>
+      <fix>
+        <bug>52091</bug>: Address performance issues related to log creation
+        in TagHandlerPool. Patch provided by Taiki Sugawara. (markt)
+      </fix>
+    </changelog>
+  </subsection>
+  <subsection name="Cluster">
+    <changelog>
+      <add>
+        <bug>51736</bug>: Make rpcTimeout configurable in BackupManager. 
+        (kfujino)
+      </add>
+      <add>
+        New cluster manager attribute <code>sessionAttributeFilter</code>
+        allows to filter which session attributes are replicated using a
+        regular expression applied to the attribute name. (rjung)
+      </add>
+      <fix>
+        Avoid an unnecessary session ID change notice. 
+        Notice of changed session ID by JvmRouteBinderValve is unnecessary to 
+        BackupManager. In BackupManager, change of session ID is replicated by 
+        the call of a setId() method. (kfujino)
+      </fix>
+      <fix>
+        Fix unneeded duplicate <code>resetDeltaRequest()</code> call in
+        <code>DeltaSession.setId(String)</code>. (kkolinko)
+      </fix>
+      <add>
+        When Context manager does not exist, no context manager message is 
+        replied in order to avoid timeout (default 60 sec) of 
+        GET_ALL_SESSIONS sync phase. (kfujino)
+      </add>
+    </changelog>
+  </subsection>
+  <subsection name="Web applications">
+    <changelog>
+      <fix>
+        Correct the documentation for the connectionLinger attribute of the HTTP
+        connector. (markt)
+      </fix>
+      <add>
+        Show build date and version in the header on every documentation
+        page. (kkolinko)
+      </add>
+      <fix>
+        <bug>52049</bug>: Improve setup instructions for running as a Windows
+        service: correct information on how a JRE is identified and selected.
+        (markt)
+      </fix>
+      <update>
+        <bug>52172</bug>: Clarify Tomcat build instructions. Patch provided
+        by bmargulies. (kkolinko)
+      </update>
+    </changelog>
+  </subsection>
+  <subsection name="Other">
+    <changelog>
+      <update>
+        Update the native component of the APR/native connectors to 1.1.22.
+        (markt)
+      </update>
+      <update>
+        Update the recommended version of the native component of the APR/native
+        connectors to 1.1.22. (kkolinko)
+      </update>
+      <update>
+        Update the Eclipse compiler (used for JSPs) to 3.7. (markt)
+      </update>
+      <fix>
+        Correct two typos in the Windows installer. (kkolinko)
+      </fix>
+      <fix>
+        <bug>52059</bug>: In Windows uninstaller: Do not forget to remove
+        Tomcat keys from 32-bit registry on deinstallation. (kkolinko)
+      </fix>
+    </changelog>
+  </subsection>
+</section>
+<section name="Tomcat 6.0.33 (jfclere)" rtext="released 2011-08-18">
+  <subsection name="Catalina">
+    <changelog>
+      <add>
+        Allow to search the virtual paths before the webapp or after it. (rjung)
+      </add>
+      <fix>
+        <bug>27988</bug>: Improve reporting of missing files. (markt)
+      </fix>
+      <fix>
+        <bug>28852</bug>: Add URL encoding where missing to parameters in URLs
+        presented by Ant tasks to the Manager application. Based on a patch by
+        Stephane Bailliez. (markt) 
+      </fix>
+      <add>
+        <bug>46252</bug>: Allow to specify character set to be used to write
+        the access log in AccessLogValve. (kkolinko)
+      </add>
+      <add>
+        <bug>48863</bug>: Provide an warning if there is a problem with a class
+        path entry but use debug level logging if it is expected due to catalina
+        home/base split. (kkolinko)
+      </add>
+      <add>
+        <bug>49180</bug>: Add an option to disable file rotation in JULI
+        FileHandler. (kkolinko)
+      </add>
+      <fix>
+        <bug>50189</bug>: Once the application has finished writing to the
+        response, prevent further reads from the request since this causes
+        various problems in the connectors which do not expect this. (markt)
+      </fix>
+      <fix>
+        <bug>50700</bug>: Ensure that the override attribute of context
+        parameters is correctly followed. (markt)
+      </fix>
+      <fix>
+        <bug>50734</bug>: Return 404 rather than 400 for requests to the ROOT
+        context when no ROOT context is deployed. Patch provided by Violeta
+        Georgieva. (markt)
+      </fix>
+      <fix>
+        <bug>50751</bug>: When authenticating with the JNDI Realm, only attempt
+        to read user attributes from the directory if attributes are required.
+        (markt)
+      </fix>
+      <fix>
+        <bug>50752</bug>: Fix typo in debug message in
+        <code>org.apache.catalina.startup.Embedded</code>. (markt)
+      </fix>
+      <fix>
+        <bug>50855</bug>: Fix NPE on AuthenticatorBase.register() when debug
+        logging is enabled. (markt)
+      </fix>
+      <fix>
+        Correctly format the timestamp reported by version.[sh|bat]. (markt)
+      </fix>
+      <fix>
+        Remove unnecessary whitespace from MIME mapping entries in global
+        web.xml file. (markt)
+      </fix>
+      <fix>
+        <bug>51042</bug>: Don&apos;t trigger session creation listeners when a
+        session ID is changed as part of the authentication process. (markt)
+      </fix>
+      <add>
+        <bug>51119</bug>: Add JAAS authentication support to the
+        JMXRemoteLifecycleListener. Patch provided by Neil Laurance. (markt) 
+      </add>
+      <update>
+        Implement display of multiple request headers in AccessLogValve:
+        print not just the value of the first header, but of the all of them,
+        separated by commas. (kkolinko)
+      </update>
+      <fix>
+        Correct the SSLValve so it returns the SSL key size as an Integer rather
+        than as a String. (markt)
+      </fix>
+      <fix>
+        <bug>51162</bug>: Prevent possible NPE when removing a web application.
+        (markt)
+      </fix>
+      <fix>
+        <bug>51249</bug>: Improve system property replacement code
+        in ClassLoaderLogManager of Tomcat JULI to cover some corner cases.
+        (kkolinko)
+      </fix>
+      <fix>
+        <bug>51315</bug>: Fix IAE when removing an authenticator valve from a
+        container. Patch provided by Violeta Georgieva. (markt)
+      </fix>
+      <fix>
+        <bug>51324</bug>: Improve handling of exceptions when flushing the
+        response buffer to ensure that the doFlush flag does not get stuck in
+        the enabled state. Patch provided by Jeremy Norris. (kkolinko)
+      </fix>
+      <fix>
+        <bug>51348</bug>: Fix possible NPE when processing WebDAV locks. (markt)
+      </fix>
+      <add>
+        Add a container event that is fired when a session&apos;s ID is changed,
+        e.g. on authentication. (markt)
+      </add>
+      <fix>
+        Fix CVE-2011-2204. Prevent user passwords appearing in log files if a
+        runtime exception (e.g. OOME) occurs while creating a new user for a
+        MemoryUserDatabase via JMX. (markt)
+      </fix>
+      <fix>
+        <bug>51400</bug>: Avoid jvm bottleneck on String/byte[] conversion
+        triggered by a JVM bug. Based on patches by Dave Engberg and Konstantin
+        Prei&#223;er. (markt)
+      </fix>
+      <add>
+        <bug>51403</bug>: Avoid NPE in JULI FileHandler if formatter is
+        misconfigured. (kkolinko)
+      </add>
+      <update>
+        Create a directory for access log or error log (in AccessLogValve and
+        in JULI FileHandler) automatically when it is specified as a part of
+        the file name, e.g. in the <code>prefix</code> attribute. Earlier this
+        happened only if it was specified with the <code>directory</code>
+        attribute. (kkolinko)
+      </update>
+      <fix>
+        Log a failure if access log file cannot be opened. Improve i18n
+        of messages. (kkolinko)
+      </fix>
+      <fix>
+        Improve handling of URLs with path parameters and prevent incorrect 404
+        responses that could occur when path parameters were present. (kkolinko)
+      </fix>
+      <fix>
+        <bug>51473</bug>: Fix concatenation of values in
+        <code>SecurityConfig.setSecurityProperty()</code>. (kkolinko)
+      </fix>
+      <fix>
+        <bug>51509</bug>: Fix potential concurrency issue in CSRF prevention
+        filter that may lead to some requests failing that should not. (markt)
+      </fix>
+      <fix>
+        <bug>51588</bug>: Make it easier to extend the AccessLogValve to add
+        support for custom elements. (markt)
+      </fix>
+      <fix>
+        Unregister DataSource MBeans when web application stops. (kfujino)
+      </fix>
+      <add>
+        CVE-2011-1184: Add additional configuration options to the DIGEST
+        authenticator. (markt)
+      </add>
+    </changelog>
+  </subsection>
+  <subsection name="Coyote">
+    <changelog>
+      <fix>
+        Reduce level of log message for invalid URL parameters from WARNING to
+        INFO. (kkolinko) 
+      </fix>
+      <add>
+        <bug>48208</bug>: Provide an option to specify a custom trust manager
+        for BIO and NIO HTTP connectors using SSL. Based on a patch by Luciana
+        Moreira. (markt)
+      </add>
+      <fix>
+        <bug>49595</bug>: Protect against crashes when using the APR/native
+        connector. (jfclere)
+      </fix>
+      <fix>
+        <bug>49929</bug>: Make sure flush packet is not send after END_RESPONSE
+        packet. (mturk/markt) 
+      </fix>
+      <add>
+        <bug>50887</bug>: Enable the provider to be configured when generating
+        SSL certs. Based on a patch by pknopp. (markt)
+      </add>
+      <fix>
+        <bug>51073</bug>: Throw an exception and do not start the APR connector
+        if it is configured for SSL and an invalid value is provided for
+        SSLProtocol. (markt)
+      </fix>
+      <fix>
+        Fix CVE 2011-2526. Protect against infinite loops (HTTP NIO) and crashes
+        (HTTP APR) if sendfile is configured to send more data than is available
+        in the file. (markt)
+      </fix>
+      <fix>
+        Prevent NPEs when a socket is closed in non-error conditions after
+        sendfile processing when using the HTTP NIO connector. (markt) 
+      </fix>
+      <fix>
+        <bug>51515</bug>: Prevent immediate socket close when comet is used over
+        HTTPS. (markt)
+      </fix>
+    </changelog>
+  </subsection>
+  <subsection name="Jasper">
+    <changelog>
+      <fix>
+        <bug>36362</bug>: Handle the case where tag file attributes (which can
+        use any valid XML name) have a name which is not a Java identifier.
+        (markt)
+      </fix>
+      <fix>
+        <bug>47371</bug>: Correctly coerce the empty string to zero when used as
+        an operand in EL arithmetic. Patch provided by gbt. (markt)
+      </fix>
+      <fix>
+        <bug>50726</bug>: Ensure that the use of the genStringAsCharArray does
+        not result in String constants that are too long for valid Java code.
+        (markt)
+      </fix>
+      <fix>
+        <bug>50895</bug>: Don&apos;t initialize classes created during the
+        compilation stage. (markt)
+      </fix>
+      <add>
+        <bug>51124</bug>: Make Tomcat more robust if an OOME occurs. Usually
+        after an OOME all bets are off but this change appears to help some
+        users and the description of a &apos;recoverable&apos; OOME in the bug
+        is a plausible one. Based on a patch by Ramiro. (markt)
+      </add>
+      <fix>
+        <bug>51177</bug>: Ensure Tomcat&apos;s MapELResolver and ListELResolver
+        always return <code>Object.class</code> for <code>getType()</code> as
+        required by the EL specification. (markt)
+      </fix>
+      <fix>
+        Correct possible threading issue in JSP compilation when development
+        mode is used. (markt)
+      </fix>
+      <add>
+        <bug>51220</bug>: Add a system property to enable tag pooling with JSPs
+        that use a custom base class. Based on a patch by Dan Mikusa. (markt)
+      </add>
+      <add>
+        Broaden the exception handling in the EL Parser so that more failures to
+        parse an expression include the failed expression in the exception
+        message. Hopefully, this will help track down the cause of
+        <bug>51088</bug>. (markt)
+      </add>
+      <add>
+        Improve error reporting of Jasper compilation. (schultz)
+      </add>
+    </changelog>
+  </subsection>
+  <subsection name="Cluster">
+    <changelog>
+      <fix>
+        <bug>50646</bug>: Fix cluster message data corruption if message size
+        exceeds the underlying buffer size. Patch provided by Olivier Costet.
+        (markt)
+      </fix>
+      <fix>
+        <bug>50771</bug>: Ensure HttpServletRequest#getAuthType() returns the 
+        name of the authentication scheme if request has already been 
+        authenticated. (kfujino)
+      </fix>
+      <fix>
+        <bug>50950</bug>: Correct possible NotSerializableException for an
+        authenticated session when running with a security manager. (markt)
+      </fix>
+      <fix>
+        <bug>51306</bug>: Avoid NPE when handleSESSION_EXPIRED is processed 
+        while handleSESSION_CREATED is being processed. (kfujino)
+      </fix>
+      <fix>
+        The change in session ID is notified to the container event listener on 
+        the backup node in cluster. This notification is controlled by 
+        notifyContainerListenersOnReplication. (kfujino)
+      </fix>
+    </changelog>
+  </subsection>
+  <subsection name="Web applications">
+    <changelog>
+      <fix>
+        <bug>41498</bug>: Add the allRolesMode attribute to the Realm
+        configuration page in the documentation web application. (markt)
+      </fix>
+      <fix>
+        <bug>48997</bug>: Fixed some typos and improve cross-referencing to the
+        HTTP Connector and APR documentation with the SSL How-To page of the
+        documentation web application. (markt)
+      </fix>
+      <fix>
+        <bug>50804</bug>: Update links for Servlet 2.5 and JSP 2.1 Javadoc.
+        (markt)
+      </fix>
+      <update>
+        Improve class loading documentation and logging documentation.
+        (kkolinko)
+      </update>
+      <update>
+        Configure Security Manager How-To to include a copy of the actual
+        conf/catalina.policy file when the documentation is built, rather
+        than maintaining a copy of its content. (kkolinko)
+      </update>
+      <fix>
+        <bug>51147</bug>: Fix deployment via HTML Manager that was broken by
+        addition of CRSF protection. Patch provided by Alexis Hassler. (markt)
+      </fix>
+      <fix>
+        <bug>51156</bug>: Ensure session expiration option is available in
+        Manager application was running web applications that were defined in
+        server.xml. (markt)
+      </fix>
+      <fix>
+        Correct the log4j configuration settings when defining conversion
+        patterns in the documentation web application. (markt)
+      </fix>
+      <fix>
+        Update Maven repository information in the documentation to reflect
+        current usage. (markt)
+      </fix>
+      <fix>
+        <bug>51346</bug>: Update the documentation web application to make clear
+        the circumstances in which the RequestDumperValve will consume the
+        request&apos;s InputStream. Based on a patch by pid. (markt)
+      </fix>
+      <fix>
+        <bug>51443</bug>: Document the notifySessionListenersOnReplication
+        attribute for the DeltaManager. (markt)
+      </fix>
+      <fix>
+        <bug>51516</bug>: Correct documentation web application to show correct
+        system property name for changing the name of the SSO session cookie.
+        (markt)
+      </fix>
+      <update>
+        Update documentation to be even more explicit about the implications
+        of setting the <code>path</code> attribute on a <code>Context</code>
+        element in <code>server.xml</code>. (markt/kkolinko)
+      </update>
+    </changelog>
+  </subsection>
+  <subsection name="Other">
+    <changelog>
+      <update>
+        Clarify error messages in *.sh files to mention that if a script is
+        not found it might be because execute permission is needed. (kkolinko)
+      </update>
+      <add>
+        <bug>33262</bug>, <bug>40510</bug>, <bug>50949</bug>, <bug>51135</bug>:
+        Various improvements to the Windows installer to be able to install
+        several copies of Tomcat 6 side by side. Allow to configure service
+        name, connector and shutdown ports. Allow to choose whether to install
+        Start menu shortcuts and Apache Tomcat monitor application for all
+        users or for the current one only. Improve auto-detection of JAVA_HOME
+        for 64-bit Windows platforms: autoselect 32-bit JRE if it exists and
+        64-bit one is not available. Improve server.xml file handling.
+        Fix uninstallation icon. (markt/kkolinko)
+      </add>
+      <fix>
+        <bug>50854</bug>: Add additional entries to the default catalina.policy
+        file to support running the manager web application from CATALINA_HOME
+        or CATALINA_BASE. (markt) 
+      </fix>
+      <fix>
+        Update default download sources to use the central Apache Maven 2
+        repository as some libraries have been removed from the central Apache
+        Maven 1 repository. (kkolinko)
+      </fix>
+      <fix>
+        <bug>51155</bug>: Add comments to @deprecated tags that have none. Patch
+        provided by sebb. (kkolinko)
+      </fix>
+      <fix>
+        <bug>51309</bug>: Correct logic in catalina.sh stop when using a PID
+        file to ensure the correct message is shown. Patch provided by Caio
+        Cezar. (markt)
+      </fix>
+      <update>
+        Update Apache Commons Pool to 1.5.6. (kkolinko)
+      </update>
+      <update>
+        Update Apache Commons Daemon to 1.0.7. (kkolinko)
+      </update>
+      <update>
+        At build time use two alternative download locations for components
+        downloaded from apache.org. (kkolinko)
+      </update>
+    </changelog>
+  </subsection>
+</section>
+<section name="Tomcat 6.0.32 (jfclere)" rtext="released 2011-02-03">
+  <subsection name="Catalina">
+    <changelog>
+      <update>
+        <bug>48822</bug>: Include context name in reload and stop log statements.
+        Based on the patch provided by Marc Guillemot. (kkolinko)
+      </update>
+      <fix>
+        <bug>50673</bug>: Improve Catalina shutdown when running as a service.
+        Do not call System.exit(). (kkolinko)
+      </fix>
+      <fix>
+        <bug>50689</bug>: Provide 100 Continue responses at appropriate points
+        during FORM authentication if client indicates that they are expected.
+        (kkolinko)
+      </fix>
+      <fix>
+        Improve HTTP specification compliance in support of
+        <code>Accept-Language</code> header. This protects from known exploit
+        of the Oracle JVM bug that triggers a DoS, CVE-2010-4476. (kkolinko)
+      </fix>
+    </changelog>
+  </subsection>
+  <subsection name="Coyote">
+    <changelog>
+      <fix>
+        <bug>49795</bug>: Backport AprEndpoint shutdown improvements, to make
+        it more robust. (mturk/kkolinko)
+      </fix>
+      <fix>
+        <bug>50325</bug>: When the JVM indicates support for RFC 5746, disable
+        Tomcat&apos;s <code>allowUnsafeLegacyRenegotiation</code> configuration
+        attribute and use the JVM configuration to control renegotiation.
+        (markt)
+      </fix>
+      <fix>
+        <bug>50631</bug>: InternalNioInputBuffer should honor
+        <code>maxHttpHeadSize</code>. (kkolinko)
+      </fix>
+      <fix>
+        <bug>50651</bug>: Fix NPE in InternalNioOutputBuffer.recycle().
+        (kkolinko)
+      </fix>
+    </changelog>
+  </subsection>
+  <subsection name="Cluster">
+    <changelog>
+      <fix>
+        Be consistent with locks on sessionCreationTiming,
+        sessionExpirationTiming in DeltaManager.resetStatistics(). (kkolinko)
+      </fix>
+    </changelog>
+  </subsection>
+</section>
+<section name="Tomcat 6.0.31 (jfclere)" rtext="not released">
+  <subsection name="Catalina">
+    <changelog>
+      <fix>
+        <bug>49543</bug>: Allow Tomcat to use shared data sources with per
+        application credentials. (fhanik)
+      </fix>
+      <add>
+        <bug>50205</bug>: Add the deployIgnorePaths attribute to the Host
+        element. Based on a patch by Jim Riggs. (markt/kkolinko)
+      </add>
+      <fix>
+        <bug>50413</bug>: Additional fix that ensures the error page is served
+        regardless of any Range headers in the original request. (kkolinko)
+      </fix>
+      <fix>
+        <bug>50550</bug>: When a new directory is created (e.g. via WebDAV)
+        ensure that a subsequent request for that directory does not result in a
+        404 response. (markt/kkolinko)
+      </fix>
+      <add>
+        Provide session creation and destruction rate metrics in the session
+        managers. (markt) 
+      </add>
+      <fix>
+        <bug>50606</bug>: Improve CGIServlet: Provide support for specifying
+        empty value for the <code>executable</code> init-param. Provide support
+        for explicit additional arguments for the executable. Those were
+        broken when implementing fix for bug <bug>49657</bug>. (kkolinko)
+      </fix>
+      <fix>
+        <bug>50620</bug>: Stop exceptions that occur during
+        <code>Session.endAccess()</code> from preventing the normal completion
+        of <code>Request.recycle()</code>. (markt)
+      </fix>
+    </changelog>
+  </subsection>
+  <subsection name="Coyote">
+    <changelog>
+      <fix>
+        Remove a huge memory leak in the NIO connector introduced by the fix
+        for <bug>49884</bug>. (markt)
+      </fix>
+    </changelog>
+  </subsection>
+  <subsection name="Cluster">
+    <changelog>
+      <fix>
+        <bug>50600</bug>: Prevent a <code>ConcurrentModificationException</code>
+        when removing a WAR file via the FarmWarDeployer. (markt)
+      </fix>
+    </changelog>
+  </subsection>
+</section>
+<section name="Tomcat 6.0.30 (jfclere)" rtext="released 2011-01-13">
+  <subsection name="General">
+    <changelog>
+      <fix>
+        Filter input of manager app servlets. (kkolinko)
+      </fix>
+      <fix>
+        <bug>43960</bug>: Expose available property of StandardWrapper via JMX.
+        (markt)
+      </fix>
+      <update>
+        Update to Commons Daemon 1.0.5. (mturk)
+      </update>
+      <update>
+        Switch to using the Eclipse compiler JAR directly rather than creating
+        it from the larger JDT download. (markt)
+      </update>
+      <add>
+        Allow the off-line building of the extras package. (markt)
+      </add>
+      <update>
+        Update to Commons Pool 1.5.5. (markt)
+      </update>
+      <fix>
+        <bug>49728</bug>, <bug>50084</bug>: Improve PID file handling when
+        another process is managing the PID file and Tomcat does not have write
+        access. (markt)
+      </fix>
+      <fix>
+        <bug>49909</bug>, <bug>50201</bug>: Provide a mechanism to log requests
+        rejected before they reach the AccessLogValve to appear in the access
+        log. (markt/kkolinko)
+      </fix>
+    </changelog>
+  </subsection>
+  <subsection name="Catalina">
+    <changelog>
+      <fix>
+        <bug>38113</bug>: Provide a system property that enables a strict
+        interpretation of the specification for <code>getQueryString()</code>
+        when an empty query string is provided by the user agent. (markt)
+      </fix>
+      <fix>
+        Return a copy of the current URLs for the <code>WebappClassLoader</code>
+        to prevent modification. This facilitated, although it wasn't the root
+        cause, CVE-2010-1622. (markt)
+      </fix>
+      <add>
+        <bug>48837</bug>: Extend thread local memory leak detection to include
+        classes loaded by subordinate class loaders to the web
+        application&apos;s class loader such as the Jasper class loader.
+        Patch provided by Sylvain Laurent. (kkolinko)
+      </add>
+      <add>
+        <bug>48973</bug>: Avoid creating a SESSIONS.ser file when stopping an 
+        application if there's no session. Patch provided by Marc Guillemot.
+        (slaurent)
+      </add>
+      <fix>
+        <bug>49030</bug>: Failure during start of one connector should not leave
+        some connectors started and some ignored. (kkolinko)
+      </fix>
+      <fix>
+        <bug>49195</bug>: Don't report an error when shutting down a Windows
+        service for a Tomcat instance that has a disabled shutdown port. (markt)
+      </fix>
+      <fix>
+        <bug>49209</bug>: Fix problem with JDBC driver memory leak prevention
+        when running under a security manager. Patch provided by Sylvain
+        Laurent. (markt)
+      </fix>
+      <fix>
+        <bug>49613</bug>: Improve performance when using SSL for applications
+        that make multiple class to <code>Request.getAttributeNames()</code>.
+        Patch provided by Sampo Savolainen. (markt)
+      </fix>
+      <fix>
+        <bug>49657</bug>: Handle CGI executables with spaces in the path.
+        (markt)
+      </fix>
+      <fix>
+        <bug>49667</bug>: Ensure that using the JDBC driver memory leak
+        prevention code does not cause a one of the memory leaks it is meant to
+        avoid. (markt)
+      </fix>
+      <fix>
+        <bug>49749</bug>: Respect <code>httpOnly</code> setting of Context
+        when creating SSO cookie. (markt)
+      </fix>
+      <add>
+        Provide better web application state information via JMX. (markt)
+      </add>
+      <add>
+        <bug>49811</bug>: Add an option to disable URL rewriting on a per
+        Context basis. The option name is <code>disableURLRewriting</code>.
+        (markt)
+      </add>
+      <add>
+        <bug>49856</bug>: Expose the executor name for the connector via JMX.
+        (markt)
+      </add>
+      <fix>
+        <bug>49915</bug>: Make error more obvious, particularly when accessed
+        via JConsole, if StandardServer.storeConfig() is called when there is
+        no StoreConfig implementation present. (markt)
+      </fix>
+      <fix>
+        <bug>49965</bug>: Use correct i18n resources for StringManager in
+        JAASRealm. (kkolinko)
+      </fix>
+      <fix>
+        <bug>49987</bug>: Fix potential data race in the population of the
+        Servlet Context initialisation parameters. (markt)
+      </fix>
+      <fix>
+        Code clean-up. Avoid some casts in StandardContext. (markt)
+      </fix>
+      <add>
+        Add security policy and token poller protection to the JRE memory leak
+        protection provided in Tomcat 6. (markt/kkolinko)
+      </add>
+      <add>
+        <bug>50026</bug>: Add support for mapping the default servlet to URLs
+        other than /. (timw)
+      </add>
+      <fix>
+        <bug>50128</bug>: Improve exception handling in PersistentManagerBase
+        when running with a security manager. (kkolinko)
+      </fix>
+      <fix>
+        <bug>50131</bug>: Avoid possible NPE in debug output in PersistentValve.
+        Patch provided by sebb. (kkolinko)
+      </fix>
+      <fix>
+        <bug>50138</bug>: Fix threading issues in
+        <code>org.apache.catalina.security.SecurityUtil</code>. (markt)
+      </fix>
+      <add>
+        Add a new filter, <code>org.apache.catalina.filters.CsrfPreventionFilter</code>,
+        to provide generic cross-site request forgery (CSRF)
+        protection for web applications. (markt)
+      </add>
+      <fix>
+        Make sure Contexts defined in server.xml pick up any <code>configClass</code>
+        setting from the parent Host. (markt)
+      </fix>
+      <add>
+        <bug>50222</bug>: Modify memory leak prevention code so it pins the
+        system class loader in memory rather than than the common class loader,
+        which is better for embedded systems. (schultz) 
+      </add>
+      <add>
+        Make memory leak prevention code that clears ThreadLocal instances more
+        robust against objects with <code>toString()</code> methods that throw
+        exceptions. (markt)
+      </add>
+      <add>
+        <bug>50282</bug>: Load <code>javax.security.auth.login.Configuration</code>
+        with <code>JreMemoryLeakPreventionListener</code> to avoid memory leak
+        when stopping a webapp that would use JAAS.
+        (slaurent)
+      </add>
+      <fix>
+        <bug>50413</bug>: Ensure 304s are not returned when using static files
+        as error pages. (markt)
+      </fix>
+      <fix>
+        <bug>50453</bug>: Correctly handle multiple <code>X-Forwarded-For</code>
+        headers in the RemoteIpValve. Patch provided by Jim Riggs. (markt)
+      </fix>
+      <fix>
+        <bug>50459</bug>: Fix thread/classloader binding issues in
+        StandardContext. (slaurent) 
+      </fix>
+      <update>
+        <bug>50527</bug>: Improve an error message shown by HttpServlet. (markt)
+      </update>
+      <add>
+        <bug>50556</bug>: Improve JreMemoryLeakPreventionListener to prevent
+        a potential class loader leak caused by a thread spawned when the class
+        <code>com.sun.jndi.ldap.LdapPoolManager</code> is initialized and the 
+        system property <code>com.sun.jndi.ldap.connect.pool.timeout</code> is 
+        set to a value greater than 0. (slaurent)
+      </add>
+      <fix>
+        <bug>50642</bug>: Move the <code>sun.net.www.http.HttpClient</code>
+        keep-alive thread memory leak protection from the 
+        JreMemoryLeakPreventionListener to the WebappClassLoader since the
+        thread that triggers the memory leak is created on demand. (markt)
+      </fix>
+    </changelog>
+  </subsection>
+  <subsection name="Coyote">
+    <changelog>
+      <fix>
+        <bug>47913</bug>: Return the IP address rather than null for
+        <code>getRemoteHost()</code> with the APR connector if the IP address
+        does not resolve. (markt)
+      </fix>
+      <fix>
+        Avoid a NPE for APR connector unlockAccept with default soTimeout.
+        (mturk)
+      </fix>
+      <add>
+        <bug>48545</bug>: Allow JSSE trust stores to be used without providing
+        a password. Based on a patch by smmwpf54. (kkolinko)
+      </add>
+      <add>
+        <bug>48738</bug>: Add support for flushing gzipped output. Based on a
+        patch by Jiong Wang. (markt)
+      </add>
+      <fix>
+        Avoid a NPE in the DeltaManager when a parallel request invalidates the
+        session before the current request has a chance to send the replication
+        message. (markt)
+      </fix>
+      <fix>
+        <bug>48925</bug>: <code>request.getLocalAddr()</code> returns
+        <code>null</code> when using the default Jk AJP/1.3 connector. (rjung)
+      </fix>
+      <fix>
+        <bug>49497</bug>: Stop accepting new requests (inc keep-alive) once the
+        BIO connector is paused and the current request has finished processing.
+        (markt)
+      </fix>
+      <fix>
+        <bug>49521</bug>: Disable scanning for a free port in Jk AJP/1.3
+        connector by default. Do not change <code>maxPort</code> field value of ChannelSocket
+        in its <code>setPort()</code> and <code>init()</code> methods. Add
+        support for <code>maxPort</code> attribute on a <code>Connector</code>
+        element as a synonym for <code>channelSocket.maxPort</code>. (kkolinko)
+      </fix>
+      <fix>
+        <bug>49625</bug>: Ensure Vary header is set if response may be
+        compressed rather than only setting it if it is compressed. (markt)
+      </fix>
+      <fix>
+        <bug>49730</bug>: Fix race condition in StandardThreadExecutor that can
+        lead to long delays in processing requests. Patch provided by Sylvain
+        Laurent. (markt)
+      </fix>
+      <fix>
+        <bug>49860</bug>: Add support for trailing headers in chunked HTTP
+        requests. The header length is limited to 8192 by default and the limit
+        can be changed via a system property. (markt/kkolinko)
+      </fix>
+      <fix>
+        <bug>49972</bug>: Fix potential thread safe issue when formatting dates
+        for use in HTTP headers. (markt)
+      </fix>
+      <fix>
+        <bug>50072</bug>: NIO connector can mis-read request line if not sent in
+        a single packet. (markt/kkolinko)
+      </fix>
+      <fix>
+        Improve recycling of processors in Http11NioProtocol. (kkolinko)
+      </fix>
+      <add>
+        <bug>50273</bug>: Provide a workaround for an HP-UX issue that can
+        result in large numbers of SEVERE log messages appearing in the logs as
+        a result of normal operation. (markt)
+      </add>
+      <fix>
+        Make SSL certificate encoding algorithm consistent between connectors by
+        using the JVM default for all connectors. This also fixes an issue with
+        the NIO connector on IBM JVMs. (markt)
+      </fix>
+      <fix>
+        <bug>50467</bug>: Protected against NPE triggered by a race condition
+        that causes the NIO poller to fail, preventing the processing of further
+        requests. (markt)
+      </fix>
+    </changelog>
+  </subsection>
+  <subsection name="Jasper">
+    <changelog>
+      <update>
+        <bug>49217</bug>: Ensure that identifiers used in EL meet the
+        requirements of the Java Language Specification. This check is off by
+        default and can be enabled by setting a system property. (markt)
+      </update>
+      <fix>
+        <bug>49555</bug>: Correctly handled Tag Libraries where functions are
+        defined in static inner classes. (markt)
+      </fix>
+      <fix>
+        <bug>49665</bug>: Provide better information including JSP file name and
+        location when a missing file is detected during TLD handling. Patch
+        provided by Ted Leung. (markt)
+      </fix>
+      <fix>
+        <bug>49985</bug>: Fix thread safety issue in EL parser. (markt)
+      </fix>
+      <fix>
+        <bug>49986</bug>: Fix thread safety issue in JSP reloading. (timw))
+      </fix>
+      <fix>
+        <bug>49998</bug>: Make jsp:root detection work with single quoted
+        attributes as well. (timw)
+      </fix>
+      <fix>
+        <bug>50066</bug>: Compile a recursive tag file if it depends on a JAR.
+        Patch provided by Sylvain Laurent. (markt)
+      </fix>
+      <fix>
+        <bug>50078</bug>: Fix threading issues in EL caches and make cache sizes
+        configurable. Threading patch provided by Takayoshi Kimura. (markt)
+      </fix>
+      <fix>
+        <bug>50105</bug>: When processing composite EL expressions use
+        <code>Enum.name()</code> rather than <code>Enum.toString()</code> as
+        required by the EL specification. (markt)
+      </fix>
+      <fix>
+        <bug>50228</bug>: Improve recycling of <code>BodyContentImpl</code>.
+        This avoids keeping a cached reference to a webapp-provided Writer
+        used in JspFragment.invoke() calls. (kkolinko)
+      </fix>
+      <fix>
+        <bug>50460</bug>: Fix memory leak in JspDocumentParser triggered by
+        first access to a jspx page. (kkolinko)
+      </fix>
+      <fix>
+        <bug>50500</bug>: Use correct coercions (as per the EL spec) for
+        arithmetic operations involving string values containing &apos;.&apos;,
+        &apos;e&apos; or &apos;E&apos;. Based on a patch by Brian Weisleder.
+        (markt)
+      </fix>
+    </changelog>
+  </subsection>
+  <subsection name="Cluster">
+    <changelog>
+      <fix>
+        <bug>49343</bug>: When ChannelException is thrown, remove listener from
+        channel. (kfujino)
+      </fix>
+      <fix>
+        Add Null check when CHANGE_SESSION_ID message received. (kfujino)
+      </fix>
+      <fix>
+        When a cluster node disappears when using the backup manager, handle the
+        failed ping message rather than propagating the exception (which just
+        logs the stack trace but doesn't do anything to deal with the failure).
+        (markt)
+      </fix>
+      <fix>
+        <bug>49905</bug>: Fix potential memory leak when using asynchronous
+        session replication. (markt)
+      </fix>
+      <fix>
+        <bug>49924</bug>: When non-primary node changes into a primary node,
+        make sure isPrimarySession is changed to true. (kfujino)
+      </fix>
+      <fix>
+        Add support for <code>maxActiveSessions</code> attribute to
+        BackupManager. (kfujino)
+      </fix>
+      <fix>
+        Improve sending an access message in DeltaManager.
+        Use <code>maxInactiveInterval</code> not of the Manager, but of the session. 
+        If <code>maxInactiveInterval</code> is negative, the access message is not
+        being sent. (kfujino)
+      </fix>
+      <fix>
+        <bug>50547</bug>: Add time stamp for CHANGE_SESSION_ID message and 
+        SESSION_EXPIRED message. (kfujino)
+      </fix>
+    </changelog>
+  </subsection>
+  <subsection name="Web applications">
+    <changelog>
+      <fix>
+        <bug>49585</bug>: Update JSVC documentation to reflect new packaging
+        of Commons Daemon. (markt)
+      </fix>
+      <add>
+        Configure the Manager web application to use the new CSRF protection. To
+        take advantage of this protection, the <code>manager</code> role must be
+        removed from all users and the new <code>manager-gui</code> and
+        <code>manager-script</code> roles used instead. (markt)
+      </add>
+      <add>
+        Configure the Host Manager web application to use the new CSRF
+        protection. To take advantage of this protection, the <code>admin</code> role
+        must be removed from all users and the new <code>admin-gui</code> and
+        <code>admin-script</code> roles used instead. (markt)
+      </add>
+      <fix>
+        <bug>50303</bug>: Update JNDI how-to to reflect new JavaMail and JAF
+        download locations and that JAF is now included in Java SE 6. (markt) 
+      </fix>
+      <fix>
+        CVE-2010-4172: Multiple XSS in Manager application. (markt/kkolinko)
+      </fix>
+      <update>
+        Improve Tomcat Logging documentation. (kkolinko)
+      </update>
+      <add>
+        <bug>50242</bug>: Provide a sample log4j  configuration that more
+        closely matches the default JULI configuration. Patch provided by
+        Christopher Schultz. (kkolinko)
+      </add>
+      <add>
+        <bug>50294</bug>: Add more information to documentation regarding format
+        of configuration files. Patch provided by Luke Meyer. (markt) 
+      </add>
+      <update>
+        Configure the Manager and Host-Manager web applications to use HttpOnly
+        flag for their session cookies. (kkolinko)
+      </update>
+      <fix>
+        <bug>50316</bug>: Fix display of negative values in the Manager web
+        application. (kkolinko)
+      </fix>
+      <update>
+        Improve documentation of database connection factory. (rjung)
+      </update>
+    </changelog>
+  </subsection>
+  <subsection name="Other">
+    <changelog>
+      <update>
+        <bug>48716</bug>: Do not call reset if the default LogManager is in use.
+        (markt)
+      </update>
+      <fix>
+        Use native line endings for example Eclipse configuration files in
+        source distribution. (markt)
+      </fix>
+      <fix>
+        <bug>49428</bug>: Add a work-around for the known namespace issues for
+        some Microsoft WebDAV clients. Based on the patch provided by
+        Panagiotis Astithas. (kkolinko)
+      </fix>
+      <fix>
+        <bug>49861</bug>: Fix formatting of log messages in JXM remote listener.
+        Do not use commas when printing RMI port numbers. (markt)
+      </fix>
+      <fix>
+        <bug>50140</bug>: Don&apos;t ignore a user specified install directory
+        on 64-bit platforms when using the Windows installer. (markt)
+      </fix>
+      <fix>
+        <bug>50552</bug>: Avoid NPE that hides error message when using Ant
+        tasks. (schultz)
+      </fix>
+      <update>
+        Numerous improvements to the Windows installer: update install/uninstall
+        icons, create an installation log, allow 32-bit JVMs to be selected when
+        installing on a 64-bit platform, replace the .ini files with the script
+        equivalents, use the new manager and host-manager roles, provide the
+        ability to edit the roles for the added user, add support for the
+        <code>/?</code> command line switch, clean up fully after installation,
+        add DetailPrint statements for operations that may take time and
+        improve the descriptions of the components. (kkolinko, mturk, markt)
+      </update>
+    </changelog>
+  </subsection>
+</section>
+<section name="Tomcat 6.0.29 (jfclere)" rtext="released 2010-07-22">
+  <subsection name="Catalina">
+    <changelog>
+      <add>
+        <bug>48960</bug>: Add a new option to the SSI Servlet and SSI Filter to
+        allow the disabling of the <code>exec</code> command. This is now
+        disabled by default. Based on a patch by Yair Lenga. (markt)
+      </add>
+      <fix>
+        <bug>49551</bug>: Allow default context.xml location to be specified
+        using an absolute path. (markt)
+      </fix>
+      <fix>
+        <bug>49598</bug>: When session is changed and the session cookie is
+        replaced, ensure that the new Set-Cookie header overwrites the old
+        Set-Cookie header. (markt)
+      </fix>
+      <fix>
+        Fix order when listing Webapp loader search URLs. (rjung)
+      </fix>
+      <add>
+        Add support for <code>*.jar</code> pattern in VirtualWebappLoader.
+        (kkolinko)
+      </add>
+    </changelog>
+  </subsection>
+</section>
+<section name="Tomcat 6.0.28 (jfclere)" rtext="released 2010-07-09">
+  <subsection name="Catalina">
+    <changelog>
+      <fix>Arrange filter logic. (jfclere)
+      </fix>
+      <fix>
+        <bug>49230</bug>: Enhance JRE leak prevention listener with protection
+        for the keep-alive thread started by
+        <code>sun.net.www.http.HttpClient</code>. Patch provided by Rob Kooper.
+        (markt)
+      </fix>
+      <fix>
+        <bug>49351</bug>: Fix possible NPE when embedding and no name is
+        specified for the Service. (markt)
+      </fix>
+      <fix>
+        <bug>49424</bug>: Avoid NPE if client provides no data with a chunked
+        POST request. (markt)
+      </fix>
+      <fix>
+        <bug>49414</bug>: Improve diagnostic of memory leaks.
+        Differentiate between request threads and application
+        created threads when warning about still running threads when an
+        application stops. (markt)
+      </fix>
+      <fix>
+        <bug>49443</bug>: Fix RemoteIpValve documentation. Use remoteIpHeader
+        rather than remoteIPHeader consistently. (markt)
+      </fix>
+      <add>
+        Add property <code>searchExternalFirst</code> to WebappLoader.
+        If set, the external repositories will be searched before
+        the WEB-INF ones. (rjung)
+      </add>
+    </changelog>
+  </subsection>
+  <subsection name="Cluster">
+    <changelog>
+      <fix>
+        <bug>49445</bug>: When session ID is changed after authentication,
+        ensure the DeltaManager replicates the change in ID to the other nodes
+        in the cluster. (kfujino)
+      </fix>
+    </changelog>
+  </subsection>
+  <subsection name="Web applications">
+    <changelog>
+      <fix>
+        <bug>49213</bug>: Grant permissions required by manager application when
+        running under a security manager. (markt/kkolinko)
+      </fix>
+      <fix>
+        <bug>49436</bug>: Correct documented default for <code>readonly</code>
+        attribute of the UserDatabase component. (markt)
+      </fix>
+    </changelog>
+  </subsection>
+</section>
+<section name="Tomcat 6.0.27 (jfclere)" rtext="not released">
+  <subsection name="General">
+    <changelog>
+      <update>
+        Update DBCP to 1.3. (markt)
+      </update>
+    </changelog>
+  </subsection>
+  <subsection name="Catalina">
+    <changelog>
+      <fix>
+        Fix CVE-2010-1157. Prevent possible disclosure of host name or IP
+        address via the HTTP WWW-Authenticate header when using BASIC or DIGEST
+        authentication. (markt)
+      </fix>
+      <add>
+        Include context name when reporting memory leaks to aid root cause
+        identification. (markt)
+      </add>
+      <fix>
+        Improve exception handling on session de-serialization to assist in
+        identifying the root cause of <bug>48007</bug>. (kkolinko)
+      </fix>
+      <add>
+        <bug>48379</bug>: Make session cookie name, domain and path configurable
+        per context. (markt)
+      </add>
+      <fix>
+        <bug>48589</bug>: Make JNDIRealm easier to extend. Based on a patch by
+        Candid Dauth. (markt/kkolinko)
+      </fix>
+      <fix>
+        <bug>48629</bug>: Allow user names as well as DNs to be used with the
+        nested role search. Add roleNested to the documentation. Patch provided
+        by Felix Schumacher. (markt)
+      </fix>
+      <fix>
+        <bug>48661</bug>: Make error page behavior consistent, regardless of how
+        the error page is defined. If a response has been committed, always
+        include the error page. (markt)
+      </fix>
+      <fix>
+        <bug>48729</bug>: Return roles defined by both userRoleName and roleName
+        mechanisms. Patch provided by 'eric'. Also make user's role list
+        immutable.(markt)
+      </fix>
+      <fix>
+        <bug>48760</bug>: Fix potential multi-threading issue in static resource
+        serving where multiple threads could try to use the the same
+        InputStream. (markt)
+      </fix>
+      <fix>
+        <bug>48790</bug>: Fix thread safety issue in the count of the maximum
+        number of active session. (markt/kkolinko)
+      </fix>
+      <fix>
+        <bug>48793</bug>: Make catalina.sh more robust to different return
+        values on different platforms. Patch provided by Thomas GL. (markt)
+      </fix>
+       <fix>
+        <bug>48840</bug>: Swallow output (if any) from use of cd when determining
+        $CATALINA_HOME in catalina.sh and tool-wrapper.sh scripts. Based on patch
+        provided by mdietze. (markt/kkolinko)
+      </fix>
+      <fix>
+        <bug>48895</bug>: Make clearing of ThreadLocals that are causing memory
+        leaks on web application stop, reload or undeploy configurable since the
+        process of clearing them is not thread-safe. (markt)
+      </fix>
+      <fix>
+        <bug>48903</bug>: Fix deadlock in webapp class loader. (rjung)
+      </fix>
+      <fix>
+        <bug>48971</bug>: Make stopping of leaking Timer threads optional and
+        disabled by default. (markt)
+      </fix>
+      <fix>
+        <bug>48976</bug>: Document JAVA_ENDORSED_DIRS in start-up scripts. Patch
+        provided by Laurent Vaills. (markt)
+      </fix>
+      <fix>
+        <bug>48983</bug>: Improve debug logging for situations when
+        <code>RemoteIpValve</code> is bypassed. Patch provided by Cyrille Le
+        Clerc. (markt)
+      </fix>
+      <fix>
+        <bug>49018</bug>: Fix processing of time argument in the Expire sessions
+        action in the Manager web application. (kkolinko)
+      </fix>
+      <fix>
+        <bug>49116</bug>: If session is already invalid, expire session to
+        prevent memory leak. (kfujino)
+      </fix>
+      <fix>
+        <bug>49158</bug>: Ensure only one session cookie is returned for a
+        single request. (markt/fhanik)
+      </fix>
+      <fix>
+        <bug>49245</bug>: Fix session expiration check in cross-context
+        requests. (markt)
+      </fix>
+      <fix>
+        <bug>49398</bug>: ByteChunk.indexOf(String, int, int, int) could not
+        find a string of length 1. (kkolinko)
+      </fix>
+      <fix>
+        Fix possible overflows when calculating session statistics. (kkolinko)
+      </fix>
+      <add>
+        Log unexpected exceptions when providing access to web application
+        resources in ApplicationContext. (kkolinko)
+      </add>
+      <fix>
+        Improve exception handling in CatalinaShutdownHook. (kkolinko)
+      </fix>
+      <add>
+        Expose properties of VirtualWebappLoader and WebappClassLoader via JMX.
+        (rjung)
+      </add>
+    </changelog>
+  </subsection>
+  <subsection name="Coyote">
+    <changelog>
+      <fix>
+        <bug>48839</bug>: Correctly handle HTTP header folding in the NIO
+        connector. Patch suggested by Richa Baronia. (markt)
+      </fix>
+      <fix>
+        <bug>48843</bug>: Prevent possible deadlock for worker allocation in
+        connectors. (kkolinko)
+      </fix>
+      <fix>
+        <bug>48843</bug>: Fix handling of add queues in AprEndpoint.Poller and
+        AprEndpoint.Sendfile. Do not miss wakeups. (kkolinko)
+      </fix>
+      <add>
+        <bug>48862</bug>: Add support for the backlog parameter to the AJP
+        connector. (pero/markt)
+      </add>
+      <fix>
+        <bug>48917</bug>: Correct name of mod_jk module in ApacheConfig. Patch
+        provided by Todd Hicks. (markt)
+      </fix>
+      <fix>
+        <bug>49095</bug>: AprEndpoint did not wakeup acceptors during shutdown
+        when deferAccept option was enabled. Based on a patch provided by
+        Ruediger Pluem. (kkolinko)
+      </fix>
+      <add>
+        Use chunked encoding for http 1.1 requests with no content-length
+        (regardless of keep-alive) so client can differentiate between complete
+        and partial responses. (markt)
+      </add>
+      <fix>
+        Correct the SSL session timeout attribute name so the code agrees with
+        the documentation. (markt)
+      </fix>
+      <add>
+        CoyotePrincipal now implements Serializable. (fhanik)
+      </add>
+      <fix>
+        Enable the BIO AJP connector to run under a security manager. (markt)
+      </fix>
+    </changelog>
+  </subsection>
+  <subsection name="Jasper">
+    <changelog>
+      <fix>
+        <bug>45015</bug>: Correct a regression in quote handling caused by the
+        re-factoring of attribute parsing. (markt)
+      </fix>
+      <fix>
+        <bug>48701</bug>: Add a system property to allow disabling enforcement
+        of JSP.5.3. The specification recommends, but does not require, this
+        enforcement. (kkolinko)
+      </fix>
+      <fix>
+        <bug>48737</bug>: Don't assume paths that start with /META-INF/... are
+        always in JARs. This is not true for some IDEs. Patch provided by
+        Fabrizio Giustina. (markt)
+      </fix>
+      <fix>
+        <bug>49081</bug>: Correctly handle EL expressions of the form #${...}.
+        (markt)
+      </fix>
+      <fix>
+        <bug>49196</bug>: Avoid NullPointerException in PageContext.getErrorData()
+        if an error-handling JSP page is called directly. (markt)
+      </fix>
+    </changelog>
+  </subsection>
+  <subsection name="Cluster">
+    <changelog>
+      <fix>
+        <bug>48717</bug>: When a node joins a cluster and it receives all the
+        current sessions, ensure the sessionCreated event is fired if the
+        Manager is configured to replicate session events. (markt)
+      </fix>
+      <fix>
+        <bug>48934</bug>: Previous fix to handle dropped connections incorrectly
+        permanently disabled session replication. (fhanik)
+      </fix>
+      <fix>
+        <bug>49051</bug>: memberAlive is not called if member has not already
+        existed in membership. (kfujino)
+      </fix>
+      <fix>
+        <bug>49151</bug>: Avoid ClassCastException in BackupManager#stop.
+        (kfujino)
+      </fix>
+      <fix>
+        <bug>49170</bug>: Do not send duplicated session. (kfujino)
+      </fix>
+      <fix>
+        Add missing messages and ensure cluster listeners log messages to
+        correct logger. (markt)
+      </fix>
+    </changelog>
+  </subsection>
+  <subsection name="Web applications">
+    <changelog>
+      <add>
+        Use underscores instead of spaces in anchor names in Tomcat
+        documentation. (kkolinko)
+      </add>
+      <add>
+        Add support for displaying the Spring Security user name (if present) in
+        the Manager application. (markt)
+      </add>
+      <update>
+        Improve the ChatServlet <a href="aio.html">Comet</a> example
+        (/examples/jsp/chat/). (kkolinko)
+      </update>
+    </changelog>
+  </subsection>
+  <subsection name="Other">
+    <changelog>
+      <update>Update to Commons Daemon 1.0.2. Use service launcher (procrun)
+      from the Commons Daemon release. Do not keep a copy of it in our source
+      tree. (mturk/kkolinko)</update>
+      <update>
+        Update to NSIS 2.46. (kkolinko)
+      </update>
+      <fix>
+        <bug>48990</bug>: Fix the <code>skip.installer</code> build property
+        so if set, only the Windows installer is skipped. (markt)
+      </fix>
+      <fix>
+        <bug>49178</bug>: Provide in catalina.policy an example of additional
+        permissions that might be needed for code located in
+        <code>$CATALINA_BASE/lib</code>. (markt)
+      </fix>
+      <fix>
+        <bug>49236</bug>: Do not use indexing when packing Tomcat JARs.
+        (kkolinko)
+      </fix>
+      <fix>
+        Remove unused code from org.apache.tomcat.util.buf classes. (kkolinko)
+      </fix>
+      <update>
+        Rearrange tomcat-juli.jar permissions and wrap long lines in the
+        <code>conf/catalina.policy</code> file, to make the text more readable
+        when cited in documentation. (kkolinko)
+      </update>
+      <fix>
+        Do not evaluate the <code>execute.installer</code> property when building
+        a release. The <code>skip.installer</code> property is used instead.
+        (kkolinko)
+      </fix>
+    </changelog>
+  </subsection>
+</section>
+<section name="Tomcat 6.0.26 (jfclere)" rtext="released 2010-03-11">
   <subsection name="Catalina">
     <changelog>
-        <fix> Fix CVE-2014-0075. Patch applied by Red Hat</fix>
-        <fix>
-            Fix CVE-2014-0050 a denial of service with a malicious, 
-            malformed Content-Type header and multipart request 
-            processing. Patch applied by Red Hat
-        </fix>
-        <fix>
-            Add support for limiting the size of chunk extensions when 
-            using chunked encoding. (markt) CVE-2013-4322 patch applied by
-            Red Hat
-        </fix>
-	    <fix>
-		 	Remove unneeded handling of FORM authentication in RealmBase (kkolinko)
-			CVE-2012-3546 Patch backported to tc 6.0.24 by Red Hat
-       </fix>
-       <fix>
-			<bug>52858</bug>: Fix high CPU load with SSL, NIO and sendfile when
-			client breaks the connection before reading all the requested data.
-			(fhanik/kkolinko) CVE-2012-4534 patch backported to 6.0.24 by
-			Red Hat
-		</fix>	 
-	   <fix>
-	      Various improvements to the Digest authenticator including
-			<bug>52954</bug>, the disabling caching of an authenticated
-			user in the session by default, tracking server rather than
-			client nonces and better handling of stal nonce values. (markt)
-			Fix in tomcat6-6.0.36. Patch ported to 6.0.24 by Red Hat
-			rhbz 882010
-		</fix>
-	 	<add>
-		   CVE-2011-1184 
-			Add additional configuration options to the DIGEST authenticator
-			(markt)
-		</add>
-	   <fix>
-		  Fix CVE-2011-2204. Prevent user passwords appearing in log files if a
-		  runtime exception (e.g. OOME) occurs while creating a new user for a
-		  MemoryUserDataBase via JMX (markt)
-	  </fix>
-      <fix>
-        Resolves: CVE-2014-0096
-        Redefine the <code>globalXsltFile</code> initialisation parameter of the
-        DefaultServlet as relative to CATALINA_BASE/conf or CATALINA_HOME/conf.
-        Prevent user supplied XSLTs used by the DefaultServlet from defining
-        external entities. (markt)
+      <fix>
+        Close security hole in unreleased 6.0.25 by ensuring new find leaks
+        functionality is protected by a security constraint. (kkolinko)
+      </fix>
+      <fix>
+        <bug>48831</bug>: Improve logging shutdown behaviour. Use Catalina's
+        shutdown hook to shutdown JULI. This enables them to be shutdown in the
+        correct order. Do not shutdown global handlers several times.
+        (markt/kkolinko)
+      </fix>
+    </changelog>
+  </subsection>
+  <subsection name="Coyote">
+    <changelog>
+      <fix>
+        <bug>48584</bug>: Prevent the APR connector logging an error if the
+        acceptor fails during shutdown since this is expected. (mturk)
+      </fix>
+      <fix>
+        <bug>48660</bug>: Using compression should not overwrite any Vary header
+        set by a web application. (markt)
+      </fix>
+    </changelog>
+  </subsection>
+  <subsection name="Jasper">
+    <changelog>
+      <fix>
+        <bug>48371</bug>: Ensure generated servlet mappings are inserted at the
+        correct location when using JspC and allow the option that controls this
+        to be configured on the command line. Also allow the encoding of web.xml
+        to be configured when using JspC and deprecate some unused JspC methods.
+        (markt/kkolinko)
+      </fix>
+      <fix>
+        <bug>48498</bug>: Avoid ArrayIndexOutOfBoundsException triggered by a
+        Java 6/7 XML parser bug. (markt/kkolinko)
+      </fix>
+      <fix>
+        <bug>48668</bug>: Additional fixes to ensure deferred syntax is handled
+        correctly. (kkolinko)
+      </fix>
+      <fix>
+        <bug>48827</bug>: Correct a regression in the fix for <bug>47977</bug>
+        that caused an incorrect non-empty body error to be reported for valid
+        JSP documents. (markt)
       </fix>
     </changelog>
   </subsection>
-  <subsection name="Coyote" >
-  	<changelog>
-	  <fix>
-	    <bug>51698</bug>: Fix CVE-2011-3190 Prevent AJP message injection
-		 (markt)
-		</fix>
-	</changelog>
+  <subsection name="Web applications">
+    <changelog>
+      <add>
+        Make changelog.xml be directly rendered as HTML by certain browsers.
+        (kkolinko)
+      </add>
+      <add>
+        Add support for automated generation of TOC tables and for links to svn
+        revisions to tomcat-docs.xsl in documentation. (kkolinko/fhanik)
+      </add>
+      <add>
+        Move Manager application JSPs that are not intended to be accessed
+        directly under the WEB-INF directory. (kkolinko)
+      </add>
+      <fix>
+        Improve the messages displayed by the find leaks diagnostic in the
+        Manager application. (kkolinko)
+      </fix>
+    </changelog>
+  </subsection>
+  <subsection name="Other">
+    <changelog>
+      <fix>
+        Encode all property files using ascii escaped UTF-8. Also fixes
+        deployment problem when using French locale. (jfclere/rjung)
+      </fix>
+    </changelog>
   </subsection>
+</section>
+<section name="Tomcat 6.0.25 (jfclere)" rtext="not released">
   <subsection name="Catalina">
     <changelog>
       <fix>
-        Correct TCK failures with security manager caused by the original fix
-        for <bug>47774</bug>. (markt)
+        <bug>48039</bug>: Return immediately if start() is called on an already
+        started StandardService. (markt)
+      </fix>
+      <fix>
+        <bug>48109</bug>: Ensure InputStream is closed on error condition in web
+        application class loader. (markt)
+      </fix>
+      <fix>
+        <bug>48179</bug>: Clean up dead code that was used to read tldCache
+        file. (kkolinko)
+      </fix>
+      <fix>
+        <bug>48318</bug>: Handle case where WebDAV resource is in directory
+        listing but is not accessible. (markt)
+      </fix>
+      <add>
+        <bug>48384</bug>: Add a per context xslt option for directory listings.
+        Make the fallback options work as described in the documentation.
+        (markt)
+      </add>
+      <fix>
+        <bug>48577</bug>: Filter URL when displaying missing included page.
+        (markt)
+      </fix>
+      <fix>
+        <bug>48612</bug>: Prevent exception on shutdown if the address attribute
+        is specified for a connector. (markt)
+      </fix>
+      <fix>
+        <bug>48613</bug>: Further fixes to ensure APRLifecycleListener is only
+        used if defined in server.xml. (fhanik)
+      </fix>
+      <fix>
+        <bug>48614</bug>: Correct JULI log file buffering so default behaviour
+        is no buffering. (fhanik)
+      </fix>
+      <fix>
+        <bug>48625</bug>: Provide an option to exit if an error occurs during
+        the initialization phase. (fhanik)
+      </fix>
+      <fix>
+        <bug>48645</bug>: Use specified encoding rather than null in calls to
+        <code>RequestUtil.URLDecode(byte[] bytes, String enc)</code> (markt)
+      </fix>
+      <fix>
+        <bug>48653</bug>: Force request.secure and request.scheme to
+        <code>false</code> and <code>http</code> if the X-Forwarded-Proto header
+        has the value http. Patch provided by Cyrille Le Clerc. (markt)
+      </fix>
+      <fix>
+        <bug>48678</bug>: Remove duplicate server field from
+        <code>org.apache.catalina.startup.Catalina</code>. (markt)
+      </fix>
+      <fix>
+        <bug>48694</bug>: Remove potential deadlock in web application class
+        loader. (markt)
+      </fix>
+      <add>
+        <bug>48716</bug>: Provide additional configuration options for JULI.
+        (markt)
+      </add>
+      <fix>
+        <bug>48726</bug>: Prevent OOME when uploading large WAR files with the
+        deployer. Patch provided by adam. (markt)
+      </fix>
+      <add>
+        Improve memory leak protection by safely stopping threads started via
+        <code>java.util.Timer</code> that an application starts but fails to
+        stop and by clearing references retained due to the use of
+        <code>java.util.ResourceBundle</code>. (markt)
+      </add>
+      <update>
+        Modify ThreadLocal memory leak detection to not report false positives
+        and to simplify implementation. (markt/kkolinko)
+      </update>
+      <add>
+        Basic memory leak detection was added to the standard Host
+        implementation and exposed via JMX to detect memory leaks on web
+        application reload. (markt/kkolinko)
+      </add>
+    </changelog>
+  </subsection>
+  <subsection name="Coyote">
+    <changelog>
+      <update>
+        Update the native/APR library version bundled with Tomcat to 1.1.20.
+        (kkolinko)
+      </update>
+    </changelog>
+  </subsection>
+  <subsection name="Jasper">
+    <changelog>
+      <add>
+        Add some debug logging to the compiler where exceptions were previously
+        swallowed. (markt)
+      </add>
+      <fix>
+        <bug>48170</bug>: Remove unnecessary synchronization that is causing
+        issues under load. (markt)
+      </fix>
+      <fix>
+        <bug>48580</bug>: Prevent AccessControlException if first access is to a
+        JSP that uses a FunctionMapper. (markt)
+      </fix>
+      <fix>
+        <bug>48582</bug>: Avoid NPE on background compilation failure. (markt)
+      </fix>
+      <fix>
+        <bug>48616</bug>: Don't declare or synchronize scripting variables for
+        JSP fragments since they are scriptless. This is an alternative fix for
+        <bug>42390</bug> that avoids both the original problem and the
+        regression in the first fix. (kkolinko)
+      </fix>
+      <fix>
+        <bug>48627</bug>: Fix regression in re-factored EL parsing. Keep
+        literals as literals and handle deferredSyntaxAllowedAsLiteral.
+        (kkolinko)
+      </fix>
+      <fix>
+        <bug>48668</bug>: When parsing JSPs only parse EL as EL if EL is enabled
+        else strings such as ${ will be silently dropped. (markt)
+      </fix>
+      <fix>
+        Various EL TCK failures. (markt)
+      </fix>
+    </changelog>
+  </subsection>
+  <subsection name="Cluster">
+    <changelog>
+      <fix>
+        Force a disconnect if an error occurs during replication such as
+        a firewall dropping the connection. (fhanik)
+      </fix>
+    </changelog>
+  </subsection>
+  <subsection name="Web applications">
+    <changelog>
+      <add>
+        Add new "Find leaks" command to the Manager application. It allows to
+        detect web applications that have caused memory leaks on stop,
+        reload or undeploy. (markt/kkolinko)
+      </add>
+    </changelog>
+  </subsection>
+  <subsection name="Other">
+    <changelog>
+      <fix>
+        Ensure files in conf directory have CRLF line endings when using the
+        Windows installer. (kkolinko)
+      </fix>
+      <fix>
+        Allow special characters recognized by the Windows command-line shell to
+        be present in the names of CATALINA_HOME/_BASE and the current directory
+        used to call the Tomcat scripts. (kkolinko)
+      </fix>
+      <fix>
+        Don't use @Deprecated annotations in
+        <code>javax.servlet.jsp.JspContext</code> since the specification does
+        not include them in the API definition. (markt)
       </fix>
+      <add>
+        Improve the information in the JAR manifest files. (markt)
+      </add>
+    </changelog>
+  </subsection>
+</section>
+<section name="Tomcat 6.0.24 (jfclere)" rtext="released 2010-01-21">
+  <subsection name="Catalina">
+    <changelog>
       <fix>
-         Arange filter logic (jgclere) 
-         Several flaws in the handling of the 'Transfer-Encoding' header 
-         were found that prevented the recycling of a buffer. A remote 
-         attacker could trigger this flaw which would cause subsequent 
-         requests to fail and/or information to leak between requests. 
-         This flaw is mitigated if Tomcat is behind a reverse proxy 
-         (such as Apache httpd 2.2) as the proxy should reject the 
-         invalid transfer encoding header.
+        Correct TCK failures with security manager caused by the original fix
+        for <bug>47774</bug>. (markt)
       </fix>
     </changelog>
   </subsection>
@@ -126,7 +2672,7 @@
     </changelog>
   </subsection>
 </section>
-<section name="Tomcat 6.0.23 (jfclere)">
+<section name="Tomcat 6.0.23 (jfclere)" rtext="not released">
   <subsection name="Catalina">
     <changelog>
       <fix>
@@ -147,14 +2693,14 @@
         operation. Patch provided by sebb. (markt)
       </fix>
       <fix>
-        <bug>48417</bug>: Update French translations. Patch provided by Andr
+        <bug>48417</bug>: Update French translations. Patch provided by Andr&#233;
         Warnier. (markt/kkolinko)
       </fix>
       <fix>
         <bug>48421</bug>: Fix file descriptor and potential memory leak when a
         web application uses a local logging.properties file. Allow a web
-        applciation's log files to be deleted once the web application has been
-        stopped. (markt) 
+        application's log files to be deleted once the web application has been
+        stopped. (markt)
       </fix>
       <fix>
         <bug>48454</bug>: Ensure stderr is completely read before terminating
@@ -186,24 +2732,6 @@
         <bug>48470</bug>: Ensure Tomcat does not lock up if shut down under
         load. (markt)
       </fix>
-		<fix>
-		   Fix CVE-2011-2526. Prevent against infinit loops (HTTP NIO) and 
-			crashes (HTTP APR) if sendfile is configured to send more data
-			than is available in the file. (markt)
-		</fix>
-		<fix>
-		   Prevent NPEs when a socket is closed in non-error conditions after
-			sendfile processing when using the HTTP NIO connector. (markt)
-		</fix>
-        <fix>
-            Better adhereence to RFC2616 for content-length headers (markt)
-            CVE-2013-4286 patch applied by Red Hat
-        </fix>
-       <fix>
-         CVE-2014-0099 - Fix possible overflow when parsing long values 
-         from a byte array. Patch applied by Red Hat
-         (markt)
-       </fix>
     </changelog>
   </subsection>
   <subsection name="Jasper">
@@ -218,7 +2746,7 @@
     </fix>
   </changelog>
   </subsection>
-  <subsection name="Webapps">
+  <subsection name="Web applications">
     <changelog>
       <add>
         <bug>48530</bug>: Add information on the Manager Server Status page to
@@ -309,7 +2837,7 @@
       </fix>
       <fix>
         Remove duplicate mime-mapping entries in web.xml. Re-order entries
-        alphabetically to make it easier to identify duplicates. (markt) 
+        alphabetically to make it easier to identify duplicates. (markt)
       </fix>
       <update>
         Use a more sensible default (webapps) for a Host's appBase.
@@ -334,7 +2862,7 @@
       </fix>
       <fix>
         <bug>40380</bug>: Fix potential synchronization issue in
-        StandardSession.expire(). (markt) 
+        StandardSession.expire(). (markt)
       </fix>
       <fix>
         <bug>41059</bug>: Reduce chances of errors when ENABLE_CLEAR_REFERENCES
@@ -358,7 +2886,7 @@
       </fix>
       <fix>
         <bug>45403</bug>: Add additional checks on web application deployment
-        and do not swallow IO errors. (kkolinko) 
+        and do not swallow IO errors. (kkolinko)
       </fix>
       <fix>
         <bug>45785</bug>: Additional fix required for the extension validator.
@@ -389,7 +2917,7 @@
       </fix>
       <fix>
         <bug>47158</bug>: Fix some thread safety issues in the AccessLogValve.
-        (markt) 
+        (markt)
       </fix>
       <fix>
         <bug>47228</bug>: Correct French translations. Patch provided by sebb.
@@ -466,7 +2994,7 @@
       </fix>
       <fix>
         <bug>47918</bug>: Correct mbean descriptors for the host deployer. Patch
-        provided by Uwe Gnther. (markt)
+        provided by Uwe G&#252;nther. (markt)
       </fix>
       <fix>
         <bug>47930</bug>: Fix thread safety issues on session swap-in in the
@@ -497,7 +3025,7 @@
       </fix>
       <fix>
         <bug>48257</bug>: Correct error in Spanish translations. Patch provided
-        by Guillermo Gutirrez. (markt)
+        by Guillermo Guti&#233;rrez. (markt)
       </fix>
       <fix>
         <bug>48306</bug>, <bug>48307</bug>: Correct French translations. Patches
@@ -509,7 +3037,7 @@
       </fix>
       <fix>
         <bug>48413</bug>: Correct some French translations. Patch provided by
-        Andr Warnier. (markt)
+        Andr&#233; Warnier. (markt)
       </fix>
       <update>
         Deprecate the <code>caseSensitive</code> option on the
@@ -522,7 +3050,7 @@
       </fix>
       <add>
         Better logging for parameter decoding issues to help identify broken
-        requests. (markt) 
+        requests. (markt)
       </add>
       <update>
         Update Apache Commons Pool from 1.4 to 1.5.4. This update includes
@@ -552,7 +3080,7 @@
       <update>
         Various JNDI realm improvements for Active Directory. These include the
         ability to specify a default role, optional handling for nested roles
-        and an option to ignore PartialResultExceptions (markt). 
+        and an option to ignore PartialResultExceptions (markt).
       </update>
       <add>
         Expose Servlet Filters via JMX. Based on a patch by Xie Xiaodong as part
@@ -611,7 +3139,7 @@
       </update>
       <fix>
         Prevent NPE in JULI during shutdown when resources try to log messages
-        after JULI has been shutdown. (fhanik/kkolinko) 
+        after JULI has been shutdown. (fhanik/kkolinko)
       </fix>
       <add>
         Make the JULI FileHandler easier to extend. (fhanik)
@@ -630,8 +3158,8 @@
         Ensure log messages are not lost on shutdown. (markt)
       </fix>
       <add>
-        Provide an option to allow the equals character in unquoted cookie
-        values. (markt)
+        <bug>44679</bug>: Provide an option to allow the equals character in
+        unquoted cookie values. (markt)
       </add>
       <add>
         Add support for a connectionTimeout parameter to the JNDIRealm. (markt)
@@ -646,10 +3174,6 @@
   </subsection>
   <subsection name="Coyote">
     <changelog>
-	 	<fix>
-		<bug>42181</bug>: Better handling of edge conditions in chunk header
-		processing. Red Hat rhbz-857066 ported patch to 6.0.24.
-		</fix>
       <update>Implement <code>socket.unlockTimeout</code> attribute for NIO connector.</update>
       <update>
         Update version of native bundled in Windows installer
@@ -665,7 +3189,7 @@
       <fix>
         Align tcnative native and Java method names. (rjung)
       </fix>
-      <update>Dont report thread count from connector if an external executor is used.</update> 
+      <update>Dont report thread count from connector if an external executor is used.</update>
       <fix>
         <bug>39637</bug>: Enable the AJP connectors to correctly handle client
         certificate chains. Patch by Patrik Schnellmann. (markt)
@@ -686,7 +3210,7 @@
         <bug>47499</bug>: Don't swallow bind exceptions. (markt)
       </fix>
       <fix>
-        <bug>47744</bug>: Prevent a medium term memory leak if using SSl with
+        <bug>47744</bug>: Prevent a medium term memory leak if using SSL with
         the JSSE provider and also using a security manager. Based on a patch by
         Greg Vanore. (markt)
       </fix>
@@ -853,7 +3377,7 @@
       </fix>
     </changelog>
   </subsection>
-  <subsection name="Webapps">
+  <subsection name="Web applications">
     <changelog>
       <fix>
         <bug>41564</bug>: Add some documentation on installing Tomcat as a
@@ -900,7 +3424,7 @@
       <fix>
         <bug>47769</bug>: Clarify the JNDI docs with repect to use of
         &lt;resource-ref&gt; and related elements, specifically when they are
-        required and when they may be omitted. (markt) 
+        required and when they may be omitted. (markt)
       </fix>
       <fix>
         <bug>48381</bug>: Add information on how Tomcat treats host names to the
@@ -937,7 +3461,7 @@
       </update>
       <fix>
         Don't add blank lines to end of files when fixing line-endings for
-        tar.gz distribution. (markt) 
+        tar.gz distribution. (markt)
       </fix>
       <fix>
         Use explicit encoding during filtering operations when building Tomcat
@@ -984,7 +3508,7 @@
       <fix>
         Correct CVE-2009-3548. When installed via the Windows installer and
         using defaults, don't create an administrative user with a blank
-        password. Additionally, the administrative user is only created of the
+        password. Additionally, the administrative user is only created if the
         manager or host-manager web applications are selected for installation.
         (markt)
       </fix>
@@ -1105,7 +3629,7 @@
       </fix>
     </changelog>
   </subsection>
-  <subsection name="Webapps">
+  <subsection name="Web applications">
     <changelog>
       <fix>
         <bug>46509</bug>: Use correct link on error page in JSP security
@@ -1165,7 +3689,7 @@
       </fix>
       <fix>
         <bug>38553</bug>: Return 401 rather than 400 if client does not present
-        a certificate CLIENT-CERT authentication. (markt)        
+        a certificate CLIENT-CERT authentication. (markt)
       </fix>
       <fix>
         <bug>38570</bug>: When checking docBase against appBase, make sure we
@@ -1190,7 +3714,7 @@
         Fix read/write timeout of async comet operations
         (r719264)
       </update>
-      <update> 
+      <update>
         Implement async close behaviour for Comet/NIO.
         No-op for APR (same behavior as before)
         (r719262)
@@ -1265,7 +3789,7 @@
       </fix>
       <add>
         Provide full stacktrace and message when the ErrorReportValveClass can't
-        be instantiated. (funkman) 
+        be instantiated. (funkman)
       </add>
       <fix>
         <bug>45608</bug>: Make allocated servlet count synchronized to ensure
@@ -1274,7 +3798,7 @@
       </fix>
       <fix>
         <bug>45628</bug>: When checking MANIFEST dependancies, JARs without
-        dependencies should allows be considered to be full-filled. (markt) 
+        dependencies should allows be considered to be full-filled. (markt)
       </fix>
       <fix>
         <bug>45735</bug>: Improve ETag handling. (remm)
@@ -1297,7 +3821,7 @@
       </fix>
       <add>
         Add the CombinedRealm that enables authentication to be attempted
-        against multiple realms. (markt) 
+        against multiple realms. (markt)
       </add>
       <add>
         Add the LockOutRealm that enables a standard Realm to be wrapped with
@@ -1413,7 +3937,7 @@
         Fix possible synchronisation bottleneck in cookie creation. (markt)
       </fix>
       <fix>
-        Fix various spelling errors reported on the mailing lists. (markt) 
+        Fix various spelling errors reported on the mailing lists. (markt)
       </fix>
       <add>
         Make the logging manager and properties file configurable via
@@ -1562,7 +4086,7 @@
       <fix>
         <bug>46047</bug>: Include the path to the JAR when recording
         dependencies that are located inside a JAR file. Patch provided by
-        Cdric Mailleux. (markt)
+        C&#233;dric Mailleux. (markt)
       </fix>
       <fix>
         <bug>46381</bug>: Composite expressions used for attribute values must
@@ -1622,7 +4146,7 @@
       </fix>
     </changelog>
   </subsection>
-  <subsection name="Webapps">
+  <subsection name="Web applications">
     <changelog>
       <fix>
         <bug>45940</bug>: Correct name of username attribute for JDBC resources
@@ -1632,7 +4156,7 @@
         <bug>46035</bug>: Fix multiple typos in monitoring how to. (markt)
       </fix>
       <fix>
-        <bug>46067</bug>: Fix typos in Advanced IO how to. (markt) 
+        <bug>46067</bug>: Fix typos in Advanced IO how to. (markt)
       </fix>
       <fix>
         <bug>46115</bug>: Correct Manager UI to show that path is required when
@@ -1699,7 +4223,7 @@
       </fix>
       <fix>
         <bug>46366</bug>: Correct information in RUNNING.txt regarding use of
-        CATALINA_HOME and CATALINA_BASE. (markt) 
+        CATALINA_HOME and CATALINA_BASE. (markt)
       </fix>
       <fix>
         Use more useful JPDA defaults in catalina.bat. (markt)
@@ -1740,7 +4264,7 @@
       </fix>
     </changelog>
   </subsection>
-  <subsection name="Webapps">
+  <subsection name="Web applications">
     <changelog>
       <update>
         <bug>45323</bug>: Add note that context.xml files can only contain a
@@ -1786,7 +4310,7 @@
       </update>
       <update>
         Expose alwaysSend flag for message dispatch interceptor. (fhanik)
-      </update>  
+      </update>
       <fix>
         <bug>29936</bug>: Create digesters and parsers earlier so we aren't
         using the webapp class loader when we create them. (markt)
@@ -1943,7 +4467,7 @@
       </fix>
       <fix>
         <bug>44988</bug>: Use Java5 syntax for debug options. Patch provided
-        by Cedrik Lime. (markt)
+        by C&#233;drik Lime. (markt)
       </fix>
       <fix>
         <bug>45101</bug>: Format header dates obtained from
@@ -1993,7 +4517,7 @@
       </fix>
       <fix>
         <bug>44391</bug>: Correct handling of escaped values in SSI processing.
-        (markt) 
+        (markt)
       </fix>
       <fix>
         <bug>44392</bug>: HTML entities now handled correctly in SSI processing.
@@ -2014,7 +4538,7 @@
         connector. (markt)
       </fix>
       <update>
-        Log errors for AJP signoffs at DEBUG level, 
+        Log errors for AJP signoffs at DEBUG level,
         since it is harmless if mod_jk has hung up the phone. (billbarker)
       </update>
       <fix>
@@ -2068,8 +4592,8 @@
       </fix>
       <fix>
         <bug>45015</bug>: You can't use an unescaped quote if you quote the
-        value with that character. (markt/fhanik)  
-      </fix>  
+        value with that character. (markt/fhanik)
+      </fix>
       <add>
         Add HTML filtering of error messages for included resources in case the
         app has tried to include an unsafe URL that does not exist. This is
@@ -2078,7 +4602,7 @@
       </add>
     </changelog>
   </subsection>
-  <subsection name="Webapps">
+  <subsection name="Web applications">
     <changelog>
       <update>
         Update documentation to use correct version number, correct file paths
@@ -2099,7 +4623,7 @@
       <fix>
         <bug>43366</bug>: Provide backwards compatibility for manager sessions
         command. (markt)
-      </fix> 
+      </fix>
       <fix>
         <bug>44541</bug>: Document packetSize attribute for AJP connector.
         (markt)
@@ -2352,7 +4876,7 @@
       </fix>
     </changelog>
   </subsection>
-  <subsection name="Webapps">
+  <subsection name="Web applications">
     <changelog>
       <fix>
         <bug>43173</bug>: Fix typo in logging documentation regarding location
@@ -2551,7 +5075,7 @@
       </fix>
     </changelog>
   </subsection>
-  <subsection name="Webapps">
+  <subsection name="Web applications">
     <changelog>
       <fix>
         Fix WebDAV Servlet so it works correctly with MS clients. (markt)
@@ -2689,7 +5213,7 @@
       </fix>
     </changelog>
   </subsection>
-  <subsection name="Webapps">
+  <subsection name="Web applications">
     <changelog>
       <fix>
         Don't write error on System.out, use log() instead. (rjung)
@@ -2769,7 +5293,7 @@
       </fix>
     </changelog>
   </subsection>
-  <subsection name="Webapps">
+  <subsection name="Web applications">
     <changelog>
       <fix>
          Some examples webapp fixes. Submitted by Frank McCown. (remm)
@@ -2836,7 +5360,7 @@
       </fix>
     </changelog>
   </subsection>
-  <subsection name="Webapps">
+  <subsection name="Web applications">
     <changelog>
       <fix>
         <bug>42025</bug>: Update valve documentation to refer to correct regular
@@ -2846,7 +5370,7 @@
         Fix various paths in the manager webapps (remm)
       </fix>
       <add>
-        Session viewer and editor for the HTML manager. Submitted by Cdrik Lime. (remm)
+        Session viewer and editor for the HTML manager. Submitted by C&#233;drik Lime. (remm)
       </add>
       <add>
         Session handling tools for the manager. Submitted by Rainer Jung. (remm)
@@ -2978,7 +5502,7 @@
         Cleanup hello webapp from the docs and fix a XSS issue in the JSP.  (remm)
       </fix>
       <fix>
-        Examples webapp cleanup. Submitted by Takayuki Kaneko and Markus Schnhaber. (remm)
+        Examples webapp cleanup. Submitted by Takayuki Kaneko and Markus Sch&#246;nhaber. (remm)
       </fix>
       <fix>
         <bug>41289</bug>: Create configBase, since it is no longer created elsewhere.
@@ -3024,7 +5548,7 @@
       </fix>
     </changelog>
   </subsection>
-  <subsection name="Webapps">
+  <subsection name="Web applications">
     <changelog>
       <fix>
         Fix previous update to servlet 2.5 xsd to use correct declaration.
@@ -3123,7 +5647,7 @@
         Use 2.5 xsd in Tomcat webapps. (markt)
       </fix>
       <fix>
-        Compression filter improvements, submitted by Eric Hedstrm. (markt)
+        Compression filter improvements, submitted by Eric Hedstr&#246;m. (markt)
       </fix>
     </changelog>
   </subsection>
@@ -3263,7 +5787,7 @@
       </fix>
     </changelog>
   </subsection>
-  <subsection name="Webapps">
+  <subsection name="Web applications">
     <changelog>
       <docs>
         Add a virtual hosting how-to contributed by Hassan Schroeder. (markt)
@@ -3273,7 +5797,7 @@
       </update>
       <fix>
         <bug>39572</bug>: Improvements to CompressionFilter example provided by
-        Eric Hedstrm. (markt)
+        Eric Hedstr&#246;m. (markt)
       </fix>
     </changelog>
   </subsection>
@@ -3457,7 +5981,7 @@
       </fix>
     </changelog>
   </subsection>
-  <subsection name="Webapps">
+  <subsection name="Web applications">
     <changelog>
       <fix>
         <bug>40677</bug>: Update SSL documentation to indicate that PKCS11
--- webapps/docs/config/context.xml.orig	2014-07-15 15:26:24.078383000 -0400
+++ webapps/docs/config/context.xml	2014-07-17 17:50:17.145408000 -0400
@@ -29,6 +29,9 @@
 
 <body>
 
+<section name="Table of Contents">
+<toc/>
+</section>
 
 <section name="Introduction">
 
@@ -47,7 +50,7 @@
   unpacked contents, as described in the Servlet Specification (version
   2.2 or later).  For more information about web application archives,
   you can download the
-  <a href="http://java.sun.com/products/servlet/download.html">Servlet
+  <a href="http://wiki.apache.org/tomcat/Specifications">Servlet
   Specification</a>, and review the Tomcat
   <a href="../appdev/index.html">Application Developer's Guide</a>.</p>
 
@@ -61,46 +64,113 @@
   directory hierarchy).</p>
 
   <p>You may define as many <strong>Context</strong> elements as you
-  wish.  Each such Context MUST have a unique context path. In
+  wish.  Each such Context MUST have a unique context path within a virtual
+  host. In
   addition, a Context must be present with a context path equal to
   a zero-length string.  This Context becomes the <em>default</em>
   web application for this virtual host, and is used to process all
   requests that do not match any other Context's context path.</p>
 
-  <p><b>For Tomcat 6, unlike Tomcat 4.x, it is NOT recommended to place
+  <subsection name="Naming">
+  <p>When <code>autoDeploy</code> or <code>deployOnStartup</code> operations
+  are performed by a Host, the web application is specified by a context XML
+  file in <a href="host.html">Host</a>&apos;s <code>xmlBase</code>
+  directory or by a WAR file or a directory file in Host&apos;s
+  <code>appBase</code> directory.
+  In this case the context path is derived from the name of the file that
+  is being deployed. Consequently, the context path <strong>may not</strong>
+  be defined in a <code>META-INF/context.xml</code> embedded in
+  the application. There is, therefore, a close relationship between the
+  <em>context path</em> and
+  the <em>base file name</em> (the name minus <code>.war</code> or
+  <code>.xml</code> extension) of the file.</p>
+
+  <p>Let us assume that you want to deploy your application to respond to
+  requests to URIs starting with certain context path. According to the
+  Servlet specification, the context path may be an empty string, or a
+  string starting with '/'. The rules to define the names for this context
+  path are the following:</p>
+
+  <ul>
+    <li>If the context path is a zero length string, the <em>base name</em> is
+    <code>"ROOT"</code> (uppercase)</li>
+    <li>If the context path is not a zero length string, the <em>base
+    name</em> is the context path with the leading '/' removed and any
+    remaining '/' characters in the path replaced with '#'.</li>
+  </ul>
+
+  <p>To help clarify these rules, some examples are given in the following
+  table.</p>
+
+  <table class="detail-table">
+    <tr>
+      <th>Context Path</th>
+      <th>Base File Name</th>
+    </tr>
+    <tr><td>/foo</td><td>foo</td></tr>
+    <tr>
+      <td>/foo/bar</td><td>foo#bar</td>
+    </tr>
+    <tr>
+      <td><i>Empty String</i></td>
+      <td>ROOT</td>
+    </tr>
+  </table>
+
+  <p>If you want to deploy a WAR file or a directory using a context path that
+  is not related to the base file name then one of the following options must
+  be used to prevent double-deployment:
+  </p>
+  <ul>
+  <li>Disable autoDeploy and deployOnStartup and define all
+  <strong>Context</strong>s in server.xml</li>
+  <li>Locate the WAR and/or directory outside of the Host&apos;s appBase and use
+      a context.xml file with a docBase attribute to define it.</li>
+  </ul>
+  </subsection>
+
+  <subsection name="Defining a context">
+  <p><b>It is NOT recommended to place
   &lt;Context&gt; elements directly in the server.xml file.</b> This
   is because it makes modifying the <strong>Context</strong> configuration
   more invasive since the main <code>conf/server.xml</code> file cannot be
   reloaded without restarting Tomcat.</p>
 
-  <p><strong>Context</strong> elements may be explicitly defined:
+  <p>Individual <strong>Context</strong> elements may be explicitly defined:
+  </p>
   <ul>
-  <li>In the <code>$CATALINA_BASE/conf/context.xml</code> file: 
-  the Context element information will be loaded by all webapps.</li>
-  <li>In the 
-  <code>$CATALINA_BASE/conf/[enginename]/[hostname]/context.xml.default</code>
-  file: the Context element information will be loaded by all webapps of that
-  host.</li>
+  <li>In an individual file at <code>/META-INF/context.xml</code> inside the
+  application files. In Tomcat 6 this file is automatically copied to
+  <code>$CATALINA_BASE/conf/[enginename]/[hostname]/</code> and renamed to
+  application&apos;s base file name plus a ".xml" extension.
+  (This automated copying became optional in Tomcat 7).
+  </li>
   <li>In individual files (with a ".xml" extension) in the
   <code>$CATALINA_BASE/conf/[enginename]/[hostname]/</code> directory.
-  The name of the file (less the .xml extension) will be used as the
-  context path. Multi-level context paths may be defined using #, e.g.
-  <code>foo#bar.xml</code> for a context path of <code>/foo/bar</code>. The
-  default web application may be defined by using a file called
-  <code>ROOT.xml</code>.</li>
-  <li>Only if a context file does not exist for the application in the 
-  <code>$CATALINA_BASE/conf/[enginename]/[hostname]/</code>, in an individual
-  file at <code>/META-INF/context.xml</code> inside the application files. If
-  the web application is packaged as a WAR then
-  <code>/META-INF/context.xml</code> will be copied to
-  <code>$CATALINA_BASE/conf/[enginename]/[hostname]/</code> and renamed to
-  match the application's context path. Once this file exists, it will not be
-  replaced if a new WAR with a newer <code>/META-INF/context.xml</code> is
-  placed in the host's appBase.</li>
+  The context path will be derived from the base name of the file
+  (the file name less the .xml extension). This file will always take precedence
+  over any context.xml file packaged in the web application&apos;s META-INF
+  directory.</li>
   <li>Inside a <a href="host.html">Host</a> element in the main
   <code>conf/server.xml</code>.</li>
   </ul>
+
+  <p>Default <strong>Context</strong> elements may be defined that apply to
+  multiple web applications. Configuration for an individual web application
+  will override anything configured in one of these defaults. Any nested
+  elements, e.g. &lt;Resource&gt; elements, that are defined in a default
+  <strong>Context</strong> will be created once for each
+  <strong>Context</strong> to which the default applies. They will <b>not</b> be
+  shared between <strong>Context</strong> elements.
   </p>
+  <ul>
+  <li>In the <code>$CATALINA_BASE/conf/context.xml</code> file:
+  the Context element information will be loaded by all web applications.</li>
+  <li>In the
+  <code>$CATALINA_BASE/conf/[enginename]/[hostname]/context.xml.default</code>
+  file: the Context element information will be loaded by all web applications
+  of that host.</li>
+  </ul>
 
   <p>With the exception of server.xml, files that define <strong>Context
   </strong> elements may only define a single <strong>Context</strong> element.
@@ -108,11 +178,17 @@
 
   <p>In addition to explicitly specified Context elements, there are
   several techniques by which Context elements can be created automatically
-  for you.  See <a href="host.html#Automatic Application Deployment">
+  for you.  See <a href="host.html#Automatic_Application_Deployment">
   Automatic Application Deployment</a> and
-  <a href="host.html#User Web Applications">User Web Applications</a>
+  <a href="host.html#User_Web_Applications">User Web Applications</a>
   for more information.</p>
 
+  <p>To define multiple contexts that use a single WAR file or directory,
+  use one of the options described in the <a href="#Naming">Naming</a>
+  section above for creating a <strong>Context</strong> that has a path
+  that is not related to the base file name.</p>
+  </subsection>
+
 </section>
 
 
@@ -164,6 +240,17 @@
         return <code>null</code>.</p>
       </attribute>
 
+      <attribute name="disableURLRewriting" required="false">
+        <p>Set to <code>true</code> to disable support for using URL rewriting
+        to track session IDs for clients of this Context. URL rewriting is an
+        optional component of the servlet 2.5 specification but disabling URL
+        rewriting will result in non-compliant behaviour since the specification
+        requires that there <em>must</em> be a way to retain sessions if the
+        client doesn't allow session cookies. If not specified, the
+        specification compliant default value of <code>false</code> will be
+        used.</p>
+      </attribute>
+
       <attribute name="docBase" required="true">
         <p>The <em>Document Base</em> (also known as the <em>Context
         Root</em>) directory for this web application, or the pathname
@@ -172,9 +259,13 @@
         an absolute pathname for this directory or WAR file, or a pathname
         that is relative to the <code>appBase</code> directory of the
         owning <a href="host.html">Host</a>.</p>
-        <p>The value of this field must not be set when the Context is
-        configured using a <code>META-INF/context.xml</code> file as it will be
-        inferred by the automatic deployment process.</p>
+        <p>The value of this field must not be set unless the Context element is
+        defined in server.xml or the <code>docBase</code> is not located under
+        the <a href="host.html">Host</a>&apos;s <code>appBase</code>.</p>
+        <p>If a symbolic link is used for docBase then changes to the
+        symbolic link will only be effective after a Tomcat restart or
+        by undeploying and redeploying the context. A context reload is not
+        sufficient.</p>
       </attribute>
 
       <attribute name="override" required="false">
@@ -182,10 +273,6 @@
         Context element override any corresponding settings in either the global
         or <a href="host.html">Host</a> default contexts.  By default, settings
         from a default context will be used.</p>
-        <p>If a symbolic link is used for docBase then changes to the
-        symbolic link will only be effective after a Tomcat restart or
-        by undeploying and redeploying the context. A context reload is not
-        sufficient.</p>
       </attribute>
 
       <attribute name="privileged" required="false">
@@ -206,9 +293,15 @@
         If you specify a context path of an empty string (""), you are
         defining the <em>default</em> web application for this Host, which
         will process all requests not assigned to other Contexts.</p>
-        <p>The value of this field must not be set except when statically
-        defining a Context in server.xml, as it will be inferred from the
-        filenames used for either the .xml context file or the docBase.</p>
+        <p>This attribute must only be used when statically defining a Context
+        in server.xml. In all other circumstances, the path will be inferred
+        from the filenames used for either the .xml context file or the docBase.
+        </p>
+        <p>Even when statically defining a Context in server.xml, this attribute
+        must not be set unless either the docBase is not located under the
+        <a href="host.html">Host</a>&apos;s <code>appBase</code> or both
+        <code>deployOnStartup</code> and <code>autoDeploy</code> are false. If
+        this rule is not followed, double deployment is likely to result.</p>
       </attribute>
 
       <attribute name="reloadable" required="false">
@@ -224,18 +317,88 @@
         on demand.</p>
       </attribute>
 
-      <attribute name="wrapperClass" required="false">
-        <p>Java class name of the <code>org.apache.catalina.Wrapper</code>
-        implementation class that will be used for servlets managed by this
-        Context.  If not specified, a standard default value will be used.</p>
+      <attribute name="sessionCookieDomain" required="false">
+        <p>The domain to be used for all session cookies created for this
+        Context. If not set, no domain will be specified for session cookies.
+        </p>
+      </attribute>
+      
+      <attribute name="sessionCookieName" required="false">
+        <p>The name to be used for all session cookies created for this
+        Context. If not set, the default of JSESSIONID will be used. Note that
+        this default will be overridden by the
+        <strong>org.apache.catalina.SESSION_COOKIE_NAME</strong> system
+        property.</p>
+      </attribute>
+
+      <attribute name="sessionCookiePath" required="false">
+        <p>The path to be used for all session cookies created for this
+        Context. If not set, the context path will be used. Note that this will
+        be overridden by the <strong>emptySessionPath</strong> attribute on the
+        connector used to access this Context.</p>
       </attribute>
       
+      <attribute name="tldValidation" required="false">
+        <p>If the value of this flag is <code>true</code>, the TLD files
+        will be XML validated on context startup.  If the
+        <code>org.apache.catalina.STRICT_SERVLET_COMPLIANCE</code>
+        <a href="systemprops.html">system property</a> is set to
+        <code>true</code>, the default value of this attribute will be
+        <code>true</code>, else the default value will be <code>false</code>.
+        Setting this attribute to <code>true</code> will incur a performance
+        penalty.</p>
+      </attribute>
+
       <attribute name="useHttpOnly" required="false">
        <p>Should the HttpOnly flag be set on session cookies to prevent client
           side script from accessing the session ID? Defaults to
           <code>false</code>.</p>
       </attribute>
+
+      <attribute name="wrapperClass" required="false">
+        <p>Java class name of the <code>org.apache.catalina.Wrapper</code>
+        implementation class that will be used for servlets managed by this
+        Context.  If not specified, a standard default value will be used.</p>
+      </attribute>
       
+      <attribute name="xmlBlockExternal" required="false">
+        <p>If the value of this flag is <code>true</code>, the parsing of
+        <code>web.xml</code>, <code>web-fragment.xml</code>, <code>*.tld</code>,
+        <code>*.jspx</code>, <code>*.tagx</code> and <code>tagPlugins.xml</code>
+        files for this web application will not permit external entities to be
+        loaded. If a <code>SecurityManager</code> is configured then the default
+        value of this attribute will be <code>true</code>, else the default
+        value will be <code>false</code>.</p>
+      </attribute>
+
+      <attribute name="xmlNamespaceAware" required="false">
+        <p>If the value of this flag is <code>true</code>, the parsing of the
+        <code>web.xml</code> file for this web application will be
+        namespace-aware. Note that <code>*.tld</code>, <code>*.jspx</code> and
+        <code>*.tagx</code> files are always parsed using a namespace-aware
+        parser and that the <code>tagPlugins.xml</code> file (if any) is never
+        parsed using a namespace-aware parser. Note also that if you turn this
+        flag on, you should probably also turn <code>xmlValidation</code> on. If
+        the <code>org.apache.catalina.STRICT_SERVLET_COMPLIANCE</code>
+        <a href="systemprops.html">system property</a> is set to
+        <code>true</code>, the default value of this attribute will be
+        <code>true</code>, else the default value will be <code>false</code>.
+        Setting this attribute to <code>true</code> will incur a performance
+        penalty.</p>
+      </attribute>
+
+      <attribute name="xmlValidation" required="false">
+        <p>If the value of this flag is <code>true</code>, the parsing of the
+        <code>web.xml</code> file for this web application will use a validating
+        parser. If the
+        <code>org.apache.catalina.STRICT_SERVLET_COMPLIANCE</code>
+        <a href="systemprops.html">system property</a> is set to
+        <code>true</code>, the default value of this attribute will be
+        <code>true</code>, else the default value will be <code>false</code>.
+        Setting this attribute to <code>true</code> will incur a performance
+        penalty.</p>
+      </attribute>
+
 
     </attributes>
 
@@ -265,9 +428,14 @@
       <attribute name="antiJARLocking" required="false">
         <p>If true, the Tomcat classloader will take extra measures to avoid
         JAR file locking when resources are accessed inside JARs through URLs.
-        This will impact startup time of applications, but could prove to be useful
-        on platforms or configurations where file locking can occur.
+        This will impact startup time of applications, but could prove to be
+        useful on platforms or configurations where file locking can occur.
         If not specified, the default value is <code>false</code>.</p>
+
+        <p><code>antiJARLocking</code> is a subset of
+        <code>antiResourceLocking</code> and therefore, to prevent duplicate
+        work and possible issues, only one of these attributes should be set
+        to <code>true</code> at any one time.</p>
       </attribute>
 
       <attribute name="antiResourceLocking" required="false">
@@ -277,19 +445,22 @@
         or configurations where file locking can occur.
         If not specified, the default value is <code>false</code>.</p>
    
-        <p>Please note that setting this to <code>true</code> has some side effects,
-        including the disabling of JSP reloading in a running server: see
-        <a href="http://issues.apache.org/bugzilla/show_bug.cgi?id=37668">Bugzilla 37668</a>.
-        </p>
+        <p><code>antiJARLocking</code> is a subset of
+        <code>antiResourceLocking</code> and therefore, to prevent duplicate
+        work and possible issues, only one of these attributes should be set
+        to <code>true</code> at any one time.</p>
+
+        <p>Please note that setting this to <code>true</code> has some side
+        effects, including the disabling of JSP reloading in a running server:
+        see <a href="http://issues.apache.org/bugzilla/show_bug.cgi?id=37668">
+        Bugzilla 37668</a>.</p>
 
-        <p>
-        Please note that setting this flag to true in applications that are
+        <p>Please note that setting this flag to true in applications that are
         outside the appBase for the Host (the <code>webapps</code> directory
-        by default) will cause the application to be
-        <strong>deleted</strong> on Tomcat shutdown.  You probably don't want to
-        do this, so think twice before setting antiResourceLocking=true on a webapp
-        that's outside the appBase for its Host.
-        </p>
+        by default) will cause the application to be <strong>deleted</strong> on
+        Tomcat shutdown.  You probably don't want to do this, so think twice 
+        before setting antiResourceLocking=true on a webapp that's outside the
+        appBase for its Host.</p>
       </attribute>
 
       <attribute name="cacheMaxSize" required="false">
@@ -319,8 +490,8 @@
       </attribute>
 
       <attribute name="caseSensitive" required="false">
-        <p>Deprecated. This option will be removed in Tomcat 7 onwards where the
-        default of <code>true</code> will always be used.</p>
+        <p><strong>Deprecated.</strong> This option is removed in Tomcat 7
+        onwards where the default of <code>true</code> is always used.</p>
         <p>If the value of this flag is <code>false</code>, all case sensitivity
         checks will be disabled. If not 
         specified, the default value of the flag is <code>true</code>.</p>
@@ -330,6 +501,18 @@
         disclosure, among other security problems.</b></p>
       </attribute>
 
+      <attribute name="clearReferencesHttpClientKeepAliveThread" required = "false">
+        <p>If <code>true</code> and an <code>sun.net.www.http.HttpClient</code>
+        keep-alive timer thread has been started by this web application and is
+        still running, Tomcat will change the context class loader for that
+        thread from the current <code>WebappClassLoader</code> to
+        <code>WebappClassLoader#parent</code> to prevent a memory leak. Note
+        that the keep-alive timer thread will stop on its own once the
+        keep-alives all expire however, on a busy system that might not happen
+        for some time. If not specified, the default value of
+        <code>true</code> will be used.</p>
+      </attribute>
+
       <attribute name="clearReferencesStopThreads" required = "false">
         <p>If <code>true</code>, Tomcat attempts to terminate threads that have
         been started by the web application. Stopping threads is performed via
@@ -340,6 +523,23 @@
         default value of <code>false</code> will be used.</p>
       </attribute>
 
+      <attribute name="clearReferencesStopTimerThreads" required = "false">
+        <p>If <code>true</code>, Tomcat attempts to terminate
+        <code>java.util.Timer</code> threads that have been started by the web
+        application. Unlike standard threads, timer threads can be stopped
+        safely although there may still be side-effects for the application. If
+        not specified, the default value of <code>false</code> will be used.</p>
+      </attribute>
+
+      <attribute name="clearReferencesThreadLocals" required="false">
+        <p>If <code>true</code>, Tomcat attempts to clear any ThreadLocal
+        objects that are instances of classes loaded by this class loader.
+        Failure to remove any such objects will result in a memory leak on web
+        application stop, undeploy or reload.  If not specified, the default
+        value of <code>false</code> will be used since the clearing of the
+        ThreadLocal objects is not performed in a thread-safe manner.</p>
+      </attribute>
+
       <attribute name="processTlds" required="false">
         <p>Whether the context should process TLDs on startup.  The default
         is true.  The false setting is intended for special cases
@@ -353,26 +553,9 @@
         of the flag is <code>false</code>.</p>
       </attribute>
 
-      <attribute name="tldNamespaceAware" required="false">
-        <p>If the value of this flag is <code>true</code>, the TLD files
-        XML validation will be namespace-aware.  If you turn this flag on,
-        you should probably also turn <code>tldValidation</code> on.  The
-        default value for this flag is <code>false</code>, and setting it
-        to true will incur a performance penalty.
-        </p>
-      </attribute>
-
-      <attribute name="tldValidation" required="false">
-        <p>If the value of this flag is <code>true</code>, the TLD files
-        will be XML validated on context startup.  The default value for
-        this flag is <code>false</code>, and setting it to true will incur
-        a performance penalty.</p>
-      </attribute>
-
       <attribute name="unloadDelay" required="false">
-        <p>Amount of ms that the container will wait for servlets to unload.
-        If not specified, the default value of the flag is <code>2000</code> 
-        ms.</p>
+        <p>Number of ms that the container will wait for servlets to unload.
+        If not specified, the default value is <code>2000</code> ms.</p>
       </attribute>
 
       <attribute name="unpackWAR" required="false">
@@ -467,7 +650,7 @@
     by nesting a <a href="valve.html">Valve</a> element like this:</p>
 
 <source>
-&lt;Context path="/examples" ...&gt;
+&lt;Context&gt;
   ...
   &lt;Valve className="org.apache.catalina.valves.AccessLogValve"
          prefix="localhost_access_log." suffix=".txt"
@@ -521,7 +704,7 @@
     <code>&lt;Parameter&gt;</code> elements inside this element.  For
     example, you can create an initialization parameter like this:</p>
 <source>
-&lt;Context ...&gt;
+&lt;Context&gt;
   ...
   &lt;Parameter name="companyName" value="My Company, Incorporated"
          override="false"/&gt;
@@ -580,7 +763,7 @@
     <code>&lt;Environment&gt;</code> entries inside this element.  For
     example, you can create an environment entry like this:</p>
 <source>
-&lt;Context ...&gt;
+&lt;Context&gt;
   ...
   &lt;Environment name="maxExemptions" value="10"
          type="java.lang.Integer" override="false"/&gt;
@@ -593,7 +776,7 @@
     </p>
 <source>
 &lt;env-entry&gt;
-  &lt;env-entry-name&gt;maxExemptions&lt;/param-name&gt;
+  &lt;env-entry-name&gt;maxExemptions&lt;/env-entry-name&gt;
   &lt;env-entry-value&gt;10&lt;/env-entry-value&gt;
   &lt;env-entry-type&gt;java.lang.Integer&lt;/env-entry-type&gt;
 &lt;/env-entry&gt;
@@ -657,7 +840,7 @@
     lifecycle events.  Configuration of such a listener looks like this:</p>
 
 <source>
-&lt;Context path="/examples" ...&gt;
+&lt;Context&gt;
   ...
   &lt;Listener className="com.mycompany.mypackage.MyListener" ... &gt;
   ...
@@ -679,19 +862,18 @@
     <a href="engine.html">Engine</a>, <a href="host.html">Host</a>, or
     <a href="context.html">Context</a> element.  The remote address or name
     will be checked against a configured list of "accept" and/or "deny"
-    filters, which are defined using the Regular Expression syntax supported
-    by the <a href="http://jakarta.apache.org/regexp/">Jakarta Regexp</a>
-    regular expression library.  Requests that come from locations that are
+    filters, which are defined using <code>java.util.regex</code> Regular
+    Expression syntax.  Requests that come from locations that are
     not accepted will be rejected with an HTTP "Forbidden" error.
     Example filter declarations:</p>
 
 <source>
-&lt;Context path="/examples" ...&gt;
+&lt;Context&gt;
   ...
   &lt;Valve className="org.apache.catalina.valves.RemoteHostValve"
-         allow="*.mycompany.com,www.yourcompany.com"/&gt;
+         allow=".*\.mycompany\.com|www\.yourcompany\.com"/&gt;
   &lt;Valve className="org.apache.catalina.valves.RemoteAddrValve"
-         deny="192.168.1.*"/&gt;
+         deny="192\.168\.1\.\d+"/&gt;
   ...
 &lt;/Context&gt;
 </source>
@@ -715,7 +897,7 @@
 
     <p>For example, you can create a resource definition like this:</p>
 <source>
-&lt;Context ...&gt;
+&lt;Context&gt;
   ...
   &lt;Resource name="jdbc/EmployeeDB" auth="Container"
             type="javax.sql.DataSource"
@@ -790,7 +972,7 @@
 
     <p>For example, you can create a resource link like this:</p>
 <source>
-&lt;Context ...&gt;
+&lt;Context&gt;
   ...
   &lt;ResourceLink name="linkToGlobalResource"
             global="simpleValue"
@@ -819,8 +1001,83 @@
         application when it performs a lookup for this resource link.</p>
       </attribute>
 
+      <attribute name="factory" required="false">
+        <p>The fully qualified Java class name for the class creating these objects.
+        This class should implement the <code>javax.naming.spi.ObjectFactory</code> interface.</p>
+      </attribute>
+    </attributes>
+
+    <p>When the attribute <code>factory=&quot;org.apache.naming.factory.DataSourceLinkFactory&quot;</code> the resource link can be used with
+       two additional attributes to allow a shared data source to be used with different credentials.
+       When these two additional attributes are used in combination with the <code>javax.sql.DataSource</code>
+       type, different contexts can share a global data source with different credentials.
+       Under the hood, what happens is that a call to <a href="http://docs.oracle.com/javase/6/docs/api/javax/sql/DataSource.html#getConnection()"><code>getConnection()</code></a>
+       is simply translated to a call <a href="http://docs.oracle.com/javase/6/docs/api/javax/sql/DataSource.html#getConnection(java.lang.String,%20java.lang.String)">
+       <code>getConnection(username, password)</code></a> on the global data source. This is an easy way to get code to be transparent to what schemas are being used,
+       yet be able to control connections (or pools) in the global configuration. 
+    </p>
+    <attributes>
+
+      <attribute name="username" required="false">
+        <p><code>username</code> value for the <code>getConnection(username, password)</code>
+           call on the linked global DataSource.
+        </p>
+      </attribute>
+
+      <attribute name="password" required="false">
+        <p><code>password</code> value for the <code>getConnection(username, password)</code>
+           call on the linked global DataSource.
+        </p>
+      </attribute>
+
     </attributes>
+    <p>Shared Data Source Example:</p>
+    <p><strong>Warning:</strong> This feature works only if the global DataSource
+supports <code>getConnection(username, password)</code> method.
+<a href="http://commons.apache.org/dbcp/">Apache Commons DBCP</a> pool that
+Tomcat uses by default does not support it. See its Javadoc for
+<code>BasicDataSource</code> class.
+<a href="http://tomcat.apache.org/tomcat-7.0-doc/jdbc-pool.html">Apache Tomcat JDBC pool</a>
+(included with Tomcat 7 and later) does support it,
+but by default this support is disabled and can be enabled by
+<code>alternateUsernameAllowed</code> attribute. See its documentation
+for details. The example below uses Apache Tomcat JDBC pool.</p>
+<source>
+&lt;GlobalNamingResources&gt;
+  ...
+  &lt;Resource name=&quot;sharedDataSource&quot;
+            global=&quot;sharedDataSource&quot;
+            type=&quot;javax.sql.DataSource&quot;
+            factory=&quot;org.apache.tomcat.jdbc.pool.DataSourceFactory&quot;
+            alternateUsernameAllowed=&quot;true&quot;
+            username=&quot;bar&quot;
+            password=&quot;barpass&quot;
+            ...
+  ...
+&lt;/GlobalNamingResources&gt;
 
+&lt;Context path=&quot;/foo&quot;...&gt;
+  ...
+  &lt;ResourceLink 
+            name=&quot;appDataSource&quot;
+            global=&quot;sharedDataSource&quot;
+            type=&quot;javax.sql.DataSource&quot;
+            factory=&quot;org.apache.naming.factory.DataSourceLinkFactory&quot;
+            username=&quot;foo&quot;
+            password=&quot;foopass&quot;
+  ...
+&lt;/Context&gt;
+&lt;Context path=&quot;/bar&quot;...&gt;
+  ...
+  &lt;ResourceLink 
+            name=&quot;appDataSource&quot;
+            global=&quot;sharedDataSource&quot;
+            type=&quot;javax.sql.DataSource&quot;
+  ...
+&lt;/Context&gt;
+</source>    
+    <p>When a request for <code>getConnection()</code> is made in the <code>/foo</code> context, the request is translated into
+       <code>getConnection(&quot;foo&quot;,&quot;foopass&quot;)</code>, while a request in the <code>/bar</code> gets passed straight through.</p>
   </subsection>
 
   <subsection name="Transaction">
--- java/org/apache/catalina/util/LifecycleSupport.java.orig	2014-07-16 11:57:29.820551000 -0400
+++ java/org/apache/catalina/util/LifecycleSupport.java	2014-07-17 17:50:17.156403000 -0400
@@ -29,7 +29,7 @@
  * registered LifecycleListeners.
  *
  * @author Craig R. McClanahan
- * @version $Id: LifecycleSupport.java 771009 2009-05-03 01:15:41Z markt $
+ * @version $Id: LifecycleSupport.java 999945 2010-09-22 13:48:58Z markt $
  */
 
 public final class LifecycleSupport {
@@ -69,7 +69,13 @@
     
     private final Object listenersLock = new Object(); // Lock object for changes to listeners
 
-
+    /**
+     * Tracks the current state of lifecycle object based on the events that
+     * are fired. As far as possible, matches the state names used in Tomcat 7
+     * for consistency. 
+     */
+    private String state = "NEW";
+    
     // --------------------------------------------------------- Public Methods
 
 
@@ -113,6 +119,23 @@
      */
     public void fireLifecycleEvent(String type, Object data) {
 
+        if (Lifecycle.INIT_EVENT.equals(type)) {
+            state = "INITIALIZED";
+        } else if (Lifecycle.BEFORE_START_EVENT.equals(type)) {
+            state = "STARTING_PREP";
+        } else if (Lifecycle.START_EVENT.equals(type)) {
+            state = "STARTING";
+        } else if (Lifecycle.AFTER_START_EVENT.equals(type)) {
+            state = "STARTED";
+        } else if (Lifecycle.BEFORE_STOP_EVENT.equals(type)) {
+            state = "STOPPING_PREP";
+        } else if (Lifecycle.STOP_EVENT.equals(type)) {
+            state = "STOPPING";
+        } else if (Lifecycle.AFTER_STOP_EVENT.equals(type)) {
+            state = "STOPPED";
+        } else if (Lifecycle.DESTROY_EVENT.equals(type)) {
+            state = "DESTROYED";
+        }
         LifecycleEvent event = new LifecycleEvent(lifecycle, type, data);
         LifecycleListener interested[] = listeners;
         for (int i = 0; i < interested.length; i++)
@@ -150,5 +173,7 @@
 
     }
 
-
+    public String getState() {
+        return state;
+    }
 }
--- java/org/apache/jasper/servlet/JspCServletContext.java.orig	2014-07-16 12:20:57.991303000 -0400
+++ java/org/apache/jasper/servlet/JspCServletContext.java	2014-07-17 17:50:17.163405000 -0400
@@ -5,9 +5,9 @@
  * The ASF licenses this file to You under the Apache License, Version 2.0
  * (the "License"); you may not use this file except in compliance with
  * the License.  You may obtain a copy of the License at
- * 
+ *
  *      http://www.apache.org/licenses/LICENSE-2.0
- * 
+ *
  * Unless required by applicable law or agreed to in writing, software
  * distributed under the License is distributed on an "AS IS" BASIS,
  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
@@ -28,6 +28,7 @@
 import java.util.Hashtable;
 import java.util.Set;
 import java.util.Vector;
+import java.util.concurrent.ConcurrentHashMap;
 
 import javax.servlet.RequestDispatcher;
 import javax.servlet.Servlet;
@@ -55,6 +56,12 @@
 
 
     /**
+     * Servlet context initialization parameters.
+     */
+    private final ConcurrentHashMap<String,String> myParameters;
+
+
+    /**
      * The log writer we will write log messages to.
      */
     protected PrintWriter myLogWriter;
@@ -78,6 +85,7 @@
     public JspCServletContext(PrintWriter aLogWriter, URL aResourceBaseURL) {
 
         myAttributes = new Hashtable();
+        myParameters = new ConcurrentHashMap<String,String>();
         myLogWriter = aLogWriter;
         myResourceBaseURL = aResourceBaseURL;
 
@@ -137,9 +145,7 @@
      * @param name Name of the requested parameter
      */
     public String getInitParameter(String name) {
-
-        return (null);
-
+        return myParameters.get(name);
     }
 
 
@@ -148,9 +154,7 @@
      * parameters.
      */
     public Enumeration getInitParameterNames() {
-
-        return (new Vector().elements());
-
+        return myParameters.keys();
     }
 
 
@@ -218,8 +222,8 @@
         }
 
     }
-            
-            
+
+
     /**
      * Return a request dispatcher for the specified context-relative path.
      *
@@ -437,5 +441,7 @@
     }
 
 
-
+    public boolean setInitParameter(String name, String value) {
+        return myParameters.putIfAbsent(name, value) == null;
+    }
 }
--- java/org/apache/jasper/compiler/Parser.java.orig	2014-07-16 12:33:19.030818000 -0400
+++ java/org/apache/jasper/compiler/Parser.java	2014-07-17 17:50:17.170404000 -0400
@@ -242,13 +242,16 @@
 
         String ret = null;
         try {
-            char quote = 0;
-            if (watch.length() == 1) {
-                quote = watch.charAt(0);
-            }
+            char quote = watch.charAt(watch.length() - 1);
+            
+            // If watch is longer than 1 character this is a scripting
+            // expression and EL is always ignored
+            boolean isElIgnored =
+                pageInfo.isELIgnored() || watch.length() > 1;
+            
             ret = AttributeParser.getUnquoted(reader.getText(start, stop),
-                    quote, pageInfo.isELIgnored(),
-						  pageInfo.isDeferredSyntaxAllowedAsLiteral());
+                    quote, isElIgnored,
+                    pageInfo.isDeferredSyntaxAllowedAsLiteral());
         } catch (IllegalArgumentException iae) {
             err.jspError(start, iae.getMessage());
         }
@@ -381,7 +384,8 @@
                     if (impl == null) {
                         String[] location = ctxt.getTldLocation(uri);
                         impl = new TagLibraryInfoImpl(ctxt, parserController, pageInfo,
-                                prefix, uri, location, err);
+                                prefix, uri, location, err,
+                                reader.mark());
                         if (ctxt.getOptions().isCaching()) {
                             ctxt.getOptions().getCache().put(uri, impl);
                         }
@@ -1246,7 +1250,7 @@
 
     /*
      * Parse for a template text string until '<' or "${" or "#{" is encountered,
-     * recognizing escape sequences "\%", "\$", and "\#".
+     * recognizing escape sequences "<\%", "\$", and "\#".
      */
     private void parseTemplateText(Node parent) throws JasperException {
 
@@ -1263,6 +1267,7 @@
         }
 
         while (reader.hasMoreInput()) {
+            int prev = ch;
             ch = reader.nextChar();
             if (ch == '<') {
                 reader.pushChar();
@@ -1287,8 +1292,9 @@
                 }
                 char next = (char) reader.peekChar();
                 // Looking for \% or \$ or \#
-                if (next == '%' || ((next == '$' || next == '#') &&
-                        !pageInfo.isELIgnored())) {
+                if ((prev == '<' && next == '%') ||
+                        ((next == '$' || next == '#') &&
+                                !pageInfo.isELIgnored())) {
                     ch = reader.nextChar();
                 }
             }
@@ -1407,9 +1413,11 @@
             parseXMLScriptlet(parent);
         } else if (reader.matches("<jsp:text")) {
             parseXMLTemplateText(parent);
-        } else if (reader.matches("${") && !pageInfo.isELIgnored()) {
+        } else if (!pageInfo.isELIgnored() && reader.matches("${")) {
             parseELExpression(parent, '$');
-        } else if (reader.matches("#{") && !pageInfo.isELIgnored()) {
+        } else if (!pageInfo.isELIgnored()
+                && !pageInfo.isDeferredSyntaxAllowedAsLiteral()
+                && reader.matches("#{")) {
             parseELExpression(parent, '#');
         } else if (reader.matches("<jsp:")) {
             parseStandardAction(parent);
@@ -1454,9 +1462,11 @@
             err.jspError(reader.mark(), "jsp.error.no.scriptlets");
         } else if (reader.matches("<jsp:text")) {
             parseXMLTemplateText(parent);
-        } else if (reader.matches("${")) {
+        } else if (!pageInfo.isELIgnored() && reader.matches("${")) {
             parseELExpression(parent, '$');
-        } else if (reader.matches("#{")) {
+        } else if (!pageInfo.isELIgnored()
+                && !pageInfo.isDeferredSyntaxAllowedAsLiteral()
+                && reader.matches("#{")) {
             parseELExpression(parent, '#');
         } else if (reader.matches("<jsp:")) {
             parseStandardAction(parent);
@@ -1505,10 +1515,12 @@
         } else if (reader.matches("<jsp:text")) {
             err.jspError(reader.mark(), "jsp.error.not.in.template",
                     "&lt;jsp:text");
-        } else if (reader.matches("${")) {
+        } else if (!pageInfo.isELIgnored() && reader.matches("${")) {
             err.jspError(reader.mark(), "jsp.error.not.in.template",
                     "Expression language");
-        } else if (reader.matches("#{")) {
+        } else if (!pageInfo.isELIgnored()
+                && !pageInfo.isDeferredSyntaxAllowedAsLiteral()
+                && reader.matches("#{")) {
             err.jspError(reader.mark(), "jsp.error.not.in.template",
                     "Expression language");
         } else if (reader.matches("<jsp:")) {
--- java/org/apache/tomcat/util/res/StringManager.java.orig	2014-07-17 13:14:13.805539000 -0400
+++ java/org/apache/tomcat/util/res/StringManager.java	2014-07-17 17:50:17.177412000 -0400
@@ -18,8 +18,11 @@
 package org.apache.tomcat.util.res;
 
 import java.text.MessageFormat;
+import java.util.Enumeration;
 import java.util.Hashtable;
+import java.util.LinkedHashMap;
 import java.util.Locale;
+import java.util.Map;
 import java.util.MissingResourceException;
 import java.util.ResourceBundle;
 
@@ -42,7 +45,7 @@
  * <p>Please see the documentation for java.util.ResourceBundle for
  * more information.
  *
- * @version $Revision: 769384 $ $Date: 2009-04-28 15:14:14 +0200 (Tue, 28 Apr 2009) $
+ * @version $Id: StringManager.java 1556539 2014-01-08 14:10:38Z markt $
  *
  * @author James Duncan Davidson [duncan@eng.sun.com]
  * @author James Todd [gonzo@eng.sun.com]
@@ -52,12 +55,16 @@
 
 public class StringManager {
 
+    // Locale.ROOT isn't available until Java 6
+    private static final Locale LOCALE_ROOT = new Locale("", "", "");
+    
+    private static int LOCALE_CACHE_SIZE = 10;
+    
     /**
      * The ResourceBundle for this StringManager.
      */
-
-    private ResourceBundle bundle;
-    private Locale locale;
+    private final ResourceBundle bundle;
+    private final Locale locale;
 
     /**
      * Creates a new StringManager for a given package. This is a
@@ -67,22 +74,36 @@
      *
      * @param packageName Name of package to create StringManager for.
      */
-
-    private StringManager(String packageName) {
-	this( packageName, Locale.getDefault() );
-    }
-
-    private StringManager(String packageName, Locale loc) {
+    private StringManager(String packageName, Locale locale) {
         String bundleName = packageName + ".LocalStrings";
-        bundle = ResourceBundle.getBundle(bundleName, loc);
+        ResourceBundle bnd = null;
+        try {
+            bnd = ResourceBundle.getBundle(bundleName, locale);
+        } catch( MissingResourceException ex ) {
+            // Try from the current loader (that's the case for trusted apps)
+            // Should only be required if using a TC5 style classloader structure
+            // where common != shared != server
+            ClassLoader cl = Thread.currentThread().getContextClassLoader();
+            if( cl != null ) {
+                try {
+                    bnd = ResourceBundle.getBundle(bundleName, locale, cl);
+                } catch(MissingResourceException ex2) {
+                    // Ignore
+                }
+            }
+        }      
+        bundle = bnd;
         // Get the actual locale, which may be different from the requested one
-        locale = bundle.getLocale();
-    }
-
-    private StringManager(ResourceBundle bundle )
-    {
-	this.bundle=bundle;
-        locale = bundle.getLocale();
+        if (bundle != null) {
+            Locale bundleLocale = bundle.getLocale();
+            if (bundleLocale.equals(LOCALE_ROOT)) {
+                this.locale = Locale.ENGLISH;
+            } else {
+                this.locale = bundleLocale;
+            }
+        } else {
+            this.locale = null;
+        }
     }
 
     /**
@@ -94,7 +115,6 @@
                 bundle or null if not found.
         @throws IllegalArgumentException if <i>key</i> is null.        
      */
-
     public String getString(String key) {
         if(key == null){
             String msg = "key may not have a null value";
@@ -104,11 +124,15 @@
 
         String str = null;
 
-        try{
-	        str = bundle.getString(key);
-        }catch(MissingResourceException mre){
+        try {
+            // Avoid NPE if bundle is null and treat it like an MRE
+            if (bundle != null) {
+                str = bundle.getString(key);
+            }
+        } catch (MissingResourceException mre) {
             //bad: shouldn't mask an exception the following way:
-            //   str = "[cannot find message associated with key '" + key + "' due to " + mre + "]";
+            //   str = "[cannot find message associated with key '" + key +
+            //         "' due to " + mre + "]";
 	        //     because it hides the fact that the String was missing
 	        //     from the calling code.
 	        //good: could just throw the exception (or wrap it in another)
@@ -130,7 +154,6 @@
      * @param key
      * @param args
      */
-
     public String getString(final String key, final Object... args) {
         String value = getString(key);
         if (value == null) {
@@ -142,11 +165,19 @@
         return mf.format(args, new StringBuffer(), null).toString();
     }
 
+    /**
+     * Identify the Locale this StringManager is associated with
+     */
+    public Locale getLocale() {
+        return locale;
+    }
+
     // --------------------------------------------------------------
     // STATIC SUPPORT METHODS
     // --------------------------------------------------------------
 
-    private static Hashtable managers = new Hashtable();
+    private static final Map<String,Map<Locale,StringManager>> managers =
+            new Hashtable<String,Map<Locale,StringManager>>();
 
     /**
      * Get the StringManager for a particular package. If a manager for
@@ -155,42 +186,87 @@
      *
      * @param packageName The package name
      */
-    public synchronized static StringManager getManager(String packageName) {
-      StringManager mgr = (StringManager)managers.get(packageName);
-      if (mgr == null) {
-          mgr = new StringManager(packageName);
-          managers.put(packageName, mgr);
-      }
-      return mgr;
+    public static final synchronized StringManager getManager(
+            String packageName) {
+        return getManager(packageName, Locale.getDefault());
+    }
+    
+    /**
+     * Get the StringManager for a particular package and Locale. If a manager
+     * for a package/Locale combination already exists, it will be reused, else
+     * a new StringManager will be created and returned.
+     *
+     * @param packageName The package name
+     * @param locale      The Locale
+     */
+    public static final synchronized StringManager getManager(
+            String packageName, Locale locale) {
+
+        Map<Locale,StringManager> map = managers.get(packageName);
+        if (map == null) {
+            /*
+             * Don't want the HashMap to be expanded beyond LOCALE_CACHE_SIZE.
+             * Expansion occurs when size() exceeds capacity. Therefore keep
+             * size at or below capacity.
+             * removeEldestEntry() executes after insertion therefore the test
+             * for removal needs to use one less than the maximum desired size
+             *
+             */
+            map = new LinkedHashMap<Locale,StringManager>(LOCALE_CACHE_SIZE, 1, true) {
+                private static final long serialVersionUID = 1L;
+                @Override
+                protected boolean removeEldestEntry(
+                        Map.Entry<Locale,StringManager> eldest) {
+                    if (size() > (LOCALE_CACHE_SIZE - 1)) {
+                        return true;
+                    }
+                    return false;
+                }
+            };
+            managers.put(packageName, map);
+        }
+
+        StringManager mgr = map.get(locale);
+        if (mgr == null) {
+            mgr = new StringManager(packageName, locale);
+            map.put(locale, mgr);
+        }
+        return mgr;
     }
 
     /**
-     * Get the StringManager for a particular package. If a manager for
-     * a package already exists, it will be reused, else a new
-     * StringManager will be created and returned.
+     * Retrieve the StringManager for a list of Locales. The first StringManager
+     * found will be returned.
      *
-     * @param bundle The resource bundle
+     * @param requestedLocales the list of Locales
+     *
+     * @return the found StringManager or the default StringManager
      */
-    public synchronized static StringManager getManager(ResourceBundle bundle) {
-      return new StringManager( bundle );
+    public static StringManager getManager(String packageName,
+            Enumeration<Locale> requestedLocales) {
+        while (requestedLocales.hasMoreElements()) {
+            Locale locale = requestedLocales.nextElement();
+            StringManager result = getManager(packageName, locale);
+            if (result.getLocale().equals(locale)) {
+                return result;
+            }
+        }
+        // Return the default
+        return getManager(packageName);
     }
-
+    
     /**
-     * Get the StringManager for a particular package and Locale. If a manager for
-     * a package already exists, it will be reused, else a new
-     * StringManager will be created for that Locale and returned.
+     * Always returns null.
      *
-     * @param packageName The package name
-     * @param loc The locale
-     */
-
-   public synchronized static StringManager getManager(String packageName,Locale loc) {
-      StringManager mgr = (StringManager)managers.get(packageName+"_"+loc.toString());
-      if (mgr == null) {
-          mgr = new StringManager(packageName,loc);
-          managers.put(packageName+"_"+loc.toString(), mgr);
-      }
-      return mgr;
+     * @param bundle The resource bundle
+     * 
+     * @return Always <code>null</code>
+     * 
+     * @deprecated  This is unused in Tomcat 6 and will be removed in Tomcat 7
+     */
+    @Deprecated
+    public static final synchronized StringManager getManager(
+            ResourceBundle bundle) {
+        return null;
     }
-
 }
--- java/org/apache/tomcat/util/descriptor/DigesterFactory.java.orig	2014-07-15 17:58:59.822267000 -0400
+++ java/org/apache/tomcat/util/descriptor/DigesterFactory.java	2014-09-16 17:49:11.440617000 -0400
@@ -0,0 +1,157 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one or more
+ * contributor license agreements.  See the NOTICE file distributed with
+ * this work for additional information regarding copyright ownership.
+ * The ASF licenses this file to You under the Apache License, Version 2.0
+ * (the "License"); you may not use this file except in compliance with
+ * the License.  You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.apache.tomcat.util.descriptor;
+
+import java.net.URL;
+import java.util.Collections;
+import java.util.HashMap;
+import java.util.Map;
+
+import javax.servlet.ServletContext;
+
+import org.apache.juli.logging.Log;
+import org.apache.juli.logging.LogFactory;
+import org.apache.tomcat.util.digester.Digester;
+import org.apache.tomcat.util.digester.RuleSet;
+import org.apache.tomcat.util.res.StringManager;
+import org.xml.sax.ext.EntityResolver2;
+
+/**
+ * Wrapper class around the Digester that hide Digester's initialization
+ * details.
+ */
+public class DigesterFactory {
+
+    private static final Log log = LogFactory.getLog(DigesterFactory.class);
+    private static final StringManager sm =
+            StringManager.getManager(Constants.PACKAGE_NAME);
+
+    private static final Class<ServletContext> CLASS_SERVLET_CONTEXT;
+    private static final Class<?> CLASS_JSP_CONTEXT;
+
+    static {
+        CLASS_SERVLET_CONTEXT = ServletContext.class;
+        Class<?> jspContext = null;
+        try {
+            jspContext = Class.forName("javax.servlet.jsp.JspContext");
+        } catch (ClassNotFoundException e) {
+            // Ignore - JSP API is not present.
+        }
+        CLASS_JSP_CONTEXT = jspContext;
+    }
+
+
+    /**
+     * Mapping of well-known public IDs used by the Servlet API to the matching
+     * local resource.
+     */
+    public static final Map<String,String> SERVLET_API_PUBLIC_IDS;
+
+    /**
+     * Mapping of well-known system IDs used by the Servlet API to the matching
+     * local resource.
+     */
+    public static final Map<String,String> SERVLET_API_SYSTEM_IDS;
+
+    static {
+        Map<String, String> publicIds = new HashMap<String, String>();
+        Map<String, String> systemIds = new HashMap<String, String>();
+
+        // W3C
+        add(publicIds, XmlIdentifiers.XSD_10_PUBLIC, locationFor("XMLSchema.dtd"));
+        add(publicIds, XmlIdentifiers.DATATYPES_PUBLIC, locationFor("datatypes.dtd"));
+        add(systemIds, XmlIdentifiers.XML_2001_XSD, locationFor("xml.xsd"));
+
+        // from J2EE 1.2
+        add(publicIds, XmlIdentifiers.WEB_22_PUBLIC, locationFor("web-app_2_2.dtd"));
+        add(publicIds, XmlIdentifiers.TLD_11_PUBLIC, locationFor("web-jsptaglibrary_1_1.dtd"));
+
+        // from J2EE 1.3
+        add(publicIds, XmlIdentifiers.WEB_23_PUBLIC, locationFor("web-app_2_3.dtd"));
+        add(publicIds, XmlIdentifiers.TLD_12_PUBLIC, locationFor("web-jsptaglibrary_1_2.dtd"));
+
+        // from J2EE 1.4
+        add(systemIds, "http://www.ibm.com/webservices/xsd/j2ee_web_services_1_1.xsd",
+       locationFor("j2ee_web_services_1_1.xsd"));
+        add(systemIds, "http://www.ibm.com/webservices/xsd/j2ee_web_services_client_1_1.xsd",
+        locationFor("j2ee_web_services_client_1_1.xsd"));
+        add(systemIds, XmlIdentifiers.WEB_24_XSD, locationFor("web-app_2_4.xsd"));
+        add(systemIds, XmlIdentifiers.TLD_20_XSD, locationFor("web-jsptaglibrary_2_0.xsd"));
+        addSelf(systemIds, "j2ee_1_4.xsd");
+        addSelf(systemIds, "jsp_2_0.xsd");
+
+        // from JavaEE 5
+        add(systemIds, XmlIdentifiers.WEB_25_XSD, locationFor("web-app_2_5.xsd"));
+        add(systemIds, XmlIdentifiers.TLD_21_XSD, locationFor("web-jsptaglibrary_2_1.xsd"));
+        addSelf(systemIds, "jsp_2_1.xsd");
+
+        SERVLET_API_PUBLIC_IDS = Collections.unmodifiableMap(publicIds);
+        SERVLET_API_SYSTEM_IDS = Collections.unmodifiableMap(systemIds);
+    }
+
+    private static void addSelf(Map<String, String> ids, String id) {
+        String location = locationFor(id);
+        if (location != null) {
+            ids.put(id, location);
+            ids.put(location, location);
+        }
+    }
+
+    private static void add(Map<String,String> ids, String id, String location) {
+        if (location != null) {
+            ids.put(id, location);
+        }
+    }
+
+    private static String locationFor(String name) {
+        URL location = CLASS_SERVLET_CONTEXT.getResource("resources/" + name);
+        if (location == null && CLASS_JSP_CONTEXT != null) {
+            location = CLASS_JSP_CONTEXT.getResource("resources/" + name);
+        }
+        if (location == null) {
+            log.info(sm.getString("digesterFactory.missingSchema", name));
+            return null;
+        }
+        return location.toExternalForm();
+    }
+
+
+    /**
+     * Create a <code>Digester</code> parser.
+     * @param xmlValidation turn on/off xml validation
+     * @param xmlNamespaceAware turn on/off namespace validation
+     * @param rule an instance of <code>RuleSet</code> used for parsing the xml.
+     * @param blockExternal turn on/off the blocking of external resources
+     */
+    public static Digester newDigester(boolean xmlValidation,
+                                       boolean xmlNamespaceAware,
+                                       RuleSet rule,
+                                       boolean blockExternal) {
+        Digester digester = new Digester();
+        digester.setNamespaceAware(xmlNamespaceAware);
+        digester.setValidating(xmlValidation);
+        digester.setUseContextClassLoader(true);
+        EntityResolver2 resolver = new LocalResolver(SERVLET_API_PUBLIC_IDS,
+                SERVLET_API_SYSTEM_IDS, blockExternal);
+        digester.setEntityResolver(resolver);
+        if (rule != null) {
+            digester.addRuleSet(rule);
+        }
+
+        return digester;
+    }
+}
--- java/org/apache/tomcat/util/descriptor/LocalResolver.java.orig	2014-07-15 18:09:20.937361000 -0400
+++ java/org/apache/tomcat/util/descriptor/LocalResolver.java	2014-07-17 17:50:17.190406000 -0400
@@ -0,0 +1,143 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one or more
+ * contributor license agreements.  See the NOTICE file distributed with
+ * this work for additional information regarding copyright ownership.
+ * The ASF licenses this file to You under the Apache License, Version 2.0
+ * (the "License"); you may not use this file except in compliance with
+ * the License.  You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.apache.tomcat.util.descriptor;
+
+import java.io.FileNotFoundException;
+import java.io.IOException;
+import java.net.MalformedURLException;
+import java.net.URI;
+import java.net.URISyntaxException;
+import java.net.URL;
+import java.util.Map;
+
+import org.apache.tomcat.util.res.StringManager;
+import org.xml.sax.InputSource;
+import org.xml.sax.SAXException;
+import org.xml.sax.ext.EntityResolver2;
+
+/**
+ * A resolver for locally cached XML resources.
+ */
+public class LocalResolver implements EntityResolver2 {
+
+    private static final StringManager sm =
+            StringManager.getManager(Constants.PACKAGE_NAME);
+
+    private final Map<String,String> publicIds;
+    private final Map<String,String> systemIds;
+    private final boolean blockExternal;
+
+    /**
+     * Constructor providing mappings of public and system identifiers to local
+     * resources. Each map contains a mapping from a well-known identifier to a
+     * URL for a local resource path.
+     *
+     * @param publicIds mapping of well-known public identifiers to local
+     *                  resources
+     * @param systemIds mapping of well-known system identifiers to local
+     *                  resources
+     * @param blockExternal are external resources blocked that are not
+     *                      well-known
+     */
+    public LocalResolver(Map<String,String> publicIds,
+            Map<String,String> systemIds, boolean blockExternal) {
+        this.publicIds = publicIds;
+        this.systemIds = systemIds;
+        this.blockExternal = blockExternal;
+    }
+
+
+    public InputSource resolveEntity(String publicId, String systemId)
+            throws SAXException, IOException {
+        return resolveEntity(null, publicId, null, systemId);
+    }
+
+
+    public InputSource resolveEntity(String name, String publicId,
+            String base, String systemId) throws SAXException, IOException {
+
+        // First try resolving using the publicId
+        String resolved = publicIds.get(publicId);
+        if (resolved != null) {
+            InputSource is = new InputSource(resolved);
+            is.setPublicId(publicId);
+            return is;
+        }
+
+        // If there is no systemId, can't try anything else
+        if (systemId == null) {
+            throw new FileNotFoundException(sm.getString("localResolver.unresolvedEntity",
+                    name, publicId, systemId, base));
+        }
+
+        // Try resolving with the supplied systemId
+        resolved = systemIds.get(systemId);
+        if (resolved != null) {
+            InputSource is = new InputSource(resolved);
+            is.setPublicId(publicId);
+            return is;
+        }
+
+        // Resolve the supplied systemId against the base
+        URI systemUri;
+        try {
+            if (base == null) {
+                systemUri = new URI(systemId);
+            } else {
+                // Can't use URI.resolve() because "jar:..." URLs are not valid
+                // hierarchical URIs so resolve() does not work. new URL()
+                // delegates to the jar: stream handler and it manages to figure
+                // it out.
+                URI baseUri = new URI(base);
+                systemUri = new URL(baseUri.toURL(), systemId).toURI();
+            }
+            systemUri = systemUri.normalize();
+        } catch (URISyntaxException e) {
+            // May be caused by a | being used instead of a : in an absolute
+            // file URI on Windows.
+            if (blockExternal) {
+                // Absolute paths aren't allowed so block it
+                throw new MalformedURLException(e.getMessage());
+            } else {
+                // See if the URLHandler can resolve it
+                return new InputSource(systemId);
+            }
+        }
+        if (systemUri.isAbsolute()) {
+            // Try the resolved systemId
+            resolved = systemIds.get(systemUri.toString());
+            if (resolved != null) {
+                InputSource is = new InputSource(resolved);
+                is.setPublicId(publicId);
+                return is;
+            }
+            if (!blockExternal) {
+                InputSource is = new InputSource(systemUri.toString());
+                is.setPublicId(publicId);
+                return is;
+            }
+        }
+        throw new FileNotFoundException(sm.getString("localResolver.unresolvedEntity",
+                name, publicId, systemId, base));
+    }
+
+
+    public InputSource getExternalSubset(String name, String baseURI)
+            throws SAXException, IOException {
+        return null;
+    }
+}
--- java/org/apache/tomcat/util/descriptor/LocalStrings.properties.orig	2014-07-15 18:10:54.270681000 -0400
+++ java/org/apache/tomcat/util/descriptor/LocalStrings.properties	2014-09-16 18:18:11.596501000 -0400
@@ -0,0 +1,20 @@
+# Licensed to the Apache Software Foundation (ASF) under one or more
+# contributor license agreements.  See the NOTICE file distributed with
+# this work for additional information regarding copyright ownership.
+# The ASF licenses this file to You under the Apache License, Version 2.0
+# (the "License"); you may not use this file except in compliance with
+# the License.  You may obtain a copy of the License at
+#
+#     http://www.apache.org/licenses/LICENSE-2.0
+#
+# Unless required by applicable law or agreed to in writing, software
+# distributed under the License is distributed on an "AS IS" BASIS,
+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+# See the License for the specific language governing permissions and
+# limitations under the License.
+
+localResolver.unresolvedEntity=Could not resolve XML resource [{0}] with public ID [{1}], system ID [{2}] and base URI [{3}] to a known, local entity.
+digesterFactory.missingSchema=The XML schema [{0}] isn't present. This could be due to the version of Java Tomcat used. Problems with xml validation might exist if turned on. 
+
+xmlErrorHandler.error=Non-fatal error [{0}] reported processing [{1}].
+xmlErrorHandler.warning=Warning [{0}] reported processing [{1}].
--- java/org/apache/tomcat/util/descriptor/Constants.java.orig	2014-07-15 17:58:44.910216000 -0400
+++ java/org/apache/tomcat/util/descriptor/Constants.java	2014-07-17 17:50:17.201412000 -0400
@@ -0,0 +1,24 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one or more
+ * contributor license agreements.  See the NOTICE file distributed with
+ * this work for additional information regarding copyright ownership.
+ * The ASF licenses this file to You under the Apache License, Version 2.0
+ * (the "License"); you may not use this file except in compliance with
+ * the License.  You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.apache.tomcat.util.descriptor;
+
+public class Constants {
+
+    public static final String PACKAGE_NAME =
+            Constants.class.getPackage().getName();
+
+}
--- java/org/apache/tomcat/util/descriptor/XmlErrorHandler.java.orig	2014-07-15 17:59:31.305376000 -0400
+++ java/org/apache/tomcat/util/descriptor/XmlErrorHandler.java	2014-07-17 17:50:17.206406000 -0400
@@ -0,0 +1,72 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one or more
+ * contributor license agreements.  See the NOTICE file distributed with
+ * this work for additional information regarding copyright ownership.
+ * The ASF licenses this file to You under the Apache License, Version 2.0
+ * (the "License"); you may not use this file except in compliance with
+ * the License.  You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.apache.tomcat.util.descriptor;
+
+import java.util.ArrayList;
+import java.util.List;
+
+import org.apache.juli.logging.Log;
+import org.apache.tomcat.util.res.StringManager;
+import org.xml.sax.ErrorHandler;
+import org.xml.sax.SAXException;
+import org.xml.sax.SAXParseException;
+
+public class XmlErrorHandler implements ErrorHandler {
+
+    private static final StringManager sm =
+        StringManager.getManager(Constants.PACKAGE_NAME);
+
+    private final List<SAXParseException> errors = new ArrayList<SAXParseException>();
+
+    private final List<SAXParseException> warnings = new ArrayList<SAXParseException>();
+
+    public void error(SAXParseException exception) throws SAXException {
+        // Collect non-fatal errors
+        errors.add(exception);
+    }
+
+    public void fatalError(SAXParseException exception) throws SAXException {
+        // Re-throw fatal errors
+        throw exception;
+    }
+
+    public void warning(SAXParseException exception) throws SAXException {
+        // Collect warnings
+        warnings.add(exception);
+    }
+
+    public List<SAXParseException> getErrors() {
+        // Internal use only - don't worry about immutability
+        return errors;
+    }
+
+    public List<SAXParseException> getWarnings() {
+        // Internal use only - don't worry about immutability
+        return warnings;
+    }
+
+    public void logFindings(Log log, String source) {
+        for (SAXParseException e : getWarnings()) {
+            log.warn(sm.getString(
+                    "xmlErrorHandler.warning", e.getMessage(), source));
+        }
+        for (SAXParseException e : getErrors()) {
+            log.warn(sm.getString(
+                    "xmlErrorHandler.error", e.getMessage(), source));
+        }
+    }
+}
--- java/org/apache/tomcat/util/descriptor/XmlIdentifiers.java.orig	2014-07-15 17:59:46.866436000 -0400
+++ java/org/apache/tomcat/util/descriptor/XmlIdentifiers.java	2014-07-17 17:50:17.211403000 -0400
@@ -0,0 +1,69 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one or more
+ * contributor license agreements.  See the NOTICE file distributed with
+ * this work for additional information regarding copyright ownership.
+ * The ASF licenses this file to You under the Apache License, Version 2.0
+ * (the "License"); you may not use this file except in compliance with
+ * the License.  You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.apache.tomcat.util.descriptor;
+
+/**
+ * Defines constants for well-known Public and System identifiers documented by
+ * the Servlet and JSP specifications.
+ */
+public final class XmlIdentifiers {
+
+    // from W3C
+    public static final String XML_2001_XSD = "http://www.w3.org/2001/xml.xsd";
+    public static final String DATATYPES_PUBLIC = "datatypes";
+    public static final String XSD_10_PUBLIC =
+            "-//W3C//DTD XMLSCHEMA 200102//EN";
+
+    // from J2EE 1.2
+    public static final String WEB_22_PUBLIC =
+            "-//Sun Microsystems, Inc.//DTD Web Application 2.2//EN";
+    public static final String WEB_22_SYSTEM =
+            "http://java.sun.com/dtd/web-app_2_2.dtd";
+    public static final String TLD_11_PUBLIC =
+            "-//Sun Microsystems, Inc.//DTD JSP Tag Library 1.1//EN";
+    public static final String TLD_11_SYSTEM =
+            "http://java.sun.com/dtd/web-jsptaglibrary_1_1.dtd";
+
+    // from J2EE 1.3
+    public static final String WEB_23_PUBLIC =
+            "-//Sun Microsystems, Inc.//DTD Web Application 2.3//EN";
+    public static final String WEB_23_SYSTEM =
+            "http://java.sun.com/dtd/web-app_2_3.dtd";
+    public static final String TLD_12_PUBLIC =
+            "-//Sun Microsystems, Inc.//DTD JSP Tag Library 1.2//EN";
+    public static final String TLD_12_SYSTEM =
+            "http://java.sun.com/dtd/web-jsptaglibrary_1_2.dtd";
+
+    // from J2EE 1.4
+    public static final String WEB_24_XSD =
+            "http://java.sun.com/xml/ns/j2ee/web-app_2_4.xsd";
+    public static final String TLD_20_XSD =
+            "http://java.sun.com/xml/ns/j2ee/web-jsptaglibrary_2_0.xsd";
+    public static final String WEBSERVICES_11_XSD =
+            "http://www.ibm.com/webservices/xsd/j2ee_web_services_1_1.xsd";
+
+    // from JavaEE 5
+    public static final String WEB_25_XSD =
+            "http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd";
+    public static final String TLD_21_XSD =
+            "http://java.sun.com/xml/ns/javaee/web-jsptaglibrary_2_1.xsd";
+    public static final String WEBSERVICES_12_XSD =
+            "http://java.sun.com/xml/ns/javaee/javaee_web_services_1_2.xsd";
+
+    private XmlIdentifiers() {
+    }
+}
\ No newline at end of file
--- java/org/apache/tomcat/util/descriptor/LocalStrings_es.properties.orig	2014-07-15 18:13:16.739201000 -0400
+++ java/org/apache/tomcat/util/descriptor/LocalStrings_es.properties	2014-07-17 17:50:17.215406000 -0400
@@ -0,0 +1,17 @@
+# Licensed to the Apache Software Foundation (ASF) under one or more
+# contributor license agreements.  See the NOTICE file distributed with
+# this work for additional information regarding copyright ownership.
+# The ASF licenses this file to You under the Apache License, Version 2.0
+# (the "License"); you may not use this file except in compliance with
+# the License.  You may obtain a copy of the License at
+#
+#     http://www.apache.org/licenses/LICENSE-2.0
+#
+# Unless required by applicable law or agreed to in writing, software
+# distributed under the License is distributed on an "AS IS" BASIS,
+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+# See the License for the specific language governing permissions and
+# limitations under the License.
+
+xmlErrorHandler.error = Error no fatal [{0}] reportado por el proceso [{1}].
+xmlErrorHandler.warning = Aviso [{0}] reportado por el proceso [{1}].

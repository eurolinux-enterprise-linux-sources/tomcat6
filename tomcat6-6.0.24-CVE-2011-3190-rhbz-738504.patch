--- java/org/apache/coyote/ajp/AjpAprProcessor.java.orig	2011-09-26 14:47:17.731765781 -0600
+++ java/org/apache/coyote/ajp/AjpAprProcessor.java	2011-09-26 14:53:19.214741063 -0600
@@ -390,11 +390,13 @@
                     }
                     continue;
                 } else if(type != Constants.JK_AJP13_FORWARD_REQUEST) {
-                    // Usually the servlet didn't read the previous request body
+                    // Unexpected packet type. Unread body packets
+						  // should have been swallowed in finish().
                     if(log.isDebugEnabled()) {
                         log.debug("Unexpected message: "+type);
                     }
-                    continue;
+						  error = true;
+						  break;
                 }
 
                 keptAlive = true;
@@ -1026,6 +1028,11 @@
 
         finished = true;
 
+		  // Swallow the unread packet if present
+		  if (first && request.getContentLengthLong() > 0) {
+			  receive();
+		  }
+
         // Add the end message
         if (outputBuffer.position() + endMessageArray.length > outputBuffer.capacity()) {
             flush();
--- java/org/apache/coyote/ajp/AjpProcessor.java.orig	2011-09-26 14:47:40.449764227 -0600
+++ java/org/apache/coyote/ajp/AjpProcessor.java	2011-09-26 14:57:06.603725513 -0600
@@ -408,11 +408,13 @@
                     }
                     continue;
                 } else if(type != Constants.JK_AJP13_FORWARD_REQUEST) {
-                    // Usually the servlet didn't read the previous request body
+                    // Unexpected packet type. Unread body packets should
+						  // have been swallowed in finish().
                     if(log.isDebugEnabled()) {
                         log.debug("Unexpected message: "+type);
                     }
-                    continue;
+						  error = true;
+						  break;
                 }
 
                 request.setStartTime(System.currentTimeMillis());
@@ -1031,6 +1033,11 @@
 
         finished = true;
 
+		  // Swallow the unread body packet if present
+		  if(first && request.getContentLengthLong() > 0) {
+			  receive();
+		  }
+
         // Add the end message
         output.write(endMessageArray);
 
--- webapps/docs/changelog.xml.orig	2011-09-26 14:48:00.063762886 -0600
+++ webapps/docs/changelog.xml	2011-09-26 15:12:35.949661965 -0600
@@ -34,6 +34,14 @@
 
 <body>
 <section name="Tomcat 6.0.24 (jfclere)">
+  <subsection name="Coyote" >
+  	<changelog>
+	  <fix>
+	    <bug>51698</bug>: Fix CVE-2011-3190 Prevent AJP message injection
+		 (markt>
+		</fix>
+	</changelog>
+  </subsection>
   <subsection name="Catalina">
     <changelog>
       <fix>
